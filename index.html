<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <title>Game Night ‚Ä¢ v45-2026-02-12</title>
  <!-- BUILD: v47_20260212T220500Z -->

  <!-- Firebase scripts -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC0sdB54z0G73P3epW6GmHqgYvESFcqgTo",
      authDomain: "gamenightdarts-e7601.firebaseapp.com",
      projectId: "gamenightdarts-e7601",
      storageBucket: "gamenightdarts-e7601.appspot.com",
      messagingSenderId: "270045452251",
      appId: "1:270045452251:web:5a4a661140a60780e939fe",
      measurementId: "G-M60TDFYBW0"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
  </script>

  <style>
    :root{
      /* DARK BACKGROUND */
      --bg:#060814;
      --bg-soft:#0b1020;

      /* TEXT (READABLE) */
      --text:#eef4ff;
      --muted:#9fb0d0;

      /* MULTI-COLOR ACCENTS */
      --c-cyan:#22d3ee;
      --c-purple:#3b82f6;
      --c-blue:#3b82f6;
      --c-pink:#ec4899;
      --c-green:#22c55e;
      --c-orange:#f97316;
      --c-red:#ef4444;
      --accent:var(--c-cyan);

      /* STATUS */
      --danger:var(--c-red);
      --ok:var(--c-green);

      /* GLASS */
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.025);
      --shadow: rgba(0,0,0,.45);

      /* CHROME MATERIAL */
      --chrome-border: rgba(255,255,255,.18);
      --chrome-fill: linear-gradient(180deg,
        rgba(255,255,255,.18) 0%,
        rgba(255,255,255,.07) 14%,
        rgba(0,0,0,.22) 36%,
        rgba(255,255,255,.10) 52%,
        rgba(0,0,0,.34) 72%,
        rgba(255,255,255,.14) 100%
      );
      --title-solid:#22d3ee;
      --title-grad: linear-gradient(90deg,
        #22d3ee 0%,
        #ec4899 45%,
        #f97316 70%,
        #22c55e 100%
      );
      --active-solid:#f97316;
      --active-grad: linear-gradient(90deg,
        #f97316 0%,
        #ec4899 55%,
        #22d3ee 100%
      );

      --chrome-text: linear-gradient(135deg,
        rgba(34,211,238,1) 0%,
        rgba(59,130,246,1) 22%,
        rgba(236,72,153,1) 46%,
        rgba(249,115,22,1) 70%,
        rgba(34,197,94,1) 100%
      );
    }
  </style>
</head>
<body>
  <!-- Your app content goes here -->
</body>
</html>

/* ===== Base ===== */
*{box-sizing:border-box;}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:
    linear-gradient(180deg, #040610, var(--bg));
  color:var(--text);
  padding-bottom:56px; /* room for footer */
}

/* iOS safe-area padding so content doesn't feel "squished" to one side */
body{
  padding-left: max(0px, env(safe-area-inset-left));
  padding-right: max(0px, env(safe-area-inset-right));
}

/* ===== Footer legal ===== */
.footerLegal{
  position:fixed;
  left:0; right:0; bottom:0;
  z-index:20;
  display:flex;
  justify-content:center;
  padding:10px 12px calc(10px + env(safe-area-inset-bottom));
  pointer-events:none;
  background:linear-gradient(180deg, rgba(6,8,20,0), rgba(6,8,20,.65));
}
.footerLegal .txt{
  font-size:10px;
  letter-spacing:.2px;
  color:rgba(159,176,208,.85);
  text-align:center;
  text-shadow:0 2px 10px rgba(0,0,0,.45);
  max-width:980px;
}

/* ===== Topbar ===== */
.topbar{
  position:sticky;top:0;z-index:10;
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  padding-top:calc(10px + env(safe-area-inset-top));
  background:var(--bg);
  backdrop-filter:none;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.topActions{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:96px;
}
.topActions.left{justify-content:flex-start}
.topActions.right{justify-content:flex-end}

.brand{
  grid-column:2;
  display:flex;
  flex-direction:column;
  line-height:1.05;
  align-items:center;
  text-align:center;
  max-width:min(540px, 66vw);
}
.brand .t{font-weight:1000;font-size:20px;letter-spacing:.4px; text-shadow:0 2px 14px rgba(0,0,0,.55), 0 0 18px rgba(34,211,238,.10)}
.brand .s{
  font-size:12px;
  color:var(--muted);
  white-space:normal;
  overflow-wrap:anywhere;
}

.wrap{max-width:980px;margin:0 auto;padding:14px}
.card{
  background:linear-gradient(180deg,var(--glass),var(--glass2));
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:14px;
  position:relative;
  box-shadow:0 16px 34px rgba(0,0,0,.42), 0 8px 60px rgba(0,0,0,.28);
  margin-bottom:12px;
}
.card::before{
  content:"";
  position:absolute;
  left:14px; right:14px; bottom:-12px;
  height:22px;
  border-radius:50%;
  background:rgba(0,0,0,.65);
  filter:blur(16px);
  opacity:.42;
  pointer-events:none;
}

.h1{font-size:26px;font-weight:1000;letter-spacing:.4px;margin:2px 0 6px;text-shadow:0 2px 14px rgba(0,0,0,.55)}
.sub{color:var(--muted);font-size:13px}
label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}

input,select{
  width:100%;
  background:rgba(7,10,20,.72);
  border:1px solid rgba(255,255,255,.14);
  color:var(--text);
  border-radius:14px;padding:12px 12px;font-size:16px;outline:none;
}

.row{display:flex;gap:10px;flex-wrap:wrap;}
.row>*{flex:1;min-width:140px}
@media(max-width:420px){
  .row > *{ min-width:120px; }
}
.stack{display:flex;flex-direction:column;gap:10px}

.toast{
  background:rgba(239,68,68,.12);
  border:1px solid rgba(239,68,68,.30);
  color:#ffd6da;
  border-radius:14px;padding:10px 12px;font-weight:900;margin-bottom:12px;
}

.divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}

/* ===== Tables (Round table / rosters) ===== */
.small{font-size:12px;color:var(--muted);}
.tableWrap{
  overflow:auto;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  width:100%;
  max-width:100%;
  -webkit-overflow-scrolling:touch;
}
.tableWrap table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
}
.tableWrap th,
.tableWrap td{
  padding:10px 10px;
  text-align:center;
  vertical-align:middle;
  font-size:14px;
  overflow:hidden;
  text-overflow:ellipsis;
}
.tableWrap th:first-child,
.tableWrap td:first-child{
  text-align:left;
  width:96px;
}
.tableWrap thead th{
  position:sticky;
  top:0;
  z-index:2;
  background:rgba(7,10,20,.82);
  backdrop-filter:blur(10px);
}
.tableWrap tbody tr:nth-child(odd) td{
  background:rgba(255,255,255,.02);
}
.tableWrap td.activeCell{
  outline:2px solid rgba(34,211,238,.22);
  background:rgba(34,211,238,.06);
  border-radius:10px;
}

/* ===== Chrome UI (buttons/badges) ===== */
.btn{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
  border-radius:14px;padding:10px 12px;font-weight:900;
  box-shadow:0 6px 16px var(--shadow);
  cursor:pointer;
  position:relative;
}
.btn:active{transform:translateY(1px)}
.btn.ghost{background:transparent;box-shadow:none;color:var(--muted)}
.btn.ok{
  background:linear-gradient(135deg, rgba(34,197,94,.22), rgba(34,211,238,.12)) !important;
  border-color:rgba(34,197,94,.40) !important;

  /* Strong full-button glow (not just edges) */
  box-shadow:
    0 10px 22px rgba(0,0,0,.32),
    0 0 34px rgba(34,197,94,.55),
    0 0 70px rgba(34,197,94,.28),
    inset 0 0 26px rgba(34,197,94,.22),
    inset 0 1px 0 rgba(255,255,255,.20),
    inset 0 -12px 18px rgba(0,0,0,.38);
}
.btn.danger{
  background:linear-gradient(135deg, rgba(239,68,68,.22), rgba(249,115,22,.12)) !important;
  border-color:rgba(239,68,68,.42) !important;
}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none}

/* ‚ÄúChrome‚Äù surface + highlight for primary clickable UI */
.btn:not(.ghost):not(.ok):not(.danger),
.hitBtn,
.kAttackBtn,
.pill,
.badge,
.kbd{background:var(--chrome-fill);
  border:1px solid var(--chrome-border);
  box-shadow:
    0 10px 22px rgba(0,0,0,.32),
    inset 0 1px 0 rgba(255,255,255,.20),
    inset 0 -12px 18px rgba(0,0,0,.38); white-space:nowrap;}
.btn:not(.ghost)::after,
.hitBtn::after,
.kAttackBtn::after,
.pill::after,
.badge::after,
.kbd::after{
  content:"";
  position:absolute;
  left:10px; right:10px; top:7px;
  height:38%;
  border-radius:12px;
  background:linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,0));
  pointer-events:none;
  opacity:.85;
}

#myDouble{font-size:13px;}
@media(max-width:420px){#myDouble{font-size:12px;}}
.pill,.badge,.kbd{ position:relative; }

/* ===== Title text (vivid + readable; no gray/white/black) ===== */
.h1, .kTurnBig, .brand .t, .rosterName, .headerTitle, .gameTitleBig, .turnNameBig, .turnTitle3d{
  color:var(--title-solid);
  text-shadow:
    0 0 18px rgba(34,211,238,.42),
    0 0 26px rgba(236,72,153,.22),
    0 0 34px rgba(249,115,22,.16),
    0 2px 12px rgba(0,0,0,.55);
}

/* Use gradient only when text-clipping is supported (prevents ‚Äúinvisible/gray‚Äù titles). */
@supports ((-webkit-background-clip:text) or (background-clip:text)){
  .h1, .kTurnBig, .brand .t, .rosterName, .headerTitle, .gameTitleBig, .turnNameBig, .turnTitle3d{
    background:var(--title-grad);
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent;
    background-size:260% 260%;
    animation:titleShift 7.5s ease-in-out infinite;
  }
}

/* Active player name (offset color so it pops vs titles) */
.turnPlayerName{
  color:var(--active-solid);
  text-shadow:
    0 0 16px rgba(249,115,22,.45),
    0 0 22px rgba(236,72,153,.18),
    0 2px 12px rgba(0,0,0,.55);
}
@supports ((-webkit-background-clip:text) or (background-clip:text)){
  .turnPlayerName{
    background:var(--active-grad);
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent;
    background-size:240% 240%;
    animation:titleShift 6.5s ease-in-out infinite;
  }
}



/* ===== Animated title gradient (electric, themed) ===== */
@keyframes titleShift{
  0%{ background-position: 0% 50%; filter:saturate(1.15) contrast(1.08); }
  50%{ background-position: 100% 50%; filter:saturate(1.35) contrast(1.15); }
  100%{ background-position: 0% 50%; filter:saturate(1.15) contrast(1.08); }
}

/* ===== Turn titles (3D / granular metallic) ===== */
.turnTitle3d{
  font-weight:1000;
  letter-spacing:.4px;
  background:var(--chrome-text);
  background-size:260% 260%;
  animation:titleShift 7.5s ease-in-out infinite;
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
  text-shadow:
    0 1px 0 rgba(255,255,255,.18),
    0 2px 0 rgba(0,0,0,.22),
    0 6px 18px rgba(0,0,0,.55);
  filter:contrast(1.05) saturate(1.05);
}

/* ===== Bigger game + turn titles ===== */
.gameTitleBig{font-size:34px;font-weight:1000;letter-spacing:.6px;margin:0;white-space:nowrap;background:linear-gradient(180deg,#ffffff 0%,#dfe7ff 20%,#ffffff 42%,#a8b9de 78%,#ffffff 100%);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 1px 0 rgba(255,255,255,.18),0 3px 0 rgba(0,0,0,.25),0 10px 24px rgba(0,0,0,.60);}
.turnNameBig{font-size:38px;font-weight:1000;letter-spacing:.5px;margin:0;background:linear-gradient(180deg,#ffffff 0%,#dfe7ff 22%,#ffffff 44%,#a8b9de 72%,#ffffff 100%);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 1px 0 rgba(255,255,255,.18),0 4px 0 rgba(0,0,0,.26),0 14px 28px rgba(0,0,0,.65);}
@media(max-width:520px){
  .gameTitleBig{ font-size:22px; }
  .turnNameBig{ font-size:28px;   .titleOneLine{ font-size:20px; }
}
}

/* ===== Pills / tags ===== */
.pill{
  display:inline-block;padding:6px 10px;border-radius:999px;
  color:var(--text);font-weight:900;font-size:12px;
}
.pill.soon{background:rgba(255,255,255,.05); color:var(--muted)}
.pill[data-live="1"]{ border-color: rgba(34,211,238,.38); }

.badge{
  display:inline-block;padding:4px 8px;border-radius:999px;
  font-size:12px;font-weight:1000;
  color:var(--text);
}
.kbd{
  display:inline-block;padding:2px 8px;border-radius:999px;
  color:var(--muted); font-weight:900; font-size:12px;
}

/* ===== Hero alignment ===== */
.hero{
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  align-items:center;
  gap:12px;
}
.heroMain{
  grid-column:2;
  text-align:center;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  max-width:min(560px, 70vw);
}
.heroCornerLeft{
  grid-column:1;
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:10px;
  min-width:0;
}
.heroCornerRight{
  grid-column:3;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:10px;
  min-width:0;
  white-space:nowrap;
}
@media(max-width:520px){
  .hero{
    grid-template-columns: auto 1fr auto;
  }
  .heroMain{
    max-width:100%;
  }
}


/* Around the World setup header: keep pills pinned to top corners (prevents overlap) */
.awSetupHero{ position:relative; padding-top:6px; }
.awSetupHero .heroCornerLeft,
.awSetupHero .heroCornerRight{
  position:absolute;
  top:0;
}
.awSetupHero .heroCornerLeft{ left:0; }
.awSetupHero .heroCornerRight{ right:0; }
.awSetupHero .heroMain{
  grid-column:1 / -1;
  max-width:100%;
  margin-top:40px; /* room for the pinned pills */
}
@media(max-width:520px){
  .awSetupHero .heroMain{ margin-top:44px; }
}
/* target label glow */
.targetGlow{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  box-shadow:0 0 18px rgba(34,211,238,.40), 0 0 0 rgba(59,130,246,0);
}

/* ===== Shanghai table header name styling (prevents split) ===== */
.thName{
  display:block;
  font-weight:1000;
  line-height:1.05;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  background:var(--chrome-text);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
  text-shadow:0 2px 12px rgba(0,0,0,.45);
}

/* ===== Logo ===== */
.logoMark{
  width:44px;height:44px;border-radius:14px;
  background:
    radial-gradient(60% 60% at 30% 20%, rgba(34,211,238,.18), rgba(59,130,246,.16)),
    rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.12);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 10px 24px rgba(0,0,0,.25);
  flex:0 0 auto;
}
.logoMark span{font-size:20px}

/* ===== Game cards ===== */
.gameGrid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:860px){ .gameGrid{grid-template-columns:1fr 1fr;} }
.gameCard{
  position:relative;
  overflow:visible;
  z-index:0;
  isolation:isolate;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;padding:14px;
  box-shadow:0 10px 26px rgba(0,0,0,.28);
}
.gameHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
.gameTitle{display:flex;align-items:center;gap:10px}
.gameIcon{
  width:38px;height:38px;border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:
    radial-gradient(60% 60% at 30% 20%, rgba(0,0,0,0), rgba(34,211,238,.10)),
    rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  font-size:18px;
}
.gameMeta{color:var(--muted);font-size:13px;margin-top:4px}
.gameActions{display:flex;gap:10px;margin-top:10px;justify-content:center}
.gameActions .btn{flex:1;min-height:48px}

/* ===== Play screen layout fixes ===== */
.boardBox{
  display:flex;
  justify-content:center;
  align-items:center;
  width:100%;
  padding:6px 0;
}
.boardBox svg{
  display:block;
  margin:0 auto;
  width:min(420px, 92vw) !important;
  max-width:92vw;
  height:auto;
}

/* HIT/MISS/UNDO: centered and thumb-friendly */
.hitRow{
  max-width:560px;
  margin:0 auto;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  justify-items:stretch;
  justify-content:center;
}
.hitBtn{
  min-height:54px;
  font-size:14px;
  padding:14px 10px;
  max-width:none;
  min-width:0;
  border-radius:14px;
  font-weight:1000;
  letter-spacing:.3px;
  text-align:center;
  border:1px solid rgba(255,255,255,.14);
  color:var(--text);
  background:var(--chrome-fill);
  box-shadow:
    0 10px 22px rgba(0,0,0,.32),
    inset 0 1px 0 rgba(255,255,255,.20),
    inset 0 -12px 18px rgba(0,0,0,.38);
  position:relative;;white-space:normal;line-height:1.12;}
.hitBtn::after{
  content:"";
  position:absolute;
  left:10px; right:10px; top:7px;
  height:38%;
  border-radius:12px;
  background:linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,0));
  pointer-events:none;
  opacity:.85;
}
.hitBtn.miss{ border-color: rgba(239,68,68,.38); grid-column:1 / 2; }
/* 3-button layouts (Around the World) should NOT inherit Shanghai grid spanning */
.hitBtn.miss3{ border-color: rgba(239,68,68,.38); }
.hitBtn.undo3{ color:var(--muted); }

.hitBtn.undo{ color:var(--muted); grid-column:2 / 4; }

/* ===== Roster ===== */
.rosterGrid{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:860px){ .rosterGrid{grid-template-columns:1fr 1fr;} }
.rosterCard{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:12px 12px;border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
}
.rosterLeft{display:flex;align-items:center;gap:10px}
.avatar{
  width:34px;height:34px;border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:
    radial-gradient(60% 60% at 30% 20%, rgba(34,197,94,.18), rgba(59,130,246,.10)),
    rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  font-weight:1000;color:var(--c-cyan);
}
.rosterSub{ color:var(--muted); font-size:12px; overflow-wrap:anywhere; }


/* ===== Player strip under dartboard (shows names + active) ===== */
.playerStrip{
  display:flex;
  gap:10px;
  justify-content:center;
  align-items:stretch;
  flex-wrap:wrap;
  padding:4px 0 2px;
}
.playerChip{
  min-width:140px;
  max-width:min(320px, 90vw);
  flex:1;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
  padding:10px 12px;
  text-align:center;
  position:relative;
}
.playerChip .nm{
  font-weight:1000;
  font-size:15px;
  letter-spacing:.2px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.playerChip .sub{
  margin-top:2px;
  font-size:12px;
  color:var(--muted);
  text-shadow:none;
}
.playerChip.active{
  border-color:rgba(34,197,94,.55);
  background:
    linear-gradient(135deg, rgba(34,197,94,.22), rgba(34,211,238,.10)),
    var(--chrome-fill);
  box-shadow:
    0 10px 22px rgba(0,0,0,.32),
    0 0 28px rgba(34,197,94,.22),
    inset 0 0 26px rgba(34,197,94,.14),
    inset 0 1px 0 rgba(255,255,255,.20),
    inset 0 -12px 18px rgba(0,0,0,.38);
  position:relative;
  overflow:visible;
  z-index:0;
}
.playerChip.active::before{
  content:"";
  position:absolute;
  inset:-12px;
  border-radius:inherit;
  pointer-events:none;
  filter: blur(18px);
  background: radial-gradient(120% 140% at 50% 50%, rgba(34,197,94,.55) 0%, rgba(34,197,94,.22) 52%, rgba(34,197,94,0) 78%);
  opacity:.9;
  animation:auraPulseSoft 2.0s ease-in-out infinite;
  z-index:-1;
}
/* ===== Presence (online indicator) ===== */
.avatar.online{
  border-color:rgba(34,197,94,.55);
  box-shadow:0 0 0 rgba(0,0,0,0), 0 0 18px rgba(34,197,94,.28);
  color:#bfffd1;
  position:relative;
}
.avatar.online::after{
  content:"";
  position:absolute;
  right:-2px;
  bottom:-2px;
  width:9px;
  height:9px;
  border-radius:999px;
  background:rgba(34,197,94,.95);
  border:1px solid rgba(6,8,20,.9);
  box-shadow:0 0 10px rgba(34,197,94,.55);
  animation:onlineDotPulse 1.6s ease-in-out infinite;
}
@keyframes onlineDotPulse{
  0%{ transform:scale(1);   filter:brightness(1);   box-shadow:0 0 10px rgba(34,197,94,.45); }
  50%{transform:scale(1.35);filter:brightness(1.25);box-shadow:0 0 18px rgba(34,197,94,.75); }
  100%{transform:scale(1);  filter:brightness(1);   box-shadow:0 0 10px rgba(34,197,94,.45); }
}

/* ===== Killer typography ===== */
.kTurnBig{ font-size:34px; font-weight:1000; letter-spacing:.4px; margin:0; }
.kTurnSub{ font-size:15px; color:var(--muted); margin-top:6px }
.kNumberBig{ font-size:22px; font-weight:1000; }
.kLivesBig{ font-size:18px; font-weight:1000; letter-spacing:2px; display:flex; justify-content:flex-end; gap:6px; align-items:center; }
.kAttackGrid{ display:grid; grid-template-columns:1fr; gap:10px; }
@media(min-width:860px){ .kAttackGrid{grid-template-columns:1fr 1fr;} }
.kAttackBtn{
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  color:var(--text);
  font-weight:1000;
  padding:14px;
  cursor:pointer;
  text-align:left;
  position:relative;
}
.kAttackBtn:disabled{opacity:.45;cursor:not-allowed}
.kAttackBtn::after{ border-radius:14px; }

/* ===== Hearts ===== */
.heart{ color:var(--danger); text-shadow:0 2px 10px rgba(0,0,0,.35); font-size:18px; line-height:1; }
.lifeOut{ color:rgba(159,176,208,.9); font-weight:1000; letter-spacing:.8px; }

/* ===== Glow system (kept as-is, but with final mobile tuning) ===== */
@keyframes auraPulse{ 0%,100%{ opacity:.38; transform:scale(1); } 50%{ opacity:1; transform:scale(1.05); } }
@keyframes auraPulseSoft{ 0%,100%{ opacity:.28; transform:scale(1); } 50%{ opacity:.92; transform:scale(1.035); } }
.btn, .hitBtn, .kAttackBtn, .pill, .gameCard{ position:relative; overflow:visible; z-index:0; }

.btn::before, .hitBtn::before, .kAttackBtn::before, .pill::before, .gameCard::before{
  content:"";
  position:absolute;
  inset:-12px;
  border-radius:inherit;
  pointer-events:none;
  opacity:0;
  filter: blur(18px);
  z-index:-2;
  transform:translateZ(0);
}

/* GREEN = primary action */
.btn.ok::before{
  /* Full-button halo (behind the entire button) */
  inset:-18px;
  background:
    radial-gradient(circle at 50% 50%,
      rgba(34,197,94,.85) 0%,
      rgba(34,197,94,.55) 34%,
      rgba(34,197,94,.28) 60%,
      rgba(34,197,94,0) 80%);
  opacity:.98;
  filter: blur(20px);
  animation: auraPulseSoft 1.9s ease-in-out infinite;
}
/* RED/ORANGE = destructive */
.btn.danger::before{
  background:
    radial-gradient(circle at 50% 50%,
      rgba(239,68,68,.14) 0%,
      rgba(239,68,68,.28) 46%,
      rgba(249,115,22,.58) 72%,
      rgba(239,68,68,0) 92%);
  opacity:.74;
  animation: auraPulseSoft 2.0s ease-in-out infinite;
}
/* LIVE pill */
.pill[data-live="1"]::before{
  inset:-10px;
  background:
    radial-gradient(circle at 50% 50%,
      rgba(34,211,238,.14) 0%,
      rgba(34,211,238,.30) 44%,
      rgba(34,211,238,.78) 70%,
      rgba(34,211,238,0) 92%);
  opacity:.88;
  animation: auraPulse 2.2s ease-in-out infinite;
}
/* HIT buttons + attack buttons */
.hitBtn:not(.undo):not(:disabled)::before{
  inset:-12px;
  background:
    radial-gradient(circle at 50% 50%,
      rgba(34,211,238,.14) 0%,
      rgba(34,211,238,.28) 44%,
      rgba(34,211,238,.62) 68%,
      rgba(236,72,153,.18) 76%,
      rgba(34,211,238,0) 92%);
  opacity:.90;
  animation: auraPulse 2.25s ease-in-out infinite;
}
.kAttackBtn:not(:disabled)::before{
  inset:-12px;
  background:
    radial-gradient(circle at 50% 50%,
      rgba(59,130,246,.12) 0%,
      rgba(59,130,246,.26) 46%,
      rgba(59,130,246,.58) 72%,
      rgba(59,130,246,0) 92%);
  opacity:.86;
  animation: auraPulseSoft 2.25s ease-in-out infinite;
}
/* No glow on UNDO */
.hitBtn.undo::before{ opacity:0 !important; }

/* Game cards halo (DISABLED: removed overlay) */
.gameCard.leaderGlow::before{ display:none !important; opacity:0 !important; }

/* Tiny readability boost */
.sub,.small,.brand .s{ text-shadow:0 2px 10px rgba(0,0,0,.30); }

/* ===== Header overhaul ===== */
.headerStack{
  position:relative;
  display:grid;
  grid-template-rows:auto auto auto auto;
  gap:6px;
  padding:8px 10px 6px;
}
.headerTopRow{
  display:grid;
  grid-template-columns:1fr 1fr;
  align-items:center;
}
.headerTopRow .left{justify-self:start}
.headerTopRow .right{justify-self:end}
.headerTitle{text-align:center;font-size:26px;font-weight:1000;margin:0;letter-spacing:.6px;text-shadow:0 2px 14px rgba(0,0,0,.55), 0 0 18px rgba(34,211,238,.10)}
.headerIcon{
  position:absolute;
  left:14px;
  top:44px;
  width:34px;height:34px;
  display:flex;align-items:center;justify-content:center;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  box-shadow:0 10px 22px rgba(0,0,0,.28);
  pointer-events:none;
}
\.turnNameBox{ position:relative; overflow:hidden; height:56px; display:flex; align-items:center; justify-content:center; width:100%; align-self:stretch; }
.turnNameText{ position:relative; font-size:26px; font-weight:1000; white-space:nowrap; max-width:100%; text-align:center; }
.turnNameText{color:var(--text);text-shadow:0 2px 14px rgba(0,0,0,.60), 0 0 18px rgba(34,211,238,.28);}
.turnNameText.turnTitle3d{background:none !important;-webkit-background-clip:initial !important;background-clip:initial !important;color:var(--text) !important;}
.turnBracket{margin:0 10px;color:var(--c-cyan);text-shadow:0 0 14px rgba(34,211,238,.65),0 2px 10px rgba(0,0,0,.55);font-weight:1000;}

@media(max-width:520px){
  .turnNameText{ font-size:24px; }
}


.turnNameGlow{
  animation:auraPulse 2.4s ease-in-out infinite;
  padding:0;
  border-radius:999px;
  background:transparent;
}

.turnBracket{
  margin:0 8px;
  color:var(--c-cyan);
  text-shadow:0 0 12px rgba(34,211,238,.65);
  font-weight:1000;
}
.turnNameSlide{ position:absolute; left:0; right:0; top:0; display:flex; justify-content:center; }
.turnNameBox{ position:relative; height:56px; }
.turnNameText{ position:relative; font-size:26px; font-weight:1000; white-space:nowrap; max-width:100%; text-align:center; }

/* Target highlight */
@keyframes targetFlash{0%{filter:brightness(1)}50%{filter:brightness(2.2)}100%{filter:brightness(1)}}
.targetNum{
  color:var(--c-cyan);
  font-weight:1000;
  text-shadow:0 2px 12px rgba(0,0,0,.45);
  animation:targetFlash 1.0s ease-in-out infinite;
}
@keyframes targetPulse{
  0%{ transform:translateZ(0); filter:brightness(1); text-shadow:0 0 0 rgba(0,0,0,0); }
  50%{ filter:brightness(1.8); text-shadow:0 0 18px rgba(34,211,238,.65); }
  100%{ filter:brightness(1); text-shadow:0 0 0 rgba(0,0,0,0); }
}
.targetFlash{
  font-weight:1000;
  color:var(--c-cyan);
  animation:targetPulse 1.1s ease-in-out infinite;
}


/* Dartboard active target highlight */
.hotWedge{ opacity:1; }
/* ===== Win animation overlay ===== */
.winOverlay{
  position:fixed;
  inset:0;
  z-index:9999;
  pointer-events:none;
  display:flex;
  align-items:center;
  justify-content:center;
  background:radial-gradient(900px 520px at 50% 40%, rgba(34,211,238,.12), rgba(6,8,20,.72) 62%, rgba(6,8,20,.88));
  backdrop-filter: blur(6px);
  animation: winFade 2.8s ease-out forwards;
}
@keyframes winFade{
  0%{opacity:0}
  12%{opacity:1}
  80%{opacity:1}
  100%{opacity:0}
}
.winCard{
  position:relative;
  padding:18px 18px 14px;
  border-radius:20px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
  box-shadow:0 24px 60px rgba(0,0,0,.55);
  text-align:center;
  min-width:min(360px, 86vw);
  transform:translateZ(0);
  animation: winPop 900ms cubic-bezier(.2,.9,.2,1) both;
}
@keyframes winPop{
  0%{ transform:scale(.92); opacity:.0; }
  55%{ transform:scale(1.03); opacity:1; }
  100%{ transform:scale(1); opacity:1; }
}
.winTitle{
  font-weight:1000;
  font-size:22px;
  margin:0 0 6px;
  background:var(--chrome-text);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
  text-shadow:0 2px 12px rgba(0,0,0,.55);
}
.winSub{ color:rgba(238,244,255,.92); font-weight:900; letter-spacing:.3px; }
.confetti{
  position:absolute;
  inset:-16px;
  overflow:hidden;
  border-radius:22px;
  pointer-events:none;
}
.confetti span{
  position:absolute;
  top:-18px;
  width:10px;
  height:16px;
  border-radius:4px;
  opacity:.92;
  transform:translateY(0) rotate(0deg);
  animation: confettiFall 1.9s linear infinite;
}
@keyframes confettiFall{
  0%{ transform:translateY(-10px) rotate(0deg); opacity:.0; }
  10%{ opacity:1; }
  100%{ transform:translateY(420px) rotate(320deg); opacity:0; }
}

/* ===== Topbar button sizing (touch friendly) ===== */
.topActions .btn{
  min-height:44px;
  padding:10px 14px;
}
.topActions .btn.ghost#soundBtn{
  min-width:52px;
  width:52px;
  padding:10px 0;
  font-size:18px;
}
.btn.ghost{
  border-color:rgba(255,255,255,.12);
}
.btn.ghost:active{ transform:translateY(1px); }

/* ===== Safety: never hide table body text ===== */
.tableWrap tbody td{ color: var(--text); background: transparent; }
.tableWrap tbody td *{ color: inherit; -webkit-text-fill-color: currentColor; }

</style>
</head>

<body>
<!-- BUILD: v47_20260212T220500Z -->
<div class="topbar">
  <div class="topActions left">
    <button class="btn ghost" id="signOutBtn" type="button" style="display:none;">Sign out</button>
  </div>

  <div class="brand">
    <div class="t" id="brandTitle">Game Night</div>
    <div class="s">The Dart Room ‚Ä¢ Designed by Steve‚Äôs Graphic Designs ‚Ä¢ build v45_20260212-20260212-220</div>
  </div>

  <div class="topActions right">
    <button class="btn ghost" id="soundBtn" type="button" aria-label="Sound toggle">üîä</button>
    <button class="btn ghost" id="homeBtn" type="button">Home</button>
  </div>
</div>

<div class="wrap" id="app">
  <div class="card"><div class="h1">Loading‚Ä¶</div><div class="sub">Starting up‚Ä¶</div></div>
</div>

<!-- footer legal (on every page) -->
<div class="footerLegal" aria-hidden="true">
  <div class="txt">Night Games is an official Dart Room online training tool. All rights reserved ¬© Steve‚Äôs Graphic Designs. ‚Ä¢ build v45_20260212-2026-02-12</div>
</div>

<script>

/* ========= Robust script loader ========= */
function loadScript(src){
  return new Promise((resolve,reject)=>{
    const s=document.createElement("script");
    s.src=src; s.async=true;
    s.onload=resolve;
    s.onerror=()=>reject(new Error("Failed to load: "+src));
    document.head.appendChild(s);
  });
}
function esc(s){ return String(s==null?"":s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function normEmail(e){ return String(e==null?"":e).trim().toLowerCase(); }
function now(){ return Date.now(); }
function fmt(ts){ try{return new Date(ts).toLocaleString();}catch{return "";} }

// ===== Sound (toggle + tiny synth beeps; no external files) =====
let soundEnabled = true;
try{
  const v = localStorage.getItem("gn_sound");
  if(v === "0") soundEnabled = false;
}catch{}

let __audioCtx = null;
const MASTER_GAIN = 3.2; // boosted for phone speakers

function ensureAudio(){
  if(__audioCtx) return __audioCtx;
  try{
    __audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }catch(_){}
  return __audioCtx;
}

// ===== Audio unlock (iOS/Safari) =====
let __audioUnlocked = false;
function unlockAudio(){
  if(__audioUnlocked) return;
  const ctx = ensureAudio();
  if(!ctx) return;
  try{ if(ctx.state === "suspended") ctx.resume(); }catch(_){}
  // tiny silent tick to fully unlock
  try{
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    g.gain.value = 0.0002;
    o.frequency.value = 440;
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime + 0.02);
  }catch(_){}
  __audioUnlocked = true;
}
window.addEventListener("pointerdown", unlockAudio, {passive:true});
window.addEventListener("touchstart", unlockAudio, {passive:true});

function playBeep(kind){
  unlockAudio();
  if(!soundEnabled) return;
  // Ensure iOS/Safari audio is unlocked on first gesture
  try{ unlockAudio(); }catch(_){ }
  const ctx = ensureAudio();
  if(!ctx) return;

  try{ if(ctx.state === "suspended") ctx.resume(); }catch(_){}

  // Prevent double-fires
  const _nowMs = Date.now();
  window.__lastBeepAt = window.__lastBeepAt || 0;
  if((_nowMs - window.__lastBeepAt) < 70) return;
  window.__lastBeepAt = _nowMs;

  const t0 = ctx.currentTime;

  // Theme: each "glow color" maps to a consistent sound family.
  // ok (green), danger (red), hit (cyan), miss (low), back (neutral), nav (neutral),
  // click (neutral), toggle (tick), win (celebration).
  const preset = (() => {
    switch(kind){
      case "ok":     return {type:"triangle", notes:[523.25], dur:0.14, gain:0.85}; // C5
      case "danger": return {type:"sawtooth", notes:[220],    dur:0.16, gain:0.85}; // A3
      case "hit":    return {type:"sine",     notes:[659.25], dur:0.13, gain:0.84}; // E5
      case "miss":   return {type:"sine",     notes:[196],    dur:0.16, gain:0.85}; // G3
      case "back":   return {type:"triangle", notes:[329.63], dur:0.10, gain:0.85}; // E4
      case "nav":    return {type:"triangle", notes:[392.00], dur:0.10, gain:0.85}; // G4
      case "toggle": return {type:"square",   notes:[784.00], dur:0.09, gain:0.85}; // G5
      case "win":    return {type:"triangle", notes:[523.25,659.25,783.99,1046.5], dur:0.42, gain:0.85}; // C major
      case "click":
      default:       return {type:"triangle", notes:[440.00], dur:0.10, gain:0.85}; // A4
    }
  })();

  function tone(freq, start, dur, gain){
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = preset.type;
    o.frequency.setValueAtTime(freq, start);

    g.gain.setValueAtTime(0.0001, start);
    const g1 = Math.min(0.95, gain * MASTER_GAIN);
    g.gain.exponentialRampToValueAtTime(g1, start + 0.015);
    g.gain.exponentialRampToValueAtTime(0.0001, start + dur);

    o.connect(g);
    g.connect(ctx.destination);
    o.start(start);
    o.stop(start + dur + 0.02);
  }

  if(kind === "win"){
    const step = 0.09;
    preset.notes.forEach((f,i)=>tone(f, t0 + i*step, 0.18, preset.gain));
    return;
  }

  tone(preset.notes[0], t0, preset.dur, preset.gain);
}

function setSoundEnabled(on){
  soundEnabled = !!on;
  try{ localStorage.setItem("gn_sound", soundEnabled ? "1" : "0"); }catch(_){}
  if(soundBtn){
    soundBtn.textContent = soundEnabled ? "üîä" : "üîà";
    soundBtn.setAttribute("aria-label", soundEnabled ? "Sound on" : "Sound off");
  }
}

/* ===== Global UI click sounds (ONE handler; all buttons get a sound) =====
   - Gameplay buttons (hitBtn/kAttackBtn) keep their own hit/miss/win sounds.
   - Sound toggle uses its own tone.
   - Back buttons and delete buttons are covered via class/id/text.
*/
document.addEventListener("click", (ev)=>{
  const btn = ev.target && ev.target.closest ? ev.target.closest("button") : null;
  if(!btn || btn.disabled) return;

  // Ensure audio is unlocked on first interaction
  try{ unlockAudio(); }catch(_){ }

  // If a button explicitly opts out
  if(btn.dataset && btn.dataset.nosound === "1") return;

  // Sound toggle has its own handler
  if(btn.id === "soundBtn") return;

  // Gameplay buttons already trigger precise sounds inside game logic
  if((btn.classList && btn.classList.contains("hitBtn")) || (btn.classList && btn.classList.contains("kAttackBtn"))) return;

  const id = String(btn.id||"").toLowerCase();
  const txt = String(btn.textContent||"").trim().toLowerCase();

  // Delete / destructive
  if((btn.classList && btn.classList.contains("danger"))) return playBeep("danger");

  // Confirm / primary action
  if((btn.classList && btn.classList.contains("ok"))) return playBeep("ok");

  // Back/undo/nav (ghosts and any button that reads "back")
  if(id.includes("back") || txt === "back" || txt === "undo") return playBeep("back");
  if((btn.classList && btn.classList.contains("ghost"))) return playBeep("nav");

  // Default
  return playBeep("click");
}, {capture:true});

// ===== Turn name swipe helper (keeps state across renders) =====
let _turnNameCache = {};

function turnNameHTML(name){
  const nm = esc(name||"");
  return `<div class="turnNameText turnTitle3d turnNameGlow">
    <span class="turnBracket">‚ü¶</span><span class="turnPlayerName">${nm}</span><span class="turnBracket">‚üß</span>
  </div>`;
}

function animateTurnName(gameId, name){
  const box=document.getElementById("turnNameBox");
  if(!box) return;

  const prev=_turnNameCache[gameId];
  _turnNameCache[gameId]=name;

  // Always render something (DOM is replaced on every render)
  if(!prev || prev===name){
    box.innerHTML = turnNameHTML(name);
    return;
  }

  // Slide old out, new in
  box.innerHTML = `
    <div class="turnNameSlide turnOld">${turnNameHTML(prev)}</div>
    <div class="turnNameSlide turnNew">${turnNameHTML(name)}</div>
  `;

  const oldWrap = box.querySelector(".turnOld");
  const newWrap = box.querySelector(".turnNew");

  try{
    oldWrap.animate(
      [{transform:"translateX(0%)", opacity:1},{transform:"translateX(-140%)", opacity:0.2}],
      {duration:320,easing:"cubic-bezier(.2,.8,.2,1)"}
    );
    newWrap.animate(
      [{transform:"translateX(140%)", opacity:0.2},{transform:"translateX(0%)", opacity:1}],
      {duration:320,easing:"cubic-bezier(.2,.8,.2,1)"}
    ).onfinish=()=>{ box.innerHTML = turnNameHTML(name); };
  }catch(_){
    box.innerHTML = turnNameHTML(name);
  }
}


const appEl=document.getElementById("app");
const homeBtn=document.getElementById("homeBtn");
const soundBtn=document.getElementById("soundBtn");
const signOutBtn=document.getElementById("signOutBtn");
const brandTitle=document.getElementById("brandTitle");

// ===== Render hygiene (prevents ‚Äúbouncing‚Äù on presence updates) =====
window.__renderReason = "nav";
function requestRender(reason){
  window.__renderReason = reason || "nav";
  render();
}

function setHTML(html){
  appEl.innerHTML = html;

  try{
    if(window.__screenChanged){
      appEl.animate(
        [{ opacity: 0 }, { opacity: 1 }],
        { duration: 160, easing: "cubic-bezier(.2,.8,.2,1)" }
      );
    }
  }catch(e){}

  try{
    if(window.__screenChanged){
      window.scrollTo({top:0, left:0, behavior:"instant"});
    }
  }catch(e){
    if(window.__screenChanged) window.scrollTo(0,0);
  }
}

// ===== Win overlay (end of match) =====
function showWinOverlay(title, subtitle){
  try{
    const wrap = document.createElement("div");
    wrap.className = "winOverlay";
    const card = document.createElement("div");
    card.className = "winCard";
    const conf = document.createElement("div");
    conf.className = "confetti";

    const colors = ["rgba(34,211,238,.95)","rgba(59,130,246,.95)","rgba(249,115,22,.90)","rgba(34,197,94,.90)","rgba(249,115,22,.90)"];
    const pieces = 26;
    for(let i=0;i<pieces;i++){
      const s=document.createElement("span");
      s.style.left = (Math.random()*100).toFixed(2) + "%";
      s.style.animationDelay = (Math.random()*0.35).toFixed(2) + "s";
      s.style.animationDuration = (1.35 + Math.random()*0.9).toFixed(2) + "s";
      s.style.background = colors[i % colors.length];
      s.style.transform = `translateY(-10px) rotate(${Math.floor(Math.random()*180)}deg)`;
      conf.appendChild(s);
    }

    card.innerHTML = `
      <div class="winTitle">${esc(title||"Match complete")}</div>
      <div class="winSub">${esc(subtitle||"")}</div>
    `;
    card.appendChild(conf);
    wrap.appendChild(card);
    document.body.appendChild(wrap);

    setTimeout(()=>{ try{ wrap.remove(); }catch{} }, 2850);
  }catch(_){}
}
function showFatal(title,msg){
  setHTML(`
    <div class="card">
      <div class="hero">
        <div class="heroCornerLeft">
          <div class="logoMark"><span>‚ö†</span></div>
        </div>
        <div class="heroMain" style="align-items:flex-start;text-align:left">
          <div class="h1">${esc(title)}</div>
          <div class="sub" style="white-space:pre-wrap">${esc(msg)}</div>
        </div>
        <div class="heroCornerRight"></div>
      </div>
      <div class="divider"></div>
      <div class="row">
        <button class="btn ok" id="retryBtn">Retry</button>
        <button class="btn ghost" id="reloadBtn">Hard Reload</button>
      </div>
      <div class="divider"></div>
      <div class="sub">If you see an error, try a hard reload or re-paste the file.</div>
    </div>
  `);
  document.getElementById("retryBtn").onclick=()=>boot();
  document.getElementById("reloadBtn").onclick=()=>location.reload(true);
}

function boot(){
  try{
    setHTML(`<div class="card"><div class="h1">Loading‚Ä¶</div><div class="sub">Starting Game Night‚Ä¶</div></div>`);
    startApp();
  }catch(err){
    showFatal("Can‚Äôt start app", err?.message || String(err));
  }
}

  console.log("GameNight ONLINE build loaded");

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyC0sdB54z0G73P3epW6GmHqgYvESFcqgTo",
  authDomain: "gamenightdarts-e7601.firebaseapp.com",
  projectId: "gamenightdarts-e7601",
  storageBucket: "gamenightdarts-e7601.appspot.com",
  messagingSenderId: "270045452251",
  appId: "1:270045452251:web:393956ce18b43316e939fe",
  measurementId: "G-LQEHF02ZVR"
};

const appFB = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const ROOM_ID = "global";

async function ensureAuth(){
  if(auth.currentUser) return auth.currentUser;
  const res = await auth.signInAnonymously();
  return res.user;
}

function normEmail(e){ return String(e||"").trim().toLowerCase(); }
function now(){ return Date.now(); }

// ===== PLAYERS (ONLINE SHARED) =====
async function getPlayers(){
  await ensureAuth();
  const snap = await db.collection("rooms").doc(ROOM_ID).collection("players").get();
  const arr = snap.docs.map(d => d.data());
  arr.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
  return arr;
}

async function upsertPlayer(name,email){
  await ensureAuth();
  const e=normEmail(email);
  await db.collection("rooms").doc(ROOM_ID).collection("players").doc(e).set({
    email:e,
    name:String(name||"").trim(),
    updatedAt:now()
  }, { merge:true });
}

// ===== STATS =====
async function getStatsDoc(email){
  await ensureAuth();
  const e=normEmail(email);
  const doc = await db.collection("rooms").doc(ROOM_ID).collection("stats").doc(e).get();
  return doc.exists ? doc.data() : {};
}

async function saveStatsDoc(email,data){
  await ensureAuth();
  const e=normEmail(email);
  await db.collection("rooms").doc(ROOM_ID).collection("stats").doc(e).set({
    ...(data||{}),
    updatedAt:now()
  }, { merge:true });
}

// ===== HISTORY =====
async function getHistory(email){
  await ensureAuth();
  const e=normEmail(email);

  const snap = await db.collection("rooms")
    .doc(ROOM_ID)
    .collection("history")
    .where("players","array-contains",e)
    .orderBy("endedAt","desc")
    .limit(60)
    .get();

  return snap.docs.map(d => d.data());
}

async function saveHistoryEntry(entry){
  await ensureAuth();
  await db.collection("rooms")
    .doc(ROOM_ID)
    .collection("history")
    .add({
      ...(entry||{}),
      savedAt:now()
    });
}
  // Admin helpers
  async function resetStatsAll(email){
    const e=normEmail(email);
    lsWrite(LS.statsPrefix + e, { games:{}, updatedAt: now() });
  }
  async function resetStatsGame(email, gameId){
    const e=normEmail(email);
    const cur = await getStatsDoc(e);
    const games = cur.games || {};
    const nextGames = { ...games };
    delete nextGames[gameId];
    await saveStatsDoc(e, { games: nextGames, updatedAt: now() });
  }
  async function deleteHistoryForPlayer(email){
    const e=normEmail(email);
    const all = lsRead(LS.history, []) || [];
    const next = all.filter(h=>!(Array.isArray(h.players) && h.players.includes(e)));
    lsWrite(LS.history, next);
  }
  async function deletePlayerAndData(email){
    const e=normEmail(email);
    const map=getPlayersMap();
    delete map[e];
    setPlayersMap(map);
    try{ localStorage.removeItem(LS.statsPrefix + e); }catch(_){}
    await deleteHistoryForPlayer(e);
  }

  // Auth (offline)
  async function signInEmail(email){
    const e=normEmail(email);
    const map=getPlayersMap();
    return map[e] || null;
  }
  async function signUpEmail(name,email){
    const e=normEmail(email);
    await upsertPlayer(name,e);
    const map=getPlayersMap();
    return map[e] || {name:String(name||"").trim(), email:e};
  }

  // Presence disabled in offline mode
  function presenceKey(email){ return "gn_presence_"+normEmail(email); }
  function readPresence(email){
    const k=presenceKey(email);
    try{
      const raw=localStorage.getItem(k);
      if(!raw) return null;
      const obj=JSON.parse(raw);
      return obj && typeof obj.lastSeenAt==="number" ? obj : null;
    }catch(_){ return null; }
  }
  function beatPresence(email,name){
    const e=normEmail(email);
    if(!e) return;
    const payload={email:e,name:(name||null),lastSeenAt:now()};
    try{ localStorage.setItem(presenceKey(e), JSON.stringify(payload)); }catch(_){}
  }
  const PRESENCE_BEAT_MS = 20000;
  const PRESENCE_ONLINE_MS = 45000;
  let __presenceTimer=null;
  let __presenceEmail=null;

  function isOnline(email){
    const p=readPresence(email);
    if(!p) return false;
    return (now() - (p.lastSeenAt||0)) <= PRESENCE_ONLINE_MS;
  }
  function subscribePresence(){ /* localStorage-backed; no subscription needed */ }

  function startPresence(email){
    const e=normEmail(email);
    if(!e) return;
    if(__presenceEmail===e && __presenceTimer) return;
    stopPresence();
    __presenceEmail=e;

    const doBeat=()=>beatPresence(e, meUser?.name||null);
    doBeat();
    __presenceTimer=setInterval(doBeat, PRESENCE_BEAT_MS);

    // Refresh roster when other tabs/devices on same iCloud profile update localStorage
    if(!window.__presenceStorageBound){
      window.__presenceStorageBound=true;
      window.addEventListener("storage", (ev)=>{
        if(ev && typeof ev.key==="string" && ev.key.startsWith("gn_presence_")){
          requestRender("presence");
        }
      });
    }
    if(!window.__presencePoller){
      window.__presencePoller=setInterval(()=>requestRender("presence"), 8000);
    }
    if(!window.__presenceVisBound){
      window.__presenceVisBound=true;
      document.addEventListener("visibilitychange", ()=>{
        if(document.visibilityState==="visible"){ try{ doBeat(); }catch{} }
      });
    }
  }
  function stopPresence(){
    try{ if(__presenceTimer) clearInterval(__presenceTimer); }catch(_){}
    __presenceTimer=null;
    __presenceEmail=null;
  }


  const BOARD_NUMS=[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];

  function polar(cx,cy,r,deg){
    const rad=(deg-90)*Math.PI/180;
    return {x:cx+r*Math.cos(rad), y:cy+r*Math.sin(rad)};
  }
  function arcWedgePath(cx,cy,r0,r1,a0,a1){
    const p1=polar(cx,cy,r1,a0), p2=polar(cx,cy,r1,a1);
    const p3=polar(cx,cy,r0,a1), p4=polar(cx,cy,r0,a0);
    const large=(a1-a0)>180?1:0;
    const f=n=>(Math.round(n*1000)/1000).toFixed(3);
    return `M ${f(p1.x)} ${f(p1.y)} A ${r1} ${r1} 0 ${large} 1 ${f(p2.x)} ${f(p2.y)} L ${f(p3.x)} ${f(p3.y)} A ${r0} ${r0} 0 ${large} 0 ${f(p4.x)} ${f(p4.y)} Z`;
  }
  function dartboardSVG(activeTarget){
    const cx=100,cy=100;
    const outer=80, rDoubleOuter=74, rDoubleInner=66, rTripleOuter=48, rTripleInner=40, rSingleInner=12;
    const seg=360/20;
    const rot=-seg/2;

    function polar(cx,cy,r,deg){
      const rad=(deg-90)*Math.PI/180;
      return {x:cx+r*Math.cos(rad), y:cy+r*Math.sin(rad)};
    }
    function arcWedgePath(cx,cy,r0,r1,a0,a1){
      const p1=polar(cx,cy,r1,a0), p2=polar(cx,cy,r1,a1);
      const p3=polar(cx,cy,r0,a1), p4=polar(cx,cy,r0,a0);
      const large=(a1-a0)>180?1:0;
      const f=n=>(Math.round(n*1000)/1000).toFixed(3);
      return `M ${f(p1.x)} ${f(p1.y)} A ${r1} ${r1} 0 ${large} 1 ${f(p2.x)} ${f(p2.y)} L ${f(p3.x)} ${f(p3.y)} A ${r0} ${r0} 0 ${large} 0 ${f(p4.x)} ${f(p4.y)} Z`;
    }
    function ringWedges(r0,r1,fillA,fillB){
      let out="";
      for(let i=0;i<20;i++){
        const a0=i*seg+rot+0.8;
        const a1=(i+1)*seg+rot-0.8;
        out+=`<path d="${arcWedgePath(cx,cy,r0,r1,a0,a1)}" fill="${i%2===0?fillA:fillB}" opacity="0.95"/>`;
      }
      return out;
    }

    // ===== Active target overlay (full slice across the 4 segments) =====
    let activeOverlay="";
    if(typeof activeTarget === "number"){
      const idx = BOARD_NUMS.indexOf(activeTarget);
      if(idx >= 0){
        const a0 = idx*seg + rot + 0.6;
        const a1 = (idx+1)*seg + rot - 0.6;

        const slices = [
          // Full slice glow (behind everything for this number)
          {r0:rSingleInner, r1:rDoubleOuter, fill:"rgba(34,211,238,.16)", stroke:"rgba(34,211,238,.94)", sw:3.4},
          // Double ring (outer)
          {r0:rDoubleInner, r1:rDoubleOuter, fill:"rgba(239,68,68,.30)", stroke:"rgba(255,255,255,.92)", sw:3.0},
          // Triple ring
          {r0:rTripleInner, r1:rTripleOuter, fill:"rgba(239,68,68,.26)", stroke:"rgba(255,255,255,.88)", sw:2.8},
          // Outer single ring (between triple and double)
          {r0:rTripleOuter, r1:rDoubleInner, fill:"rgba(34,211,238,.20)", stroke:"rgba(34,211,238,.96)", sw:3.0},
          // Inner single ring (between bull and triple)
          {r0:rSingleInner, r1:rTripleInner, fill:"rgba(34,211,238,.18)", stroke:"rgba(34,211,238,.92)", sw:2.7},
        ];

        // Big soft glow behind
        activeOverlay += `<path class="hotWedgePulse" d="${arcWedgePath(cx,cy,rSingleInner,rDoubleOuter,a0,a1)}"
          fill="rgba(34,197,94,.10)" stroke="rgba(34,211,238,.55)" stroke-width="7.5" filter="url(#glow)" />`;

        for(const s of slices){
          activeOverlay += `<path class="hotWedgePulse" d="${arcWedgePath(cx,cy,s.r0,s.r1,a0,a1)}"
            fill="${s.fill}" stroke="${s.stroke}" stroke-width="${s.sw}" filter="url(#glow)"/>`;
        }
      }
    }else if(activeTarget === "B"){
      activeOverlay += `
        <circle class="hotWedgePulse" cx="100" cy="100" r="14.5" fill="rgba(34,211,238,.22)" stroke="rgba(34,211,238,.98)" stroke-width="3.0" filter="url(#glow)"/>
        <circle class="hotWedgePulse" cx="100" cy="100" r="7.6"  fill="rgba(34,197,94,.16)" stroke="rgba(255,255,255,.92)" stroke-width="2.6" filter="url(#glow)"/>
      `;
    }

    // Numbers (with active number emphasized too)
    let numText="";
    for(let i=0;i<20;i++){
      const ang=i*seg+rot+seg/2;
      const p=polar(cx,cy,90,ang);
      const n=BOARD_NUMS[i];
      const isActive = (typeof activeTarget==="number" && n===activeTarget);
      if(isActive){
        numText+=`<text x="${p.x.toFixed(2)}" y="${p.y.toFixed(2)}" text-anchor="middle" dominant-baseline="middle"
          font-size="10.2" fill="#22d3ee" font-weight="1000"
          style="paint-order:stroke;stroke:#ffffff;stroke-width:2.6px;filter:url(#glow)">${n}</text>`;
      }else{
        numText+=`<text x="${p.x.toFixed(2)}" y="${p.y.toFixed(2)}" text-anchor="middle" dominant-baseline="middle"
          font-size="8.5" fill="#dfe9ff" font-weight="900"
          style="paint-order:stroke;stroke:#07101d;stroke-width:2px">${n}</text>`;
      }
    }

    return `<svg viewBox="0 0 200 200" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
      <defs>
        <radialGradient id="bgG" cx="50%" cy="42%" r="65%">
          <stop offset="0%" stop-color="#1a2a4a"/>
          <stop offset="55%" stop-color="#0b1325"/>
          <stop offset="100%" stop-color="#040814"/>
        </radialGradient>
        <filter id="glow" x="-30%" y="-30%" width="160%" height="160%">
          <feGaussianBlur stdDeviation="4.8" result="b"/>
          <feColorMatrix in="b" type="matrix"
            values="0 0 0 0 0.18  0 0 0 0 0.92  0 0 0 0 1.00  0 0 0 1.0 0" result="c"/>
          <feMerge><feMergeNode in="c"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>
      <circle cx="100" cy="100" r="${outer}" fill="url(#bgG)" stroke="#2a3f5f" stroke-width="2"/>
      ${ringWedges(rTripleOuter,rDoubleInner,"#0b1220","#1a2338")}
      ${ringWedges(rTripleInner,rTripleOuter,"#2aa84a","#c63a3a")}
      ${ringWedges(rDoubleInner,rDoubleOuter,"#2aa84a","#c63a3a")}
      ${ringWedges(rSingleInner,rTripleInner,"#1a2338","#0b1220")}
      ${activeOverlay}
      <circle cx="100" cy="100" r="11.5" fill="#2aa84a" stroke="#1b2b42" stroke-width="2"/>
      <circle cx="100" cy="100" r="5.3" fill="#c63a3a" stroke="#1b2b42" stroke-width="1.5"/>
      ${numText}
    </svg>`;
  }

  function pushSnap(m){
    m.snaps=m.snaps||[];
    m.snaps.push(JSON.stringify(m));
    if(m.snaps.length>80) m.snaps.shift();
  }
  function popSnap(m){
    if(!m?.snaps || m.snaps.length < 1) return m;
    // snaps store the state *before* each action. Undo should roll back exactly ONE action.
    const prevStr = m.snaps.pop();
    let prev;
    try{ prev = JSON.parse(prevStr); }catch{ return m; }
    // Preserve remaining history so multiple undos work reliably.
    prev.snaps = m.snaps;
    return prev;
  }

  const Games=[
    {id:"shanghai", name:"Shanghai", icon:"üéØ", active:true,  tagline:"20 ‚Üí 15 ‚Üí Bull"},
    {id:"killer",   name:"Killer",   icon:"üî•", active:true,  tagline:"Claim a number ‚Ä¢ Hit doubles"},
    {id:"around",   name:"Around the World", icon:"üåç", active:true,  tagline:"1 ‚Üí 20 ‚Üí Bull ‚Ä¢ Singles/Doubles/Triples"},
    {id:"halve",    name:"Halve-It", icon:"‚ûó", active:false, tagline:"Coming soon"},
    {id:"baseball", name:"Baseball", icon:"‚öæ", active:false, tagline:"Coming soon"},
  ];
  const getGame=id=>Games.find(g=>g.id===id)||null;

  const ShanghaiGame=(()=>{
    const TARGETS=[20,19,18,17,16,15,"B"];
    const pts=hit=>hit==="T"?3:hit==="D"?2:hit==="S"?1:0;

    function initMatch(selectedPlayers){
      const m={
        gameId:"shanghai",
        players:selectedPlayers.map(p=>({name:p.name,email:p.email,total:0})),
        startedAt:now(), endedAt:null,
        turnIndex:0, targetIndex:0, dartInTurn:0,
        finished:false, grid:{}, snaps:[], _saved:false
      };
      m.players.forEach(p=>{
        m.grid[p.email]={};
        TARGETS.forEach(t=>{
          m.grid[p.email][String(t)]={throws:[],points:0};
        });
      });
      pushSnap(m);
      return m;
    }

    function addThrow(m, hit){
      if(!m||m.finished) return;
      const player=m.players[m.turnIndex];
      const targetKey=String(TARGETS[m.targetIndex]);
      const cell=m.grid[player.email][targetKey];
      cell.throws.push(hit);
      cell.points+=pts(hit);
      player.total+=pts(hit);

      m.dartInTurn++;
      if(m.dartInTurn>=3){
        m.dartInTurn=0;
        m.turnIndex=(m.turnIndex+1)%m.players.length;
        if(m.turnIndex===0) m.targetIndex++;
      }
      if(m.targetIndex>=TARGETS.length){
        m.finished=true;
        m.endedAt=now();
      }
    }

    async function saveFinish(ctx){
      const m=ctx.match;
      if(!m.finished||m._saved) return;
      m._saved=true;

      const summary=m.players.slice().sort((a,b)=>b.total-a.total)
        .map(p=>`${p.name}: ${p.total}`).join(" | ");

      await saveHistoryEntry({
        gameId:"shanghai", gameName:"Shanghai",
        startedAt:m.startedAt, endedAt:m.endedAt,
        players:m.players.map(p=>p.email),
        summary,
        meta:{targets:TARGETS}
      });

      const stats=await getStatsDoc(ctx.meUser.email);
      const games=stats.games||{};
      const g=games.shanghai||{};
      const played=(g.played||0)+1;

      const meRow=m.players.find(p=>p.email===ctx.meUser.email);
      const myScore=meRow?meRow.total:0;
      const points=(g.points||0)+myScore;
      const best=Math.max(g.best||0,myScore);

      await saveStatsDoc(ctx.meUser.email,{
        games:{...games, shanghai:{...g, played, points, best, lastPlayedAt:m.endedAt||now()}},
        updatedAt:now()
      });
    }

    function renderPlay(ctx){
      const m=ctx.match;
      const t=TARGETS[m.targetIndex];

      let thead=`<tr><th>Target</th>`;
      for(const p of m.players){
        thead+=`<th><span class="thName">${esc(p.name)}</span><div class="small">${p.total} pts</div></th>`;
      }
      thead+=`</tr>`;

      let tbody="";
      for(const target of TARGETS){
        const key=String(target);
        tbody+=`<tr><td class="l"><span class="badge">${esc(target==="B"?"BULL":target)}</span></td>`;
        for(const p of m.players){
          const cell=m.grid[p.email][key];
          const txt=cell.throws.length?cell.throws.join(" "):"‚Äî";
          const cls=String(t)===key?` class="activeCell"`:"";
          tbody+=`<td${cls}>${esc(txt)}<div class="small">${cell.points}</div></td>`;
        }
        tbody+=`</tr>`;
      }

      const finishedBanner=m.finished?`<div class="divider"></div><div class="pill">Finished</div>`:"";

      return `
        <div class="card">
          <div class="row">
            <button class="btn ghost" id="backToSetup">Back</button>
            <button class="btn danger" id="resetBtn">Reset</button>
          </div>
        </div>

        <div class="card">
          <div class="headerStack">
            <div class="headerTopRow">
              <div class="left"><span class="pill">Shanghai</span></div>
              <div class="right"><span class="pill" data-live="1">Live</span></div>
            </div>
            <div class="headerIcon">üéØ</div>
            <div class="headerTitle turnTitle3d">Shanghai</div>
            ${m.finished ? "" : `<div class="turnNameBox" id="turnNameBox">${turnNameHTML((m.players[m.turnIndex] && m.players[m.turnIndex].name)||"")}</div>`}
            ${m.finished?"":`<div class="small" style="text-align:center"><span class="badge">NOW THROWING</span></div>`}
            <div class="sub" style="text-align:center;margin-top:6px">Target: <span class="targetFlash">${esc(t==="B"?"BULL":t)}</span> ‚Ä¢ Dart <b>${m.dartInTurn+1}</b>/3</div>
          </div>

          <div class="divider"></div>
          <div class="boardBox">${dartboardSVG(t)}</div>
          ${playerStripHTML(m.players, m.turnIndex, (p)=>"Score: <b>"+esc(p.total)+"</b>")}
          <div class="divider"></div>

          <div class="hitRow">
            <button class="hitBtn" id="hitT" ${m.finished?"disabled":""}>TRIPLE</button>
            <button class="hitBtn" id="hitS" ${m.finished?"disabled":""}>SINGLE</button>
            <button class="hitBtn" id="hitD" ${m.finished?"disabled":""}>DOUBLE</button>
            <button class="hitBtn miss" id="hitM" ${m.finished?"disabled":""}>MISS</button>
            <button class="hitBtn undo3" id="undoBtn" type="button">UNDO</button>
          </div>

          ${finishedBanner}
        </div>

        <div class="card">
          <div class="pill">Round table</div>
          <div class="divider"></div>
          <div class="tableWrap">
            <table><thead>${thead}</thead><tbody>${tbody}</tbody></table>
          </div>
        </div>
      `;
    }

    function bindPlay(ctx){
      try{ animateTurnName("shanghai", ctx.match.players[ctx.match.turnIndex].name); }catch{}
      const $=(id)=>document.getElementById(id);
      function onHit(h){
        playBeep(h==="M" ? "miss" : "hit");
        const m=ctx.match;
        if(m.finished) return;
        pushSnap(m);
        addThrow(m,h);
        if(m.finished && !m._winShown){ m._winShown=true; playBeep("win"); showWinOverlay("üèÜ Winner!", ((m.players.slice().sort((a,b)=>b.total-a.total)[0] && m.players.slice().sort((a,b)=>b.total-a.total)[0].name)||"")); }
        render();
        saveFinish(ctx).catch(e=>showFatal("Save error", (e && e.message) || String(e)));
      }
      document.getElementById("hitT").onclick=()=>onHit("T");
      document.getElementById("hitS").onclick=()=>onHit("S");
      document.getElementById("hitD").onclick=()=>onHit("D");
      document.getElementById("hitM").onclick=()=>onHit("M");
      document.getElementById("undoBtn").onclick=()=>{ match=popSnap(ctx.match); render(); };

      const resetBtn=$("resetBtn"); if(resetBtn) resetBtn.onclick=()=>{
        const pls=ctx.match.players.map(p=>({name:p.name,email:p.email}));
        match=initMatch(pls);
        render();
      };
      const backBtn=$("backToSetup"); if(backBtn) backBtn.onclick=()=>{
        match=null; screen="game.setup"; render();
      };
    }

    return {initMatch, renderPlay, bindPlay};
  })();

  const KillerGame = (() => {
    const MAX_LIVES = 3;

    function initMatch(selectedPlayers){
      return {
        gameId:"killer",
        phase:"claim",
        claimIndex:0,
        players: selectedPlayers.map(p=>({
          name:p.name,
          email:p.email,
          number:null,
          lives:MAX_LIVES,
          killer:false,
          out:false
        })),
        turnIndex:0,
        dartInTurn:0,
        finished:false,
        winner:null,
        startedAt:now(),
        endedAt:null,
        _saved:false
      };
    }

    function nextAliveIndex(m, from){
      for(let step=1; step<=m.players.length; step++){
        const i=(from+step)%m.players.length;
        if(!m.players[i].out) return i;
      }
      return from;
    }

    function checkWinner(m){
      const alive=m.players.filter(p=>!p.out);
      if(alive.length===1){
        m.finished=true;
        m.winner=alive[0];
        m.endedAt=now();
      }
    }

    async function saveFinish(ctx){
      const m=ctx.match;
      if(!m.finished || m._saved) return;
      m._saved=true;

      const winnerName = (m.winner && m.winner.name) || "Unknown";
      const summary = `üèÜ ${winnerName} wins ‚Ä¢ ` + m.players
        .map(p=>`${p.name}${p.out?" (OUT)":""}`)
        .join(" | ");

      await saveHistoryEntry({
        gameId:"killer",
        gameName:"Killer",
        startedAt:m.startedAt,
        endedAt:m.endedAt,
        players:m.players.map(p=>p.email),
        summary,
        meta:{
          winnerEmail: (m.winner && m.winner.email) || null,
          numbers: m.players.map(p=>({email:p.email, number:p.number}))
        }
      });

      const stats=await getStatsDoc(ctx.meUser.email);
      const games=stats.games||{};
      const g=games.killer||{};
      const played=(g.played||0)+1;

      const iWon = (((m.winner && m.winner.email) === ctx.meUser.email));
      const wins = (g.wins||0) + (iWon?1:0);

      await saveStatsDoc(ctx.meUser.email,{
        games:{
          ...games,
          killer:{...g, played, wins, lastPlayedAt:m.endedAt||now()}
        },
        updatedAt:now()
      });
    }

    function heartsHTML(n){
      const count=Math.max(0, Number(n||0));
      if(!count) return "";
      return Array.from({length:count}, ()=>`<span class="heart">‚ô•</span>`).join("");
    }

    function renderPlay(ctx){
      const m=ctx.match;

      if(m.phase==="claim"){
        const p=m.players[m.claimIndex];
        const taken=m.players.filter(x=>x.number!=null).map(x=>x.number);
        let opts = `<option value="" selected disabled>Select a number‚Ä¶</option>`;
        for(let n=1;n<=20;n++){
          const dis=taken.includes(n) && p.number!==n;
          opts += `<option value="${n}" ${dis?"disabled":""}>${n}${dis?" (taken)":""}</option>`;
        }
        return `
          <div class="card">
            <div class="row">
              <button class="btn ghost" id="backToSetup">Back</button>
              <button class="btn danger" id="resetBtn">Reset</button>
            </div>
          </div>

          <div class="card">
            <div class="hero">
              <div class="heroCornerLeft">
                <div class="logoMark"><span>üî•</span></div>
                <span class="kbd">Killer</span>
              </div>

              <div class="heroMain">
                <div class="h1 turnTitle3d">Killer Setup</div>
                <div class="sub">Claim your number (one at a time)</div>
              </div>

              <div class="heroCornerRight">
                <span class="pill">Setup</span>
              </div>
            </div>
            <div class="divider"></div>
            <div class="kTurnBig" style="text-align:center">${esc(p.name)}</div>
            <div class="kTurnSub" style="text-align:center">Pick the number you hit (opposite hand throw)</div>
            <div class="divider"></div>
            <select id="claimNum">${opts}</select>
            <div class="divider"></div>
            <button class="btn ok" id="saveClaim" type="button">Save & Next</button>
          </div>
        `;
      }

      const active=m.players[m.turnIndex];
      const isFinished = !!m.finished;

      const statusLine = isFinished
        ? `Winner: <b>${esc((m.winner && m.winner.name) || "")}</b>`
        : `${esc(active.name)} ‚Ä¢ Dart <b>${m.dartInTurn+1}</b>/3 ‚Ä¢ ${active.killer ? "üî• Killer" : "Not killer yet"}`;

      const rows = m.players.map(p=>{
        const livesHtml = p.out ? `<span class="lifeOut">OUT</span>` : heartsHTML(p.lives);
        return `
          <tr>
            <td class="l">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <div>
                  <div style="font-size:16px;font-weight:1000">${esc(p.name)}</div>
                  <div class="small kNumberBig">Number: <b>${esc((p.number!=null?p.number:"?"))}</b></div>
                </div>
                <div style="text-align:right">
                  <div class="kLivesBig">${livesHtml}</div>
                  <div class="small">${p.killer?"üî• Killer":p.out?"":""}</div>
                </div>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      const canAttack = (!isFinished) && active.killer;

      const attackTargets = m.players
        .filter(p=>!p.out && p.email!==active.email)
        .map(p=>{
          const label = `${p.name} ‚Ä¢ ${(p.number!=null?p.number:"?")} ‚Ä¢ ${"‚ù§Ô∏è".repeat(Math.max(0,p.lives))}`;
          return `<button class="kAttackBtn" data-attack="${esc(p.email)}" ${canAttack?"":"disabled"}>
            HIT ${esc(p.name)}‚Äôs DOUBLE ‚Üí remove 1 life
            <div class="small">${esc(label)}</div>
          </button>`;
        }).join("");

      return `
        <div class="card">
          <div class="row">
            <button class="btn ghost" id="backToSetup">Back</button>
            <button class="btn danger" id="resetBtn">Reset</button>
          </div>
        </div>

        <div class="card ${isFinished?"":"leaderGlow"}" style="${isFinished?"animation:none":""}">
          <div class="headerStack">
            <div class="headerTopRow">
              <div class="left"><span class="pill">Killer</span></div>
              <div class="right">
                <span class="pill" ${isFinished ? '' : 'data-live="1"'}>${isFinished ? "Ended" : "Live"}</span>
              </div>
            </div>
            <div class="headerIcon">üî•</div>
            <div class="headerTitle turnTitle3d">Killer</div>
            ${isFinished ? "" : `<div class="turnNameBox" id="turnNameBox">${turnNameHTML((m.players[m.turnIndex] && m.players[m.turnIndex].name)||"")}</div>`}
            ${isFinished ? "" : `<div class="small" style="text-align:center"><span class="badge">NOW THROWING</span></div>`}
            <div class="sub" style="text-align:center;margin-top:6px">${statusLine}</div>
          </div>

          ${isFinished ? "" : `
            <div class="divider"></div>
            <div class="hitRow">
              <button class="hitBtn" id="myDouble">I HIT MY DOUBLE</button>
              <button class="hitBtn miss" id="miss">MISS</button>
              <button class="hitBtn undo3" id="undoBtn" type="button">UNDO</button>
            </div>
            <div class="divider"></div>
            <div class="pill">Attack Opponents</div>
            <div class="small">Hit their double ‚Üí tap button to remove 1 life</div>
            <div class="divider"></div>
            <div class="kAttackGrid">
              ${attackTargets || `<div class="sub">No valid targets left.</div>`}
            </div>
          `}
        </div>

        <div class="card">
          <div class="pill">Players & Lives</div>
          <div class="divider"></div>
          <div class="tableWrap">
            <table>
              <thead><tr><th>Roster</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>
      `;
    }

    function bindPlay(ctx){
      const m=ctx.match;
      if(!m) return;
      try{ if(m.phase==="play" && !m.finished) animateTurnName("killer", m.players[m.turnIndex].name); }catch{}

      const backBtn=document.getElementById("backToSetup");
      if(backBtn){
        backBtn.onclick=()=>{
          match=null;
          screen="game.setup";
          render();
        };
      }
      const resetBtn=document.getElementById("resetBtn");
      if(resetBtn){
        resetBtn.onclick=()=>{
          const pls=m.players.map(p=>({name:p.name,email:p.email}));
          match=KillerGame.initMatch(pls);
          render();
        };
      }

      const claimBtn=document.getElementById("saveClaim");
      if(claimBtn){
        claimBtn.onclick=(ev)=>{ if(ev && ev.preventDefault) ev.preventDefault(); if(ev && ev.stopPropagation) ev.stopPropagation();
          const p=m.players[m.claimIndex];
          const raw=document.getElementById("claimNum").value;
          const n=parseInt(raw,10);
          if(!n){ alert("Pick a number."); return; }

          if(m.players.some(x=>x.email!==p.email && x.number===n)){
            alert("That number is taken. Pick another.");
            return;
          }
          p.number=n;

          let nextIdx=-1;
          for(let step=1; step<=m.players.length; step++){
            const i=(m.claimIndex+step)%m.players.length;
            if(m.players[i].number==null){ nextIdx=i; break; }
          }

          if(nextIdx===-1){
            m.phase="play";
            m.turnIndex=0;
            m.dartInTurn=0;
            m.players.forEach(x=>{ x.out=false; x.killer=false; x.lives=MAX_LIVES; });
          }else{
            m.claimIndex=nextIdx;
          }
          render();
        };
        return;
      }

      if(m.finished){
        saveFinish(ctx).catch(e=>showFatal("Save error", (e && e.message) || String(e)));
        return;
      }

      function pushK(m){ m.snaps=m.snaps||[]; m.snaps.push(JSON.stringify(m)); if(m.snaps.length>80) m.snaps.shift(); }
      function popK(m){
        if(!m || !m.snaps || m.snaps.length<2) return m;
        m.snaps.pop();
        const prev=m.snaps.pop();
        try{return JSON.parse(prev);}catch{return m;}
      }

      function endDart(){
        m.dartInTurn += 1;
        if(m.dartInTurn>=3){
          m.dartInTurn=0;
          m.turnIndex = nextAliveIndex(m, m.turnIndex);
        }
        checkWinner(m);
        if(m.finished && !m._winShown){ m._winShown=true; playBeep("win"); showWinOverlay("üèÜ Winner!", ((m.winner && m.winner.name) || "")); }
        render();
        if(m.finished){
          saveFinish(ctx).catch(e=>showFatal("Save error", (e && e.message) || String(e)));
        }
      }

      const undoBtn=document.getElementById("undoBtn");
      if(undoBtn){
        undoBtn.onclick=()=>{
          match=popK(ctx.match);
          render();
        };
      }

      document.getElementById("miss").onclick=()=>{ playBeep("miss");
        pushK(m);
        endDart();
      };

      document.getElementById("myDouble").onclick=()=>{ playBeep("hit");
        pushK(m);
        const me=m.players[m.turnIndex];
        if(me.number==null) return;

        if(!me.killer) me.killer=true;
        else me.lives = Math.min(MAX_LIVES, me.lives+1);

        endDart();
      };

      appEl.querySelectorAll("button[data-attack]").forEach(btn=>{
        btn.onclick=()=>{ playBeep("hit");
          const me=m.players[m.turnIndex];
          if(!me.killer) return;
          const victimEmail=btn.getAttribute("data-attack");
          const victim=m.players.find(p=>p.email===victimEmail && !p.out);
          if(!victim) return;

          pushK(m);

          victim.lives -= 1;
          if(victim.lives<=0){
            victim.lives=0;
            victim.out=true;
          }
          endDart();
        };
      });
    }

    return { initMatch, renderPlay, bindPlay };
  })();

  // ===== Around the World =====
  const AroundGame = (()=>{
    const TARGETS = Array.from({length:20},(_,i)=>i+1).concat(["B"]);
    const modeName = m => (m.mode==="D" ? "Doubles" : m.mode==="T" ? "Triples" : "Singles");

    function initMatch(selectedPlayers, mode){
      const m={
        gameId:"around",
        mode: (mode==="D"||mode==="T") ? mode : "S",
        players: selectedPlayers.map(p=>({
          name:p.name,
          email:p.email,
          progressIndex:0,
          dartsThrown:0,
          hits:0
        })),
        turnIndex:0,
        dartInTurn:0,
        finished:false,
        winner:null,
        startedAt:now(),
        endedAt:null,
        snaps:[],
        _saved:false
      };
      pushSnap(m);
      return m;
    }

    function currentTarget(m, p){
      const idx = Math.min(p.progressIndex, TARGETS.length-1);
      return TARGETS[idx];
    }

    function finishIfDone(m, p){
      if(p.progressIndex>=TARGETS.length){
        m.finished=true;
        m.winner={name:p.name,email:p.email};
        m.endedAt=now();
      }
    }

    function endDart(m){
      m.dartInTurn += 1;
      if(m.dartInTurn>=3){
        m.dartInTurn=0;
        m.turnIndex = (m.turnIndex+1) % m.players.length;
      }
    }

    function addThrow(m, wasHit){
      if(!m || m.finished) return;
      const p=m.players[m.turnIndex];

      p.dartsThrown += 1;

      if(wasHit){
        p.hits += 1;
        p.progressIndex += 1;
        finishIfDone(m,p);
        if(m.finished) return;
      }

      endDart(m);
    }

    async function saveFinish(ctx){
      const m=ctx.match;
      if(!m.finished || m._saved) return;
      m._saved=true;

      const winnerName=(m.winner && m.winner.name) || "Unknown";
      const winnerRow=m.players.find(x=>x.email===(m.winner && m.winner.email));
      const winnerDarts=winnerRow ? winnerRow.dartsThrown : null;

      const summary = `üèÅ ${winnerName} wins ‚Ä¢ Format: ${modeName(m)}${winnerDarts!=null?` ‚Ä¢ ${winnerDarts} darts`:``}`;

      await saveHistoryEntry({
        gameId:"around",
        gameName:"Around the World",
        startedAt:m.startedAt,
        endedAt:m.endedAt,
        players:m.players.map(p=>p.email),
        summary,
        meta:{
          mode:m.mode,
          winnerEmail:(m.winner && m.winner.email) || null,
          darts:m.players.map(p=>({email:p.email, dartsThrown:p.dartsThrown, hits:p.hits}))
        }
      });

      const stats=await getStatsDoc(ctx.meUser.email);
      const games=stats.games||{};
      const g=games.around||{};
      const played=(g.played||0)+1;

      const meRow=m.players.find(p=>p.email===ctx.meUser.email);
      const myDarts=meRow?meRow.dartsThrown:0;
      const myHits=meRow?meRow.hits:0;

      const wins=(g.wins||0) + ((((m.winner && m.winner.email)===ctx.meUser.email)) ? 1 : 0);
      const totalDarts=(g.totalDarts||0)+myDarts;
      const totalHits=(g.totalHits||0)+myHits;

      let bestFewestDarts = g.bestFewestDarts||null;
      if(((m.winner && m.winner.email)===ctx.meUser.email)){
        if(bestFewestDarts==null || myDarts<bestFewestDarts) bestFewestDarts=myDarts;
      }

      await saveStatsDoc(ctx.meUser.email,{
        games:{
          ...games,
          around:{
            ...g,
            played,
            wins,
            totalDarts,
            totalHits,
            bestFewestDarts,
            lastPlayedAt:m.endedAt||now()
          }
        },
        updatedAt:now()
      });
    }

    function renderPlay(ctx){
      const m=ctx.match;
      const active=m.players[m.turnIndex];
      const t=currentTarget(m, active);
      const tLabel = (t==="B" ? "BULL" : String(t));

      const isFinished = !!m.finished;

      const statusLine = isFinished
        ? `Winner: <b>${esc((m.winner && m.winner.name) || "")}</b> ‚Ä¢ Format: <b>${esc(modeName(m))}</b>`
        : `Target: <span class="targetFlash">${esc(tLabel)}</span> ‚Ä¢ Format: <b>${esc(modeName(m))}</b> ‚Ä¢ Dart <b>${m.dartInTurn+1}</b>/3`;

      const rows = m.players.map(p=>{
        const ct=currentTarget(m,p);
        const lbl=(ct==="B"?"BULL":String(ct));
        const acc = p.dartsThrown ? Math.round((p.hits/p.dartsThrown)*100) : 0;
        const isAct = p.email===active.email && !isFinished;
        return `
          <tr>
            <td class="l">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <div>
                  <div style="font-size:16px;font-weight:1000">${esc(p.name)}${isAct?` <span class="badge">TURN</span>`:""}</div>
                  <div class="small">Current target: <b>${esc(lbl)}</b></div>
                </div>
                <div style="text-align:right">
                  <div class="small"><b>${esc(p.hits)}</b> hits / <b>${esc(p.dartsThrown)}</b> darts</div>
                  <div class="small">Accuracy: <b>${esc(acc)}%</b></div>
                </div>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      return `
        <div class="card">
          <div class="row">
            <button class="btn ghost" id="backToSetup">Back</button>
            <button class="btn danger" id="resetBtn">Reset</button>
          </div>
        </div>

        <div class="card ${isFinished?"":"leaderGlow"}" style="${isFinished?"animation:none":""}">
          <div class="headerStack">
            <div class="headerTopRow">
              <div class="left"><span class="pill">Around the World</span></div>
              <div class="right">
                ${isFinished?'<span class="pill">Ended</span>':'<span class="pill" data-live="1">Live</span>'}
              </div>
            </div>
            <div class="headerIcon">üåç</div>
            <div class="headerTitle turnTitle3d">Around the World</div>
            <div class="turnNameBox" id="turnNameBox">${turnNameHTML((m.players[m.turnIndex] && m.players[m.turnIndex].name)||"")}</div>
            ${isFinished?'':'<div class="small" style="text-align:center"><span class="badge">NOW THROWING</span></div>'}
            <div class="sub" style="text-align:center;margin-top:6px">${statusLine}</div>
          </div>

          <div class="divider"></div>
          <div class="boardBox">${dartboardSVG(t==="B"?"B":t)}</div>
          ${playerStripHTML(m.players, m.turnIndex, (p)=>"Target: <b>"+esc((currentTarget(m,p)==="B")?"BULL":currentTarget(m,p))+"</b>")}
          <div class="divider"></div>

          ${isFinished ? "" : `
            <div class="hitRow">
              <button class="hitBtn" id="hitBtn" type="button">HIT</button>
              <button class="hitBtn miss3" id="missBtn" type="button">MISS</button>
              <button class="hitBtn undo3" id="undoBtn" type="button">UNDO</button>
            </div>
          `}
        </div>

        <div class="card">
          <div class="pill">Players</div>
          <div class="divider"></div>
          <div class="tableWrap">
            <table>
              <thead><tr><th>Progress</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>
      `;
    }

    function bindPlay(ctx){
      try{ animateTurnName("around", ctx.match.players[ctx.match.turnIndex].name); }catch{}
      const $=(id)=>document.getElementById(id);
      const m=ctx.match;
      if(!m) return;

      const backBtn=$("backToSetup"); if(backBtn) backBtn.onclick=()=>{
        match=null;
        screen="game.setup";
        render();
      };
      const resetBtn=$("resetBtn"); if(resetBtn) resetBtn.onclick=()=>{
        const pls=m.players.map(p=>({name:p.name,email:p.email}));
        match=AroundGame.initMatch(pls, m.mode);
        render();
      };

      if(m.finished){
        saveFinish(ctx).catch(e=>showFatal("Save error", (e && e.message) || String(e)));
        return;
      }

      const undoBtn=document.getElementById("undoBtn");
      if(undoBtn){
        undoBtn.onclick=()=>{ match=popSnap(ctx.match); render(); };
      }

      const hitBtn=$("hitBtn"); if(hitBtn) hitBtn.onclick=()=>{ playBeep("hit");
        if(m.finished) return;
        pushSnap(m);
        addThrow(m,true);
        if(m.finished && !m._winShown){ m._winShown=true; playBeep("win"); showWinOverlay("üèÜ Winner!", ((m.winner && m.winner.name)||(m.players[m.turnIndex] && m.players[m.turnIndex].name)||"")); }
        render();
        saveFinish(ctx).catch(e=>showFatal("Save error", (e && e.message) || String(e)));
      };
      const missBtn=$("missBtn"); if(missBtn) missBtn.addEventListener("click", ()=>{ playBeep("miss");
        if(m.finished) return;
        pushSnap(m);
        addThrow(m,false);
        if(m.finished && !m._winShown){ m._winShown=true; playBeep("win"); showWinOverlay("üèÜ Winner!", ((m.winner && m.winner.name)||(m.players[m.turnIndex] && m.players[m.turnIndex].name)||"")); }
        render();
        saveFinish(ctx).catch(e=>showFatal("Save error", (e && e.message) || String(e)));
      });
    }

    return { initMatch, renderPlay, bindPlay };
  })();

  let toastMsg="";
  let screen="auth";
  let meUser=null;
  let activeGameId=null;
  let match=null;
  let statsViewerEmail=null;
  let rulesGameId=null;
  const MAX_PLAYERS=4;

  // ===== Presence (offline: disabled) =====

  function initials(name){
    const n=String(name||"").trim();
    if(!n) return "?";
    const parts=n.split(/\s+/).filter(Boolean);
    const a=((parts[0] && parts[0][0]) || "").toUpperCase();
    const b=((parts[1] && parts[1][0]) || "").toUpperCase();
    return (a+(b||"")).slice(0,2) || a || "?";
  }

  function rulesFor(gameId){
    if(gameId==="shanghai") return {
      title:"Shanghai",
      icon:"üéØ",
      bullets:[
        "Players take turns. Each turn is 3 darts.",
        "Targets go: 20, 19, 18, 17, 16, 15, then BULL.",
        "Score per dart: SINGLE=1, DOUBLE=2, TRIPLE=3, MISS=0.",
        "After everyone throws 3 darts, the target advances.",
        "Game ends after BULL round. Highest total points wins."
      ]
    };
    if(gameId==="killer") return {
      title:"Killer",
      icon:"üî•",
      bullets:[
        "Setup: each player claims a unique number (1‚Äì20).",
        "Start with 3 lives (‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è).",
        "On your turn you throw 3 darts.",
        "Hit YOUR number as a DOUBLE to become a KILLER (üî•).",
        "Once you‚Äôre a killer: you can ‚Äòattack‚Äô by hitting an opponent‚Äôs number as a DOUBLE.",
        "When you hit an opponent‚Äôs double: tap their attack button to remove 1 life.",
        "If a player reaches 0 lives, they are OUT.",
        "Last player alive wins."
      ]
    };
    if(gameId==="around") return {
      title:"Around the World",
      icon:"üåç",
      bullets:[
        "Before starting, choose a mode: Singles, Doubles, or Triples.",
        "Players take turns. Each turn is 3 darts.",
        "Your goal is to hit your current target number, starting at 1 and going up to 20, then BULL.",
        "Tap HIT if you hit the current target (Singles / Doubles / Triples based on format).",
        "Tap MISS if you miss the current target.",
        "Each HIT advances you to the next target immediately (you can advance up to 3 targets in one turn).",
        "Game ends immediately when someone hits BULL and finishes."
      ]
    };

    const g=getGame(gameId);
    return {
      title:(g && g.name) || "Game",
      icon:(g && g.icon) || "üéØ",
      bullets:["Rules coming soon."]
    };
  }

  async function renderAuth(){
    signOutBtn.style.display="none";
    brandTitle.textContent="Game Night";

    let html = `${toastMsg?`<div class="toast">${esc(toastMsg)}</div>`:""}`;
    toastMsg="";

    html += `
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft">
            <div class="logoMark"><span>üéØ</span></div>
          </div>

          <div class="heroMain" style="text-align:left;align-items:flex-start">
            <div class="h1">Game Night</div>
            <div class="sub">Sign in with your email. Your stats and history stay with your account.</div>
          </div>

          <div class="heroCornerRight">
            <span class="pill">Darts</span>
          </div>
        </div>
        <div class="divider"></div>
        <div class="sub">Tip: if you ever see a blank screen, hit <span class="kbd">Retry</span> on the error card.</div>
      </div>

      <div class="card">
        <label>Email</label>
        <div class="stack">
          <input id="inEmail" type="email" placeholder="you@email.com" autocomplete="email"/>
          <button class="btn ok" id="goBtn">Enter</button>
        </div>
      </div>
    `;
    setHTML(html);

    document.getElementById("goBtn").onclick=async()=>{
      const e=normEmail(document.getElementById("inEmail").value);
      if(!e){ toastMsg="Enter a valid email."; return render(); }

      const player=await signInEmail(e);
      if(player){
        meUser=player;
        statsViewerEmail=meUser.email;
        screen="home";
        return render();
      }
      meUser={email:e};
      screen="signup";
      return render();
    };
  }

  async function renderSignup(){
    signOutBtn.style.display="none";
    brandTitle.textContent="Game Night";

    setHTML(`
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft">
            <div class="logoMark"><span>üßæ</span></div>
          </div>

          <div class="heroMain">
            <div class="h1">Create Player</div>
            <div class="sub">Just your name ‚Äî you‚Äôre in.</div>
          </div>

          <div class="heroCornerRight"></div>
        </div>
      </div>

      <div class="card">
        <label>Name</label>
        <div class="stack">
          <input id="upName" type="text" placeholder="Your Name" autocomplete="name"/>
          <button class="btn ok" id="createBtn">Create</button>
          <button class="btn ghost" id="backBtn">Back</button>
        </div>
      </div>
    `);
    document.getElementById("backBtn").onclick=()=>{ meUser=null; screen="auth"; render(); };

    document.getElementById("createBtn").onclick=async()=>{
      const n=String(document.getElementById("upName").value).trim();
      if(!n){ toastMsg="Enter your name."; return render(); }
      meUser=await signUpEmail(n, meUser.email);
      statsViewerEmail=meUser.email;
      screen="home";
      render();
    };
  }

  async function renderHome(){
    signOutBtn.style.display="inline-block";
    brandTitle.textContent="Game Night";

    const players=await getPlayers();
    try{ subscribePresence(players.map(p=>p.email).concat([meUser.email])); }catch{}

    const gameCards = Games.map(g=>{
      const soon=!g.active;
      return `
        <div class="gameCard ${soon?"":"leaderGlow"}" style="${soon?"animation:none":""}">
          <div class="gameHead">
            <div class="gameTitle">
              <div class="gameIcon">${esc(g.icon||"üéØ")}</div>
              <div>
                <div class="h1" style="font-size:18px;margin:0">${esc(g.name)}</div>
                <div class="gameMeta">${esc(g.tagline||"")}</div>
              </div>
            </div>
            <div>${soon?`<span class="pill soon">Coming soon</span>`:`<span class="pill" data-live="1">Active</span>`}</div>
          </div>
          <div class="gameActions">
            <button class="btn ok" data-play="${esc(g.id)}" ${soon?"disabled":""}>Play</button>
            <button class="btn ghost" data-stats="${esc(g.id)}">Stats</button>
          </div>
        </div>
      `;
    }).join("");

    const roster = players
      .slice()
      .sort((a,b)=> (a.email===meUser.email?-1:0) - (b.email===meUser.email?-1:0))
      .map(p=>`
        <div class="rosterCard">
          <div class="rosterLeft">
            <div class="avatar ${isOnline(p.email)?"online":""}">${esc(initials(p.name))}</div>
            <div>
              <div class="rosterName">${esc(p.name)}${p.email===meUser.email?` <span class="badge">YOU</span>`:""}</div>
              <div class="rosterSub">${esc(p.email)}</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap">
            <button class="btn ghost" data-view-player="${esc(p.email)}">View stats</button>
            <button class="btn danger" data-del-player="${esc(p.email)}" ${p.email===meUser.email?"disabled":""}>Remove</button>
          </div>
        </div>
      `).join("");

    setHTML(`
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft">
            <div class="logoMark"><span>üë§</span></div>
          </div>

          <div class="heroMain" style="text-align:left;align-items:flex-start">
            <div class="h1">${esc(meUser.name||"Player")}</div>
            <div class="sub">${esc(meUser.email)}</div>
          </div>

          <div class="heroCornerRight">
            <span class="pill" data-live="1">Signed in</span>
          </div>
        </div>
      </div>

      <div class="row">
        <button class="btn ghost" id="rulesBtn">Game rules</button>
        <button class="btn ghost" id="statsBtn">Stats</button>
        <button class="btn ghost" id="historyBtn">History</button>
      </div>

      <div class="divider"></div>

      <div class="gameGrid">${gameCards}</div>

      <div class="divider"></div>

      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft">
            <div class="logoMark"><span>üë•</span></div>
          </div>

          <div class="heroMain" style="text-align:center;align-items:center">
            <div class="h1">Players</div>
            <div class="sub">Tap ‚ÄúView stats‚Äù to see someone‚Äôs game stats.</div>
          </div>

          <div class="heroCornerRight"></div>
        </div>
        <div class="divider"></div>
        <div class="rosterGrid">${roster || `<div class="sub">No other players yet.</div>`}</div>
      </div>
    `);

    document.getElementById("rulesBtn").onclick=()=>{ screen="rules"; render(); };
    document.getElementById("statsBtn").onclick=()=>{ screen="stats"; render(); };
    document.getElementById("historyBtn").onclick=()=>{ screen="history"; render(); };

    appEl.querySelectorAll("button[data-play]").forEach(btn=>{
      btn.onclick=()=>{
        activeGameId=btn.getAttribute("data-play");
        match=null;
        screen="game.setup";
        render();
      };
    });

    appEl.querySelectorAll("button[data-stats]").forEach(btn=>{
      btn.onclick=()=>{
        activeGameId=btn.getAttribute("data-stats");
        screen="stats.game";
        render();
      };
    });

    appEl.querySelectorAll("button[data-view-player]").forEach(btn=>{
      btn.onclick=()=>{
        statsViewerEmail=btn.getAttribute("data-view-player");
        screen="stats";
        render();
      };
    });

    appEl.querySelectorAll("button[data-del-player]").forEach(btn=>{
      btn.onclick=async()=>{
        const email=btn.getAttribute("data-del-player");
        const p=players.find(x=>x.email===email);
        const name=(p && p.name) || email;
        if(!confirm(`Remove ${name}? This deletes the player, their stats, and their history.`)) return;
        try{
          await deletePlayerAndData(email);
          if(normEmail(email)===normEmail(meUser.email)){
            meUser=null; match=null; activeGameId=null; statsViewerEmail=null; rulesGameId=null; screen="auth";
            return render();
          }
          toastMsg=`Removed ${name}.`;
          render();
        }catch(e){
          showFatal("Delete error", (e && e.message) || String(e));
        }
      };
    });
  }

  async function renderRules(){
    signOutBtn.style.display="inline-block";
    brandTitle.textContent="Game rules";

    setHTML(`
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft">
            <div class="logoMark"><span>üìú</span></div>
          </div>

          <div class="heroMain">
            <div class="h1">Game rules</div>
            <div class="sub">Pick a game to see how to play.</div>
          </div>

          <div class="heroCornerRight"></div>
        </div>
        <div class="divider"></div>
        ${Games.map(g=>`
          <div class="rosterCard ${g.active?"leaderGlow":""}">
            <div class="rosterLeft">
              <div class="avatar">${esc(g.icon||"üéØ")}</div>
              <div>
                <div class="rosterName">${esc(g.name)}</div>
                <div class="rosterSub">${esc(g.active?"Active":"Coming soon")}</div>
              </div>
            </div>
            <button class="btn ${g.active? "ok":"ghost"}" data-rule="${esc(g.id)}" ${g.active?"":"disabled"}>Open</button>
          </div>
        `).join("")}
        <div class="divider"></div>
        <button class="btn ghost" id="rulesBack">Back</button>
      </div>
    `);
    document.getElementById("rulesBack").onclick=()=>{ screen="home"; render(); };
    appEl.querySelectorAll("button[data-rule]").forEach(btn=>{
      btn.onclick=()=>{
        rulesGameId=btn.getAttribute("data-rule");
        screen="rules.game";
        render();
      };
    });
  }

  async function renderRulesGame(){
    signOutBtn.style.display="inline-block";
    const r=rulesFor(rulesGameId);
    brandTitle.textContent=`${r.title} ‚Ä¢ Rules`;

    setHTML(`
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft">
            <div class="logoMark"><span>${esc(r.icon)}</span></div>
          </div>

          <div class="heroMain">
            <div class="h1">${esc(r.title)}</div>
            <div class="sub">How to play</div>
          </div>

          <div class="heroCornerRight"></div>
        </div>
        <div class="divider"></div>
        <ul style="margin:0;padding-left:18px;line-height:1.5">
          ${r.bullets.map(b=>`<li style="margin:10px 0">${esc(b)}</li>`).join("")}
        </ul>
        <div class="divider"></div>
        <button class="btn ghost" id="rulesGameBack">Back</button>
      </div>
    `);
    document.getElementById("rulesGameBack").onclick=()=>{ screen="rules"; render(); };
  }

  async function renderGameSetup(){
    const g=getGame(activeGameId);
    if(!g){ screen="home"; return render(); }

    signOutBtn.style.display="inline-block";
    brandTitle.textContent=g.name;

    const players=await getPlayers();
    try{ subscribePresence(players.map(p=>p.email).concat([meUser.email])); }catch{}
    const meEmail=meUser.email;
    const defaultCount=Math.max(1, Math.min(2, players.length||1));

    const aroundModeUI = (activeGameId==="around" && g.active) ? `
      <div class="divider"></div>
      <label>Format (Singles / Doubles / Triples)</label>
      <select id="aroundMode">
        <option value="S" selected>Singles</option>
        <option value="D">Doubles</option>
        <option value="T">Triples</option>
      </select>
      <div class="small">Pick the format before starting.</div>
    ` : "";

    const defaultHeroMain = `
          <div class="heroMain">
            <div class="h1">${esc(g.name)}</div>
            <div class="sub">Choose players (max ${MAX_PLAYERS}). Select exactly the number you choose.</div>
          </div>
    `;

    const aroundHeroMain = `
          <div class="heroMain" style="text-align:center;align-items:center">
            <div class="h1" style="font-size:clamp(22px,6.2vw,32px);margin:0;white-space:nowrap;letter-spacing:.4px">Around the World</div>
            <div class="sub" style="margin-top:6px;text-align:center">Choose players (max 4). Select exactly the number you choose.</div>
          </div>
        `;

    const setupHeroMain = (activeGameId==="around") ? aroundHeroMain : defaultHeroMain;
    const setupLeftBadge = (activeGameId==="around") ? `<span class="pill">Setup</span>` : `<span class="kbd">${esc(g.name)}</span>`;

    setHTML(`
      <div class="card"><div class="row"><button class="btn ghost" id="setupBack">Back</button></div></div>

      <div class="card">
        <div class="hero ${activeGameId==="around"?"awSetupHero":""}">
          <div class="heroCornerLeft">
            <div class="logoMark"><span>${esc(g.icon || "üéØ")}</span></div>
            ${setupLeftBadge}
          </div>

          ${setupHeroMain}

          <div class="heroCornerRight">
            ${g.active?`<span class="pill" data-live="1">Ready</span>`:`<span class="pill soon">Coming soon</span>`}
          </div>
        </div>
      </div>

      <div class="card">
        <div class="stack">
          <div class="row">
            <div>
              <label>Number of players</label>
              <select id="playerCount">
                ${Array.from({length:Math.min(MAX_PLAYERS, Math.max(1, players.length||1))},(_,i)=>i+1).map(n=>`<option value="${n}" ${n===defaultCount?"selected":""}>${n}</option>`).join("")}
              </select>
            </div>
            <div>
              <label>Selected</label>
              <input id="selectedCount" type="text" value="0 / ${defaultCount}" disabled />
            </div>
          </div>

          <label>Pick players</label>
          <select id="matchPlayers" multiple size="6">
            ${players.map(p=>`<option value="${esc(p.email)}">${esc(p.name)}</option>`).join("")}
          </select>

          ${aroundModeUI}

          <button class="btn ok" id="startMatchBtn" disabled>Start Match</button>
          <div class="sub" id="hintLine">Select exactly ${defaultCount} players to continue.</div>
        </div>
      </div>
    `);

    const selectEl=document.getElementById("matchPlayers");
    Array.from(selectEl.options).forEach(o=>{ if(o.value===meEmail) o.selected=true; });

    function updateStartState(){
      const n=parseInt(document.getElementById("playerCount").value,10);
      const selectedEmails=Array.from(selectEl.selectedOptions).map(o=>o.value);
      document.getElementById("selectedCount").value=`${selectedEmails.length} / ${n}`;
      const ok=(selectedEmails.length===n) && !!g.active;
      document.getElementById("startMatchBtn").disabled=!ok;
      document.getElementById("hintLine").textContent=
        !g.active ? "This game is coming soon." :
        ok ? "Ready." : `Select exactly ${n} players to continue.`;
    }
    document.getElementById("playerCount").onchange=updateStartState;
    selectEl.onchange=updateStartState;
    updateStartState();

    document.getElementById("setupBack").onclick=()=>{ activeGameId=null; match=null; screen="home"; render(); };

    document.getElementById("startMatchBtn").onclick=()=>{
      if(!g.active){ toastMsg="Coming soon."; return render(); }
      const n=parseInt(document.getElementById("playerCount").value,10);
      const selectedEmails=Array.from(selectEl.selectedOptions).map(o=>o.value);
      if(selectedEmails.length!==n){ toastMsg=`You must select exactly ${n} players.`; return render(); }
      const selectedPlayers=selectedEmails.map(e=>players.find(p=>p.email===e)).filter(Boolean);

      if(activeGameId==="shanghai"){
        match=ShanghaiGame.initMatch(selectedPlayers);
        screen="game.play";
        return render();
      }
      if(activeGameId==="killer"){
        match=KillerGame.initMatch(selectedPlayers);
        screen="game.play";
        return render();
      }
      if(activeGameId==="around"){
        const modeEl=document.getElementById("aroundMode");
        const mode=modeEl ? modeEl.value : "S";
        match=AroundGame.initMatch(selectedPlayers, mode);
        screen="game.play";
        return render();
      }
      toastMsg="Coming soon.";
      render();
    };
  }

  async function renderGamePlay(){
    const g=getGame(activeGameId);
    if(!g || !match){ screen="home"; return render(); }

    signOutBtn.style.display="inline-block";
    brandTitle.textContent=g.name;

    if(activeGameId==="shanghai"){
      const ctx={meUser, match};
      setHTML(ShanghaiGame.renderPlay(ctx));
      ShanghaiGame.bindPlay(ctx);
      return;
    }

    if(activeGameId==="killer"){
      const ctx={meUser, match};
      setHTML(KillerGame.renderPlay(ctx));
      KillerGame.bindPlay(ctx);
      return;
    }

    if(activeGameId==="around"){
      const ctx={meUser, match};
      setHTML(AroundGame.renderPlay(ctx));
      AroundGame.bindPlay(ctx);
      return;
    }

    screen="home"; render();
  }

  async function renderStats(){
    signOutBtn.style.display="inline-block";
    brandTitle.textContent="Stats";

    const players=await getPlayers();
    try{ subscribePresence(players.map(p=>p.email).concat([meUser.email])); }catch{}
    if(!statsViewerEmail) statsViewerEmail=meUser.email;

    const statsDoc=await getStatsDoc(statsViewerEmail);
    const games=statsDoc.games||{};
    const viewer=players.find(p=>p.email===statsViewerEmail)||meUser;

    function aroundLine(gs){
      const played=gs.played||0;
      const wins=gs.wins||0;
      const td=gs.totalDarts||0;
      const th=gs.totalHits||0;
      const acc=td?Math.round((th/td)*100):0;
      const best=gs.bestFewestDarts!=null?gs.bestFewestDarts:"‚Äî";
      return `Played: <b>${played}</b> ‚Ä¢ Wins: <b>${wins}</b> ‚Ä¢ Accuracy: <b>${acc}%</b> ‚Ä¢ Best: <b>${esc(best)}</b>`;
    }

    setHTML(`
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft">
            <div class="logoMark"><span>üìà</span></div>
          </div>

          <div class="heroMain">
            <div class="h1">Stats</div>
            <div class="sub">Pick a player, then pick a game.</div>
          </div>

          <div class="heroCornerRight"></div>
        </div>
        <div class="divider"></div>
        <label>Player</label>
        <select id="statsPlayer">
          ${players.map(p=>`<option value="${esc(p.email)}" ${p.email===statsViewerEmail?"selected":""}>${esc(p.name)}</option>`).join("")}
        </select>
        <div class="small">Viewing: <b>${esc(viewer.name||"Player")}</b></div>
        <div class="divider"></div>
        <div class="row">
          <button class="btn danger" id="resetAllStatsBtn">Reset stats</button>
          <button class="btn danger" id="deletePlayerBtn">Delete player</button>
        </div>
        <div class="small">Reset clears this player‚Äôs stats. Delete removes the player + stats + history.</div>
      </div>

      ${Games.map(g=>{
        const gs=games[g.id]||{};
        const played=gs.played||0;
        const line =
          g.id==="shanghai"
            ? `Played: <b>${played}</b> ‚Ä¢ Best: <b>${esc(gs.best||0)}</b> ‚Ä¢ Points: <b>${esc(gs.points||0)}</b>`
          : g.id==="killer"
            ? `Played: <b>${played}</b> ‚Ä¢ Wins: <b>${esc(gs.wins||0)}</b>`
          : g.id==="around"
            ? aroundLine(gs)
          : (g.active ? `Played: <b>${played}</b>` : `Coming soon`);
        return `
          <div class="gameCard">
            <div class="gameHead">
              <div class="gameTitle">
                <div class="gameIcon">${esc(g.icon||"üéØ")}</div>
                <div>
                  <div class="h1" style="font-size:18px;margin:0">${esc(g.name)}</div>
                  <div class="gameMeta">${line}</div>
                </div>
              </div>
              <button class="btn" data-open="${esc(g.id)}">Open</button>
            </div>
          </div>
        `;
      }).join("")}

      <div class="row">
        <button class="btn ghost" id="statsBack">Back</button>
      </div>
    `);

    document.getElementById("statsBack").onclick=()=>{ screen="home"; render(); };
    document.getElementById("statsPlayer").onchange=(e)=>{ statsViewerEmail=e.target.value; render(); };

    document.getElementById("resetAllStatsBtn").onclick=async()=>{
      const email=statsViewerEmail;
      const p=players.find(x=>x.email===email);
      const name=(p && p.name) || email;
      if(!confirm(`Reset ALL stats for ${name}?`)) return;
      try{
        await resetStatsAll(email);
        toastMsg=`Stats reset for ${name}.`;
        render();
      }catch(e){
        showFatal("Reset error", (e && e.message) || String(e));
      }
    };

    document.getElementById("deletePlayerBtn").onclick=async()=>{
      const email=statsViewerEmail;
      const p=players.find(x=>x.email===email);
      const name=(p && p.name) || email;
      if(!confirm(`Delete ${name}? This deletes the player, their stats, and their history.`)) return;
      try{
        await deletePlayerAndData(email);
        if(normEmail(email)===normEmail(meUser.email)){
          meUser=null; match=null; activeGameId=null; statsViewerEmail=null; rulesGameId=null; screen="auth";
          return render();
        }
        statsViewerEmail=meUser.email;
        toastMsg=`Deleted ${name}.`;
        screen="home";
        render();
      }catch(e){
        showFatal("Delete error", (e && e.message) || String(e));
      }
    };

    appEl.querySelectorAll("button[data-open]").forEach(btn=>{
      btn.onclick=()=>{ activeGameId=btn.getAttribute("data-open"); screen="stats.game"; render(); };
    });
  }

  async function renderStatsGame(){
    const g=getGame(activeGameId);
    if(!g){ screen="stats"; return render(); }

    signOutBtn.style.display="inline-block";
    brandTitle.textContent=`${g.name} ‚Ä¢ Stats`;

    const players=await getPlayers();
    try{ subscribePresence(players.map(p=>p.email).concat([meUser.email])); }catch{}
    if(!statsViewerEmail) statsViewerEmail=meUser.email;

    const viewer=players.find(p=>p.email===statsViewerEmail)||meUser;
    const statsDoc=await getStatsDoc(statsViewerEmail);
    const gs=(statsDoc.games||{})[g.id]||{};

    let body="";
    if(g.id==="shanghai"){
      body=`
        <div class="sub">Played: <b>${esc(gs.played||0)}</b></div>
        <div class="sub">Points: <b>${esc(gs.points||0)}</b></div>
        <div class="sub">Best game: <b>${esc(gs.best||0)}</b></div>
        <div class="sub">Last played: <b>${esc(gs.lastPlayedAt?fmt(gs.lastPlayedAt):"‚Äî")}</b></div>
      `;
    }else if(g.id==="killer"){
      body=`
        <div class="sub">Played: <b>${esc(gs.played||0)}</b></div>
        <div class="sub">Wins: <b>${esc(gs.wins||0)}</b></div>
        <div class="sub">Last played: <b>${esc(gs.lastPlayedAt?fmt(gs.lastPlayedAt):"‚Äî")}</b></div>
      `;
    }else if(g.id==="around"){
      const played=gs.played||0;
      const wins=gs.wins||0;
      const td=gs.totalDarts||0;
      const th=gs.totalHits||0;
      const acc=td?Math.round((th/td)*100):0;
      const best=gs.bestFewestDarts!=null?gs.bestFewestDarts:"‚Äî";
      body=`
        <div class="sub">Played: <b>${esc(played)}</b></div>
        <div class="sub">Wins: <b>${esc(wins)}</b></div>
        <div class="sub">Total darts: <b>${esc(td)}</b></div>
        <div class="sub">Total hits: <b>${esc(th)}</b></div>
        <div class="sub">Accuracy: <b>${esc(acc)}%</b></div>
        <div class="sub">Best (fewest darts to win): <b>${esc(best)}</b></div>
        <div class="sub">Last played: <b>${esc(gs.lastPlayedAt?fmt(gs.lastPlayedAt):"‚Äî")}</b></div>
      `;
    }else{
      body=g.active?`<div class="sub">Played: <b>${esc(gs.played||0)}</b></div>`:`<div class="sub">Coming soon.</div>`;
    }

    setHTML(`
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft">
            <div class="logoMark"><span>${esc(g.icon||"üéØ")}</span></div>
            <span class="kbd">${esc(g.name)}</span>
          </div>

          <div class="heroMain">
            <div class="h1 titleOneLine">${esc(g.name)}</div>
            <div class="sub">Player: <b>${esc(viewer.name||"Player")}</b></div>
          </div>

          <div class="heroCornerRight"></div>
        </div>
        <div class="divider"></div>
        ${body}
        <div class="divider"></div>
        <div class="row">
          <button class="btn danger" id="resetGameStatsBtn">Reset this game</button>
          <button class="btn ghost" id="statsGameBack">Back</button>
        </div>
      </div>
    `);

    const resetBtn=document.getElementById("resetGameStatsBtn");
    if(resetBtn){
      resetBtn.onclick=async()=>{
        const email=statsViewerEmail;
        const p=players.find(x=>x.email===email);
        const name=(p && p.name) || email;
        if(!confirm(`Reset ${g.name} stats for ${name}?`)) return;
        try{
          await resetStatsGame(email, g.id);
          toastMsg=`${g.name} stats reset for ${name}.`;
          render();
        }catch(e){
          showFatal("Reset error", (e && e.message) || String(e));
        }
      };
    }

    document.getElementById("statsGameBack").onclick=()=>{ screen="stats"; render(); };
  }

  async function renderHistory(){
    signOutBtn.style.display="inline-block";
    brandTitle.textContent="History";

    const history=await getHistory(meUser.email);
    let items=history.map(h=>`
      <div class="card">
        <div class="h1" style="font-size:16px;margin:0">${esc(h.summary||"(no summary)")}</div>
        <div class="sub">${esc(h.gameName||h.gameId||"Game")} ‚Ä¢ ${esc(h.endedAt?fmt(h.endedAt):"")}</div>
      </div>
    `).join("");
    if(!items) items=`<div class="card"><div class="sub">No matches yet.</div></div>`;

    setHTML(`
      <div class="row">
        <button class="btn ghost" id="historyBack">Back</button>
        <button class="btn danger" id="clearHistoryBtn">Clear my history</button>
      </div>
      <div class="small">Clears match history for your account on this device. Does not delete your player or stats.</div>
      <div class="divider"></div>
      ${items}
    `);

    document.getElementById("historyBack").onclick=()=>{ screen="home"; render(); };
    const clearBtn=document.getElementById("clearHistoryBtn");
    if(clearBtn){
      clearBtn.onclick=async()=>{
        if(!confirm("Clear your match history on this device?")) return;
        try{ await deleteHistoryForPlayer(meUser.email); toastMsg="History cleared."; render(); }
        catch(e){ showFatal("Clear history error", e?.message||String(e)); }
      };
    }
  }

  async function render(){
    if(window.__rendering){ window.__renderAgain=true; return; }
    window.__rendering=true;
    try{
      window.__screenChanged = (window.__lastScreen !== screen);
      window.__lastScreen = screen;

      homeBtn.onclick=()=>{ screen=meUser?"home":"auth"; render(); };

      if(soundBtn){
        soundBtn.onclick=()=>{
          // Always unlock + make toggle audible (even when currently OFF)
          try{ unlockAudio(); }catch(_){}
          const wasOn = !!soundEnabled;
          if(wasOn) playBeep("toggle");
          setSoundEnabled(!soundEnabled);
          if(!wasOn) playBeep("toggle");
        };
        setSoundEnabled(soundEnabled);
      }

      signOutBtn.onclick=()=>{
        stopPresence();
        meUser=null; match=null; activeGameId=null; statsViewerEmail=null; rulesGameId=null;
        screen="auth"; render();
      };

      if(screen==="auth") return renderAuth();
      if(screen==="signup") return renderSignup();
      if(!meUser){ screen="auth"; return renderAuth(); }

      try{ startPresence(meUser.email); }catch{}

      if(screen==="home") return renderHome();
      if(screen==="rules") return renderRules();
      if(screen==="rules.game") return renderRulesGame();
      if(screen==="game.setup") return renderGameSetup();
      if(screen==="game.play") return renderGamePlay();
      if(screen==="stats") return renderStats();
      if(screen==="stats.game") return renderStatsGame();
      if(screen==="history") return renderHistory();

      screen="home"; return renderHome();
    }catch(e){
      showFatal("App error", (e && e.message) || String(e));
    }
    finally{
      window.__rendering=false;
      window.__renderReason="nav";
      if(window.__renderAgain){ window.__renderAgain=false; render(); }
    }
  }

  render();
}

function playerStripHTML(players, activeIndex, extraLineFn){
  try{
    return `<div class="playerStrip">` + (players||[]).map((p,i)=>{
      const act = (i===activeIndex);
      const extra = extraLineFn ? (extraLineFn(p,i) || "") : "";
      return `<div class="playerChip ${act?'active':''}">
        <div class="nm">${esc(p.name||"")}</div>
        <div class="sub">${act ? "NOW THROWING" : "&nbsp;"}</div>
        ${extra?`<div class="small" style="margin-top:4px">${extra}</div>`:""}
      </div>`;
    }).join("") + `</div>`;
  }catch(_){ return ""; }
}


boot();

</script>
</body>
</html>
