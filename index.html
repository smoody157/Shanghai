<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Game Night â€¢ Online Shared â€¢ v1</title>

<style>
/* === NOTE ===
   This is the ONLINE, SHARED version.
   Data is stored in Firebase Firestore so multiple devices see the same roster, stats, history, and live matches.
*/
:root{
  --bg:#060814;
  --bg-soft:#0b1020;
  --text:#eef4ff;
  --muted:#9fb0d0;

  --c-cyan:#22d3ee;
  --c-blue:#3b82f6;
  --c-pink:#ec4899;
  --c-green:#22c55e;
  --c-orange:#f97316;
  --c-red:#ef4444;
  --accent:var(--c-cyan);

  --danger:var(--c-red);
  --ok:var(--c-green);

  --glass: rgba(255,255,255,.06);
  --glass2: rgba(255,255,255,.025);
  --shadow: rgba(0,0,0,.45);

  --chrome-border: rgba(255,255,255,.18);
  --chrome-fill: linear-gradient(180deg,
    rgba(255,255,255,.18) 0%,
    rgba(255,255,255,.07) 14%,
    rgba(0,0,0,.22) 36%,
    rgba(255,255,255,.10) 52%,
    rgba(0,0,0,.34) 72%,
    rgba(255,255,255,.14) 100%
  );
  --chrome-text: linear-gradient(135deg,
    rgba(34,211,238,1) 0%,
    rgba(59,130,246,1) 22%,
    rgba(236,72,153,1) 46%,
    rgba(249,115,22,1) 70%,
    rgba(34,197,94,1) 100%
  );
}

*{box-sizing:border-box;}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:linear-gradient(180deg, #040610, var(--bg));
  color:var(--text);
  padding-bottom:56px;
  padding-left: max(0px, env(safe-area-inset-left));
  padding-right: max(0px, env(safe-area-inset-right));
}

.footerLegal{
  position:fixed;
  left:0; right:0; bottom:0;
  z-index:20;
  display:flex;
  justify-content:center;
  padding:10px 12px calc(10px + env(safe-area-inset-bottom));
  pointer-events:none;
  background:linear-gradient(180deg, rgba(6,8,20,0), rgba(6,8,20,.65));
}
.footerLegal .txt{
  font-size:10px;
  letter-spacing:.2px;
  color:rgba(159,176,208,.85);
  text-align:center;
  text-shadow:0 2px 10px rgba(0,0,0,.45);
  max-width:980px;
}

.topbar{
  position:sticky;top:0;z-index:10;
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  padding-top:calc(10px + env(safe-area-inset-top));
  background:var(--bg);
  border-bottom:1px solid rgba(255,255,255,.08);
}
.topActions{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:96px;
}
.topActions.left{justify-content:flex-start}
.topActions.right{justify-content:flex-end}

.brand{
  grid-column:2;
  display:flex;
  flex-direction:column;
  line-height:1.05;
  align-items:center;
  text-align:center;
  max-width:min(540px, 66vw);
}
.brand .t{font-weight:1000;font-size:20px;letter-spacing:.4px; text-shadow:0 2px 14px rgba(0,0,0,.55), 0 0 18px rgba(34,211,238,.10)}
.brand .s{
  font-size:12px;
  color:var(--muted);
  white-space:normal;
  overflow-wrap:anywhere;
}

.wrap{max-width:980px;margin:0 auto;padding:14px}
.card{
  background:linear-gradient(180deg,var(--glass),var(--glass2));
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:14px;
  position:relative;
  box-shadow:0 16px 34px rgba(0,0,0,.42), 0 8px 60px rgba(0,0,0,.28);
  margin-bottom:12px;
}
.card::before{
  content:"";
  position:absolute;
  left:14px; right:14px; bottom:-12px;
  height:22px;
  border-radius:50%;
  background:rgba(0,0,0,.65);
  filter:blur(16px);
  opacity:.42;
  pointer-events:none;
}

.h1{font-size:26px;font-weight:1000;letter-spacing:.4px;margin:2px 0 6px;text-shadow:0 2px 14px rgba(0,0,0,.55)}
.sub{color:var(--muted);font-size:13px}
label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}

input,select{
  width:100%;
  background:rgba(7,10,20,.72);
  border:1px solid rgba(255,255,255,.14);
  color:var(--text);
  border-radius:14px;padding:12px 12px;font-size:16px;outline:none;
}
.row{display:flex;gap:10px;flex-wrap:wrap;}
.row>*{flex:1;min-width:140px}
@media(max-width:420px){ .row > *{ min-width:120px; } }
.stack{display:flex;flex-direction:column;gap:10px}

.toast{
  background:rgba(239,68,68,.12);
  border:1px solid rgba(239,68,68,.30);
  color:#ffd6da;
  border-radius:14px;padding:10px 12px;font-weight:900;margin-bottom:12px;
}

.divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}

.tableWrap{
  overflow:auto;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  width:100%;
  max-width:100%;
  -webkit-overflow-scrolling:touch;
}
.tableWrap table{ width:100%; border-collapse:separate; border-spacing:0; }
.tableWrap th,.tableWrap td{
  padding:10px 10px;
  text-align:center;
  vertical-align:middle;
  font-size:14px;
  overflow:hidden;
  text-overflow:ellipsis;
}
.tableWrap th:first-child,.tableWrap td:first-child{ text-align:left; width:96px; }
.tableWrap thead th{
  position:sticky;
  top:0;
  z-index:2;
  background:rgba(7,10,20,.82);
  backdrop-filter:blur(10px);
}
.tableWrap tbody tr:nth-child(odd) td{ background:rgba(255,255,255,.02); }
.tableWrap td.activeCell{
  outline:2px solid rgba(34,211,238,.22);
  background:rgba(34,211,238,.06);
  border-radius:10px;
}
.small{font-size:12px;color:var(--muted);}

.btn{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
  border-radius:14px;padding:10px 12px;font-weight:900;
  box-shadow:0 6px 16px var(--shadow);
  cursor:pointer;
  position:relative;
}
.btn:active{transform:translateY(1px)}
.btn.ghost{background:transparent;box-shadow:none;color:var(--muted)}
.btn.ok{
  background:linear-gradient(135deg, rgba(34,197,94,.22), rgba(34,211,238,.12)) !important;
  border-color:rgba(34,197,94,.40) !important;
  box-shadow:
    0 10px 22px rgba(0,0,0,.32),
    0 0 34px rgba(34,197,94,.55),
    0 0 70px rgba(34,197,94,.28),
    inset 0 0 26px rgba(34,197,94,.22),
    inset 0 1px 0 rgba(255,255,255,.20),
    inset 0 -12px 18px rgba(0,0,0,.38);
}
.btn.danger{
  background:linear-gradient(135deg, rgba(239,68,68,.22), rgba(249,115,22,.12)) !important;
  border-color:rgba(239,68,68,.42) !important;
}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none}

.btn:not(.ghost):not(.ok):not(.danger),
.hitBtn,.kAttackBtn,.pill,.badge,.kbd{
  background:var(--chrome-fill);
  border:1px solid var(--chrome-border);
  box-shadow:
    0 10px 22px rgba(0,0,0,.32),
    inset 0 1px 0 rgba(255,255,255,.20),
    inset 0 -12px 18px rgba(0,0,0,.38);
  white-space:nowrap;
}
.btn:not(.ghost)::after,
.hitBtn::after,.kAttackBtn::after,.pill::after,.badge::after,.kbd::after{
  content:"";
  position:absolute;
  left:10px; right:10px; top:7px;
  height:38%;
  border-radius:12px;
  background:linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,0));
  pointer-events:none;
  opacity:.85;
}

.pill{
  display:inline-block;padding:6px 10px;border-radius:999px;
  color:var(--text);font-weight:900;font-size:12px;
  position:relative;
}
.pill.soon{background:rgba(255,255,255,.05); color:var(--muted)}
.pill[data-live="1"]{ border-color: rgba(34,211,238,.38); }
.badge{
  display:inline-block;padding:4px 8px;border-radius:999px;
  font-size:12px;font-weight:1000;
  color:var(--text);
  position:relative;
}
.kbd{
  display:inline-block;padding:2px 8px;border-radius:999px;
  color:var(--muted); font-weight:900; font-size:12px;
  position:relative;
}

.h1, .kTurnBig, .brand .t, .rosterName{
  background:var(--chrome-text);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
  background-size: 260% 260%;
  animation: titleShift 7.5s ease-in-out infinite;
  text-shadow:
    0 0 18px rgba(34,211,238,.20),
    0 0 28px rgba(236,72,153,.12),
    0 2px 12px rgba(0,0,0,.55);
}
@keyframes titleShift{
  0%{ background-position: 0% 50%; filter:saturate(1.15) contrast(1.08); }
  50%{ background-position: 100% 50%; filter:saturate(1.35) contrast(1.15); }
  100%{ background-position: 0% 50%; filter:saturate(1.15) contrast(1.08); }
}

.turnTitle3d{
  font-weight:1000;
  letter-spacing:.4px;
  background:linear-gradient(180deg,#ffffff 0%,#d8e2ff 22%,#ffffff 44%,#a8b9de 72%,#ffffff 100%);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
  text-shadow:
    0 1px 0 rgba(255,255,255,.18),
    0 2px 0 rgba(0,0,0,.22),
    0 6px 18px rgba(0,0,0,.55);
  filter:contrast(1.05) saturate(1.05);
}
.gameTitleBig{font-size:34px;font-weight:1000;letter-spacing:.6px;margin:0;white-space:nowrap;background:linear-gradient(180deg,#ffffff 0%,#dfe7ff 20%,#ffffff 42%,#a8b9de 78%,#ffffff 100%);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 1px 0 rgba(255,255,255,.18),0 3px 0 rgba(0,0,0,.25),0 10px 24px rgba(0,0,0,.60);}
.turnNameBig{font-size:40px;font-weight:1000;letter-spacing:.5px;margin:0;background:linear-gradient(180deg,#ffffff 0%,#dfe7ff 22%,#ffffff 44%,#a8b9de 72%,#ffffff 100%);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 1px 0 rgba(255,255,255,.18),0 4px 0 rgba(0,0,0,.26),0 14px 28px rgba(0,0,0,.65);}
@media(max-width:520px){ .gameTitleBig{ font-size:22px; } .turnNameBig{ font-size:28px; } }

.hero{
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  align-items:center;
  gap:12px;
}
.heroMain{
  grid-column:2;
  text-align:center;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  max-width:min(560px, 70vw);
}
.heroCornerLeft{
  grid-column:1;
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:10px;
  min-width:0;
}
.heroCornerRight{
  grid-column:3;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:10px;
  min-width:0;
  white-space:nowrap;
}
@media(max-width:520px){
  .hero{ grid-template-columns: auto 1fr auto; }
  .heroMain{ max-width:100%; }
}

.targetGlow{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  box-shadow:0 0 18px rgba(34,211,238,.40);
}

.thName{
  display:block;
  font-weight:1000;
  line-height:1.05;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  background:var(--chrome-text);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
  text-shadow:0 2px 12px rgba(0,0,0,.45);
}

.logoMark{
  width:44px;height:44px;border-radius:14px;
  background:
    radial-gradient(60% 60% at 30% 20%, rgba(34,211,238,.18), rgba(59,130,246,.16)),
    rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.12);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 10px 24px rgba(0,0,0,.25);
  flex:0 0 auto;
}
.logoMark span{font-size:20px}

.gameGrid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:860px){ .gameGrid{grid-template-columns:1fr 1fr;} }
.gameCard{
  position:relative;
  z-index:0;
  isolation:isolate;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;padding:14px;
  box-shadow:0 10px 26px rgba(0,0,0,.28);
}
.gameHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
.gameTitle{display:flex;align-items:center;gap:10px}
.gameIcon{
  width:38px;height:38px;border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:
    radial-gradient(60% 60% at 30% 20%, rgba(0,0,0,0), rgba(34,211,238,.10)),
    rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  font-size:18px;
}
.gameMeta{color:var(--muted);font-size:13px;margin-top:4px}
.gameActions{display:flex;gap:10px;margin-top:10px;justify-content:center}
.gameActions .btn{flex:1;min-height:48px}

.boardBox{
  display:flex;
  justify-content:center;
  align-items:center;
  width:100%;
  padding:6px 0;
}
.boardBox svg{
  display:block;
  margin:0 auto;
  width:min(420px, 92vw) !important;
  max-width:92vw;
  height:auto;
}

.hitRow{
  max-width:560px;
  margin:0 auto;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
}
.hitBtn{
  min-height:54px;
  font-size:14px;
  padding:14px 10px;
  border-radius:14px;
  font-weight:1000;
  letter-spacing:.3px;
  text-align:center;
  border:1px solid rgba(255,255,255,.14);
  color:var(--text);
  background:var(--chrome-fill);
  box-shadow:
    0 10px 22px rgba(0,0,0,.32),
    inset 0 1px 0 rgba(255,255,255,.20),
    inset 0 -12px 18px rgba(0,0,0,.38);
  position:relative;
  white-space:normal;line-height:1.12;
}
.hitBtn::after{
  content:"";
  position:absolute;
  left:10px; right:10px; top:7px;
  height:38%;
  border-radius:12px;
  background:linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,0));
  pointer-events:none;
  opacity:.85;
}
.hitBtn.miss{ border-color: rgba(239,68,68,.38); grid-column:1 / 2; }
.hitBtn.undo{ color:var(--muted); grid-column:2 / 4; }

.rosterGrid{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:860px){ .rosterGrid{grid-template-columns:1fr 1fr;} }
.rosterCard{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:12px 12px;border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
}
.rosterLeft{display:flex;align-items:center;gap:10px}
.avatar{
  width:34px;height:34px;border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:
    radial-gradient(60% 60% at 30% 20%, rgba(34,197,94,.18), rgba(59,130,246,.10)),
    rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  font-weight:1000;color:var(--c-cyan);
}
.rosterSub{ color:var(--muted); font-size:12px; overflow-wrap:anywhere; }

.playerStrip{
  display:flex;
  gap:10px;
  justify-content:center;
  align-items:stretch;
  flex-wrap:wrap;
  padding:4px 0 2px;
}
.playerChip{
  min-width:140px;
  max-width:min(320px, 90vw);
  flex:1;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
  padding:10px 12px;
  text-align:center;
  position:relative;
}
.playerChip .nm{
  font-weight:1000;
  font-size:15px;
  letter-spacing:.2px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.playerChip .sub{
  margin-top:2px;
  font-size:12px;
  color:var(--muted);
  text-shadow:none;
}
.playerChip.active{
  border-color:rgba(34,197,94,.55);
  background:
    linear-gradient(135deg, rgba(34,197,94,.22), rgba(34,211,238,.10)),
    var(--chrome-fill);
  box-shadow:
    0 10px 22px rgba(0,0,0,.32),
    0 0 28px rgba(34,197,94,.22),
    inset 0 0 26px rgba(34,197,94,.14),
    inset 0 1px 0 rgba(255,255,255,.20),
    inset 0 -12px 18px rgba(0,0,0,.38);
}

.avatar.online{
  border-color:rgba(34,197,94,.55);
  box-shadow:0 0 18px rgba(34,197,94,.28);
  color:#bfffd1;
  position:relative;
}
.avatar.online::after{
  content:"";
  position:absolute;
  right:-2px;
  bottom:-2px;
  width:9px;
  height:9px;
  border-radius:999px;
  background:rgba(34,197,94,.95);
  border:1px solid rgba(6,8,20,.9);
  box-shadow:0 0 10px rgba(34,197,94,.55);
  animation:onlineDotPulse 1.6s ease-in-out infinite;
}
@keyframes onlineDotPulse{
  0%{ transform:scale(1);   filter:brightness(1);   box-shadow:0 0 10px rgba(34,197,94,.45); }
  50%{transform:scale(1.35);filter:brightness(1.25);box-shadow:0 0 18px rgba(34,197,94,.75); }
  100%{transform:scale(1);  filter:brightness(1);   box-shadow:0 0 10px rgba(34,197,94,.45); }
}

.kTurnBig{ font-size:34px; font-weight:1000; letter-spacing:.4px; margin:0; }
.kTurnSub{ font-size:15px; color:var(--muted); margin-top:6px }
.kNumberBig{ font-size:22px; font-weight:1000; }
.kLivesBig{ font-size:18px; font-weight:1000; letter-spacing:2px; display:flex; justify-content:flex-end; gap:6px; align-items:center; }
.kAttackGrid{ display:grid; grid-template-columns:1fr; gap:10px; }
@media(min-width:860px){ .kAttackGrid{grid-template-columns:1fr 1fr;} }
.kAttackBtn{
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  color:var(--text);
  font-weight:1000;
  padding:14px;
  cursor:pointer;
  text-align:left;
  position:relative;
}
.kAttackBtn:disabled{opacity:.45;cursor:not-allowed}
.heart{ color:var(--danger); text-shadow:0 2px 10px rgba(0,0,0,.35); font-size:18px; line-height:1; }
.lifeOut{ color:rgba(159,176,208,.9); font-weight:1000; letter-spacing:.8px; }

.headerStack{
  position:relative;
  display:grid;
  grid-template-rows:auto auto auto auto;
  gap:6px;
  padding:8px 10px 6px;
}
.headerTopRow{
  display:grid;
  grid-template-columns:1fr 1fr;
  align-items:center;
}
.headerTopRow .left{justify-self:start}
.headerTopRow .right{justify-self:end}
.headerTitle{text-align:center;font-size:26px;font-weight:1000;margin:0;letter-spacing:.6px;text-shadow:0 2px 14px rgba(0,0,0,.55), 0 0 18px rgba(34,211,238,.10)}
.headerIcon{
  position:absolute;
  left:14px;
  top:44px;
  width:34px;height:34px;
  display:flex;align-items:center;justify-content:center;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  box-shadow:0 10px 22px rgba(0,0,0,.28);
  pointer-events:none;
}
.turnNameBox{ position:relative; overflow:hidden; height:56px; display:flex; align-items:center; justify-content:center; width:100%; align-self:stretch; }
.turnNameText{ position:relative; font-size:26px; font-weight:1000; white-space:nowrap; max-width:100%; text-align:center; color:var(--text); text-shadow:0 2px 14px rgba(0,0,0,.60), 0 0 18px rgba(34,211,238,.28);}
.turnBracket{margin:0 10px;color:var(--c-cyan);text-shadow:0 0 14px rgba(34,211,238,.65),0 2px 10px rgba(0,0,0,.55);font-weight:1000;}
@media(max-width:520px){ .turnNameText{ font-size:24px; } }

@keyframes targetPulse{
  0%{ filter:brightness(1); text-shadow:0 0 0 rgba(0,0,0,0); }
  50%{ filter:brightness(1.8); text-shadow:0 0 18px rgba(34,211,238,.65); }
  100%{ filter:brightness(1); text-shadow:0 0 0 rgba(0,0,0,0); }
}
.targetFlash{ font-weight:1000; color:var(--c-cyan); animation:targetPulse 1.1s ease-in-out infinite; }

.winOverlay{
  position:fixed;
  inset:0;
  z-index:9999;
  pointer-events:none;
  display:flex;
  align-items:center;
  justify-content:center;
  background:radial-gradient(900px 520px at 50% 40%, rgba(34,211,238,.12), rgba(6,8,20,.72) 62%, rgba(6,8,20,.88));
  backdrop-filter: blur(6px);
  animation: winFade 2.8s ease-out forwards;
}
@keyframes winFade{ 0%{opacity:0} 12%{opacity:1} 80%{opacity:1} 100%{opacity:0} }
.winCard{
  position:relative;
  padding:18px 18px 14px;
  border-radius:20px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
  box-shadow:0 24px 60px rgba(0,0,0,.55);
  text-align:center;
  min-width:min(360px, 86vw);
  transform:translateZ(0);
  animation: winPop 900ms cubic-bezier(.2,.9,.2,1) both;
}
@keyframes winPop{ 0%{ transform:scale(.92); opacity:.0; } 55%{ transform:scale(1.03); opacity:1; } 100%{ transform:scale(1); opacity:1; } }
.winTitle{
  font-weight:1000;
  font-size:22px;
  margin:0 0 6px;
  background:var(--chrome-text);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
  text-shadow:0 2px 12px rgba(0,0,0,.55);
}
.winSub{ color:rgba(238,244,255,.92); font-weight:900; letter-spacing:.3px; }

.topActions .btn{ min-height:44px; padding:10px 14px; }
.topActions .btn.ghost#soundBtn{ min-width:52px; width:52px; padding:10px 0; font-size:18px; }
.btn.ghost{ border-color:rgba(255,255,255,.12); }
.btn.ghost:active{ transform:translateY(1px); }

.tableWrap tbody td{ color: var(--text); background: transparent; }
.tableWrap tbody td *{ color: inherit; -webkit-text-fill-color: currentColor; }
</style>
</head>

<body>
<div class="topbar">
  <div class="topActions left">
    <button class="btn ghost" id="signOutBtn" type="button" style="display:none;">Sign out</button>
  </div>

  <div class="brand">
    <div class="t" id="brandTitle">Game Night</div>
    <div class="s">The Dart Room â€¢ Designed by Steveâ€™s Graphic Designs â€¢ ONLINE SHARED BUILD</div>
  </div>

  <div class="topActions right">
    <button class="btn ghost" id="soundBtn" type="button" aria-label="Sound toggle">ðŸ”Š</button>
    <button class="btn ghost" id="homeBtn" type="button">Home</button>
  </div>
</div>

<div class="wrap" id="app">
  <div class="card"><div class="h1">Loadingâ€¦</div><div class="sub">Starting upâ€¦</div></div>
</div>

<div class="footerLegal" aria-hidden="true">
  <div class="txt">Night Games is an official Dart Room online training tool. All rights reserved Â© Steveâ€™s Graphic Designs. â€¢ Online Shared Build</div>
</div>

<script type="module">
/* ====================== Firebase (ONLINE SHARED) ====================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.24.0/firebase-app.js";

import { getAuth, signInAnonymously, signOut as fbSignOut } from "https://www.gstatic.com/firebasejs/10.24.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection,
  getDocs, query, where, onSnapshot, runTransaction, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.24.0/firebase-firestore.js";

/* Your Firebase configuration (from your original project) */

/* ====================== Firebase config (online shared) ======================
   To avoid GitHub "secrets detected" warnings, this file does NOT hard-code your
   Firebase keys. Instead, the config is saved locally on each device.
   - First run: paste your firebaseConfig JSON and tap Save.
   - After that: it loads automatically.
   Your brother/Jace will need to do this once on their device too.
============================================================================= */

function _readSavedFirebaseConfig(){
  try{
    const raw = localStorage.getItem("gn_firebase_config");
    if(!raw) return null;
    const cfg = JSON.parse(raw);
    if(cfg && cfg.apiKey && cfg.projectId) return cfg;
  }catch(_){}
  return null;
}

function _renderFirebaseConfigSetup(){
  const el = document.getElementById("app") || document.body;
  const sample = `{
  "apiKey": "YOUR_API_KEY",
  "authDomain": "YOUR_PROJECT.firebaseapp.com",
  "projectId": "YOUR_PROJECT",
  "storageBucket": "YOUR_PROJECT.appspot.com",
  "messagingSenderId": "000000000000",
  "appId": "1:000000000000:web:xxxxxxxxxxxxxxxxxxxxxx",
  "measurementId": "G-XXXXXXXXXX"
}`;
  el.innerHTML = `
    <div class="wrap">
      <div class="card">
        <div class="h1">One-time setup</div>
        <div class="sub">Paste your <b>firebaseConfig</b> JSON below. This enables the online shared version.</div>
        <div class="divider"></div>
        <label>firebaseConfig JSON</label>
        <textarea id="fbCfg" style="width:100%;min-height:220px;background:rgba(7,10,20,.72);border:1px solid rgba(255,255,255,.14);color:var(--text);border-radius:14px;padding:12px 12px;font-size:13px;outline:none;line-height:1.35;white-space:pre;">${sample}</textarea>
        <div class="divider"></div>
        <div class="row">
          <button class="btn ok" id="saveFbCfg" type="button">Save & Reload</button>
          <button class="btn ghost" id="clearFbCfg" type="button">Clear</button>
        </div>
        <div class="divider"></div>
        <div class="small">Tip: You can find this in your Firebase console (Project settings â†’ Your apps â†’ SDK setup & config).</div>
      </div>
    </div>
  `;
  document.getElementById("saveFbCfg").onclick = ()=>{
    const raw = (document.getElementById("fbCfg").value||"").trim();
    try{
      const cfg = JSON.parse(raw);
      if(!cfg || !cfg.apiKey || !cfg.projectId) throw new Error("Missing apiKey or projectId.");
      localStorage.setItem("gn_firebase_config", JSON.stringify(cfg));
      location.reload();
    }catch(e){
      alert("That JSON doesn't look right. " + (e && e.message ? e.message : ""));
    }
  };
  document.getElementById("clearFbCfg").onclick = ()=>{
    try{ localStorage.removeItem("gn_firebase_config"); }catch(_){}
    location.reload();
  };
}

const firebaseConfig = _readSavedFirebaseConfig();
if(!firebaseConfig){
  _renderFirebaseConfigSetup();
  throw new Error("Firebase config not set");
}

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
/* ====================== Helpers ====================== */
const appEl=document.getElementById("app");
const homeBtn=document.getElementById("homeBtn");
const soundBtn=document.getElementById("soundBtn");
const signOutBtn=document.getElementById("signOutBtn");
const brandTitle=document.getElementById("brandTitle");

function esc(s){ return String(s==null?"":s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function normEmail(e){ return String(e==null?"":e).trim().toLowerCase(); }
function now(){ return Date.now(); }
function fmt(ts){ try{return new Date(ts).toLocaleString();}catch{return "";} }
function idForEmail(email){
  return normEmail(email).replace(/[^a-z0-9_-]/g,"_");
}

/* ====================== Sound ====================== */
let soundEnabled = true;
try{ const v = localStorage.getItem("gn_sound"); if(v === "0") soundEnabled = false; }catch{}
let __audioCtx=null;
const MASTER_GAIN = 3.2;
function ensureAudio(){ if(__audioCtx) return __audioCtx; try{ __audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch(_){}
  return __audioCtx;
}
let __audioUnlocked=false;
function unlockAudio(){
  if(__audioUnlocked) return;
  const ctx=ensureAudio(); if(!ctx) return;
  try{ if(ctx.state==="suspended") ctx.resume(); }catch(_){}
  try{
    const o = ctx.createOscillator(); const g = ctx.createGain();
    g.gain.value = 0.0002; o.frequency.value=440;
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+0.02);
  }catch(_){}
  __audioUnlocked=true;
}
window.addEventListener("pointerdown", unlockAudio, {passive:true});
window.addEventListener("touchstart", unlockAudio, {passive:true});
function playBeep(kind){
  unlockAudio();
  if(!soundEnabled) return;
  const ctx=ensureAudio(); if(!ctx) return;
  try{ if(ctx.state==="suspended") ctx.resume(); }catch(_){}
  const _nowMs=Date.now();
  window.__lastBeepAt=window.__lastBeepAt||0;
  if((_nowMs-window.__lastBeepAt)<70) return;
  window.__lastBeepAt=_nowMs;
  const t0=ctx.currentTime;
  const preset=(()=>{
    switch(kind){
      case "ok":     return {type:"triangle", notes:[523.25], dur:0.14, gain:0.85};
      case "danger": return {type:"sawtooth", notes:[220],    dur:0.16, gain:0.85};
      case "hit":    return {type:"sine",     notes:[659.25], dur:0.13, gain:0.84};
      case "miss":   return {type:"sine",     notes:[196],    dur:0.16, gain:0.85};
      case "back":   return {type:"triangle", notes:[329.63], dur:0.10, gain:0.85};
      case "nav":    return {type:"triangle", notes:[392.00], dur:0.10, gain:0.85};
      case "toggle": return {type:"square",   notes:[784.00], dur:0.09, gain:0.85};
      case "win":    return {type:"triangle", notes:[523.25,659.25,783.99,1046.5], dur:0.42, gain:0.85};
      default:       return {type:"triangle", notes:[440.00], dur:0.10, gain:0.85};
    }
  })();
  function tone(freq,start,dur,gain){
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type=preset.type; o.frequency.setValueAtTime(freq,start);
    g.gain.setValueAtTime(0.0001,start);
    const g1=Math.min(0.95,gain*MASTER_GAIN);
    g.gain.exponentialRampToValueAtTime(g1,start+0.015);
    g.gain.exponentialRampToValueAtTime(0.0001,start+dur);
    o.connect(g); g.connect(ctx.destination);
    o.start(start); o.stop(start+dur+0.02);
  }
  if(kind==="win"){ const step=0.09; preset.notes.forEach((f,i)=>tone(f,t0+i*step,0.18,preset.gain)); return; }
  tone(preset.notes[0],t0,preset.dur,preset.gain);
}
function setSoundEnabled(on){
  soundEnabled=!!on;
  try{ localStorage.setItem("gn_sound", soundEnabled?"1":"0"); }catch(_){}
  if(soundBtn){
    soundBtn.textContent = soundEnabled ? "ðŸ”Š" : "ðŸ”ˆ";
    soundBtn.setAttribute("aria-label", soundEnabled ? "Sound on" : "Sound off");
  }
}
document.addEventListener("click",(ev)=>{
  const btn = ev.target?.closest?.("button");
  if(!btn || btn.disabled) return;
  try{ unlockAudio(); }catch(_){}
  if(btn.dataset?.nosound==="1") return;
  if(btn.id==="soundBtn") return;
  if(btn.classList?.contains("hitBtn") || btn.classList?.contains("kAttackBtn")) return;
  const id=String(btn.id||"").toLowerCase();
  const txt=String(btn.textContent||"").trim().toLowerCase();
  if(btn.classList?.contains("danger")) return playBeep("danger");
  if(btn.classList?.contains("ok")) return playBeep("ok");
  if(id.includes("back") || txt==="back" || txt==="undo") return playBeep("back");
  if(btn.classList?.contains("ghost")) return playBeep("nav");
  return playBeep("click");
},{capture:true});

/* ====================== UI ====================== */
function setHTML(html){
  appEl.innerHTML = html;
  try{
    if(window.__screenChanged){
      appEl.animate([{opacity:0},{opacity:1}],{duration:160,easing:"cubic-bezier(.2,.8,.2,1)"});
    }
  }catch(_){}
  try{
    if(window.__screenChanged) window.scrollTo({top:0,left:0,behavior:"instant"});
  }catch(_){
    if(window.__screenChanged) window.scrollTo(0,0);
  }
}
function showWinOverlay(title, subtitle){
  try{
    const wrap=document.createElement("div"); wrap.className="winOverlay";
    const card=document.createElement("div"); card.className="winCard";
    card.innerHTML = `<div class="winTitle">${esc(title||"Match complete")}</div><div class="winSub">${esc(subtitle||"")}</div>`;
    wrap.appendChild(card);
    document.body.appendChild(wrap);
    setTimeout(()=>{ try{wrap.remove();}catch{} }, 2850);
  }catch(_){}
}
function showFatal(title,msg){
  setHTML(`
    <div class="card">
      <div class="hero">
        <div class="heroCornerLeft"><div class="logoMark"><span>âš </span></div></div>
        <div class="heroMain" style="align-items:flex-start;text-align:left">
          <div class="h1">${esc(title)}</div>
          <div class="sub" style="white-space:pre-wrap">${esc(msg)}</div>
        </div>
        <div class="heroCornerRight"></div>
      </div>
      <div class="divider"></div>
      <div class="row">
        <button class="btn ok" id="retryBtn">Retry</button>
        <button class="btn ghost" id="reloadBtn">Hard Reload</button>
      </div>
      <div class="divider"></div>
      <div class="sub">If you see an error, try a hard reload.</div>
    </div>
  `);
  document.getElementById("retryBtn").onclick=()=>boot();
  document.getElementById("reloadBtn").onclick=()=>location.reload(true);
}

/* ====================== Firestore-backed storage ====================== */
async function getPlayers(){
  const snap=await getDocs(collection(db,"players"));
  const items=snap.docs.map(d=>d.data()).filter(Boolean);
  items.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
  return items;
}
async function upsertPlayer(name,email){
  const e=normEmail(email);
  const id=idForEmail(e);
  const ref=doc(db,"players",id);
  const existing=await getDoc(ref);
  const createdAt = existing.exists() ? (existing.data().createdAt || serverTimestamp()) : serverTimestamp();
  await setDoc(ref,{name:String(name||"").trim(), email:e, createdAt, updatedAt:serverTimestamp()},{merge:true});
}
async function signInEmail(email){
  const e=normEmail(email);
  const id=idForEmail(e);
  const ref=doc(db,"players",id);
  const snap=await getDoc(ref);
  return snap.exists()?snap.data():null;
}
async function signUpEmail(name,email){
  await upsertPlayer(name,email);
  return await signInEmail(email);
}

async function getStatsDoc(email){
  const e=normEmail(email);
  const ref=doc(db,"stats",idForEmail(e));
  const snap=await getDoc(ref);
  return snap.exists()?snap.data():{};
}
async function saveStatsDoc(email,data){
  const e=normEmail(email);
  const ref=doc(db,"stats",idForEmail(e));
  await setDoc(ref,{...data, updatedAt:serverTimestamp()},{merge:true});
}

async function saveHistoryEntry(entry){
  await addDoc(collection(db,"history"),{...entry, createdAt:serverTimestamp()});
}
async function getHistory(email){
  const e=normEmail(email);
  // Try best query; if missing index, fall back to client sort.
  try{
    const qy=query(collection(db,"history"), where("players","array-contains",e));
    const snap=await getDocs(qy);
    const all=snap.docs.map(d=>d.data());
    all.sort((a,b)=>(b.endedAt||0)-(a.endedAt||0));
    return all.slice(0,60);
  }catch(_){
    const snap=await getDocs(collection(db,"history"));
    const all=snap.docs.map(d=>d.data()).filter(h=>Array.isArray(h.players)&&h.players.includes(e));
    all.sort((a,b)=>(b.endedAt||0)-(a.endedAt||0));
    return all.slice(0,60);
  }
}

async function resetStatsAll(email){
  await setDoc(doc(db,"stats",idForEmail(normEmail(email))),{games:{} , updatedAt:serverTimestamp()},{merge:true});
}
async function resetStatsGame(email, gameId){
  const e=normEmail(email);
  const ref=doc(db,"stats",idForEmail(e));
  const cur=await getStatsDoc(e);
  const games=cur.games||{};
  const next={...games}; delete next[gameId];
  await setDoc(ref,{games:next, updatedAt:serverTimestamp()},{merge:true});
}
async function deletePlayerAndData(email){
  // For simplicity in a single-file build, we do "soft delete" by clearing the player doc and stats.
  // Full deletes require admin privileges / callable functions.
  const e=normEmail(email);
  await setDoc(doc(db,"players",idForEmail(e)),{deleted:true, updatedAt:serverTimestamp()},{merge:true});
  await setDoc(doc(db,"stats",idForEmail(e)),{games:{}, deleted:true, updatedAt:serverTimestamp()},{merge:true});
}

/* ====================== Presence (Firestore) ====================== */
const PRESENCE_BEAT_MS = 20000;
const PRESENCE_ONLINE_MS = 45000;
let __presenceTimer=null;
let __presenceEmail=null;
let __presenceUnsub=null;
let __presenceCache=new Map();

function presenceRef(email){ return doc(db,"presence",idForEmail(normEmail(email))); }

function tsToMs(ts){
  if(!ts) return 0;
  if(typeof ts==="number") return ts;
  if(ts.toMillis) return ts.toMillis();
  return 0;
}
function isOnline(email){
  const e=normEmail(email);
  const rec=__presenceCache.get(e);
  const ms = rec ? tsToMs(rec.lastSeenAt) : 0;
  if(!ms) return false;
  return (Date.now()-ms) <= PRESENCE_ONLINE_MS;
}
async function beatPresence(email,name){
  const e=normEmail(email);
  if(!e) return;
  await setDoc(presenceRef(e),{email:e,name:name||null,lastSeenAt:serverTimestamp()},{merge:true});
}
function startPresence(email){
  const e=normEmail(email);
  if(!e) return;
  if(__presenceEmail===e && __presenceTimer) return;
  stopPresence();
  __presenceEmail=e;
  const doBeat=()=>beatPresence(e, meUser?.name||null).catch(()=>{});
  doBeat();
  __presenceTimer=setInterval(doBeat, PRESENCE_BEAT_MS);

  // Subscribe to whole presence collection so everyone sees everyone online/offline.
  if(!__presenceUnsub){
    __presenceUnsub = onSnapshot(collection(db,"presence"), (snap)=>{
      snap.docs.forEach(d=>{
        const v=d.data();
        if(v && v.email) __presenceCache.set(normEmail(v.email), v);
      });
      requestRender("presence");
    }, ()=>{});
  }
}
function stopPresence(){
  try{ if(__presenceTimer) clearInterval(__presenceTimer); }catch(_){}
  __presenceTimer=null; __presenceEmail=null;
}

/* ====================== Live Match (Firestore) ====================== */
let matchId = null;
let matchUnsub = null;

function matchDocRef(id){ return doc(db,"matches",id); }

async function createMatchDoc(matchObj){
  const ref = await addDoc(collection(db,"matches"), {
    ...matchObj,
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp()
  });
  return ref.id;
}

function subscribeMatch(id){
  if(matchUnsub) { try{matchUnsub();}catch{} matchUnsub=null; }
  matchId=id;
  matchUnsub = onSnapshot(matchDocRef(id),(snap)=>{
    if(!snap.exists()){ toastMsg="Match no longer exists."; match=null; matchId=null; screen="home"; return render(); }
    match = snap.data();
    render();
  }, (err)=>{
    showFatal("Live match error", err?.message||String(err));
  });
}

async function updateMatchTxn(transformFn){
  if(!matchId) return;
  const ref=matchDocRef(matchId);
  await runTransaction(db, async(tx)=>{
    const snap=await tx.get(ref);
    if(!snap.exists()) throw new Error("Match missing");
    const cur=snap.data();
    const next=transformFn(structuredClone(cur));
    next.updatedAt = serverTimestamp();
    tx.set(ref,next,{merge:false});
  });
}

function structuredClone(obj){
  try{ return globalThis.structuredClone(obj); }catch(_){ return JSON.parse(JSON.stringify(obj)); }
}

/* ====================== Turn name animation ====================== */
let _turnNameCache = {};
function turnNameHTML(name){
  const nm = esc(name||"");
  return `<div class="turnNameText turnTitle3d">
    <span class="turnBracket">âŸ¦</span>${nm}<span class="turnBracket">âŸ§</span>
  </div>`;
}
function animateTurnName(gameId, name){
  const box=document.getElementById("turnNameBox");
  if(!box) return;
  const prev=_turnNameCache[gameId];
  _turnNameCache[gameId]=name;
  if(!prev || prev===name){ box.innerHTML=turnNameHTML(name); return; }
  box.innerHTML = `
    <div class="turnNameSlide turnOld">${turnNameHTML(prev)}</div>
    <div class="turnNameSlide turnNew">${turnNameHTML(name)}</div>
  `;
  const oldWrap=box.querySelector(".turnOld");
  const newWrap=box.querySelector(".turnNew");
  try{
    oldWrap.animate([{transform:"translateX(0%)",opacity:1},{transform:"translateX(-140%)",opacity:0.2}],{duration:320,easing:"cubic-bezier(.2,.8,.2,1)"});
    newWrap.animate([{transform:"translateX(140%)",opacity:0.2},{transform:"translateX(0%)",opacity:1}],{duration:320,easing:"cubic-bezier(.2,.8,.2,1)"}).onfinish=()=>{ box.innerHTML=turnNameHTML(name); };
  }catch(_){ box.innerHTML=turnNameHTML(name); }
}

/* ====================== Dartboard SVG (from your build) ====================== */
const BOARD_NUMS=[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];
function dartboardSVG(activeTarget){
  const cx=100,cy=100;
  const outer=80, rDoubleOuter=74, rDoubleInner=66, rTripleOuter=48, rTripleInner=40, rSingleInner=12;
  const seg=360/20;
  const rot=-seg/2;

  function polar(cx,cy,r,deg){ const rad=(deg-90)*Math.PI/180; return {x:cx+r*Math.cos(rad), y:cy+r*Math.sin(rad)}; }
  function arcWedgePath(cx,cy,r0,r1,a0,a1){
    const p1=polar(cx,cy,r1,a0), p2=polar(cx,cy,r1,a1);
    const p3=polar(cx,cy,r0,a1), p4=polar(cx,cy,r0,a0);
    const large=(a1-a0)>180?1:0;
    const f=n=>(Math.round(n*1000)/1000).toFixed(3);
    return `M ${f(p1.x)} ${f(p1.y)} A ${r1} ${r1} 0 ${large} 1 ${f(p2.x)} ${f(p2.y)} L ${f(p3.x)} ${f(p3.y)} A ${r0} ${r0} 0 ${large} 0 ${f(p4.x)} ${f(p4.y)} Z`;
  }
  function ringWedges(r0,r1,fillA,fillB){
    let out="";
    for(let i=0;i<20;i++){
      const a0=i*seg+rot+0.8;
      const a1=(i+1)*seg+rot-0.8;
      out+=`<path d="${arcWedgePath(cx,cy,r0,r1,a0,a1)}" fill="${i%2===0?fillA:fillB}" opacity="0.95"/>`;
    }
    return out;
  }

  let activeOverlay="";
  if(typeof activeTarget === "number"){
    const idx = BOARD_NUMS.indexOf(activeTarget);
    if(idx >= 0){
      const a0 = idx*seg + rot + 0.6;
      const a1 = (idx+1)*seg + rot - 0.6;
      const slices = [
        {r0:rSingleInner, r1:rDoubleOuter, fill:"rgba(34,211,238,.16)", stroke:"rgba(34,211,238,.94)", sw:3.4},
        {r0:rDoubleInner, r1:rDoubleOuter, fill:"rgba(239,68,68,.30)", stroke:"rgba(255,255,255,.92)", sw:3.0},
        {r0:rTripleInner, r1:rTripleOuter, fill:"rgba(239,68,68,.26)", stroke:"rgba(255,255,255,.88)", sw:2.8},
        {r0:rTripleOuter, r1:rDoubleInner, fill:"rgba(34,211,238,.20)", stroke:"rgba(34,211,238,.96)", sw:3.0},
        {r0:rSingleInner, r1:rTripleInner, fill:"rgba(34,211,238,.18)", stroke:"rgba(34,211,238,.92)", sw:2.7},
      ];
      activeOverlay += `<path d="${arcWedgePath(cx,cy,rSingleInner,rDoubleOuter,a0,a1)}"
        fill="rgba(34,197,94,.10)" stroke="rgba(34,211,238,.55)" stroke-width="7.5" filter="url(#glow)" />`;
      for(const s of slices){
        activeOverlay += `<path d="${arcWedgePath(cx,cy,s.r0,s.r1,a0,a1)}"
          fill="${s.fill}" stroke="${s.stroke}" stroke-width="${s.sw}" filter="url(#glow)"/>`;
      }
    }
  }else if(activeTarget === "B"){
    activeOverlay += `
      <circle cx="100" cy="100" r="14.5" fill="rgba(34,211,238,.22)" stroke="rgba(34,211,238,.98)" stroke-width="3.0" filter="url(#glow)"/>
      <circle cx="100" cy="100" r="7.6"  fill="rgba(34,197,94,.16)" stroke="rgba(255,255,255,.92)" stroke-width="2.6" filter="url(#glow)"/>
    `;
  }

  let numText="";
  for(let i=0;i<20;i++){
    const ang=i*seg+rot+seg/2;
    const p=polar(cx,cy,90,ang);
    const n=BOARD_NUMS[i];
    const isActive = (typeof activeTarget==="number" && n===activeTarget);
    if(isActive){
      numText+=`<text x="${p.x.toFixed(2)}" y="${p.y.toFixed(2)}" text-anchor="middle" dominant-baseline="middle"
        font-size="10.2" fill="#22d3ee" font-weight="1000"
        style="paint-order:stroke;stroke:#ffffff;stroke-width:2.6px;filter:url(#glow)">${n}</text>`;
    }else{
      numText+=`<text x="${p.x.toFixed(2)}" y="${p.y.toFixed(2)}" text-anchor="middle" dominant-baseline="middle"
        font-size="8.5" fill="#dfe9ff" font-weight="900"
        style="paint-order:stroke;stroke:#07101d;stroke-width:2px">${n}</text>`;
    }
  }

  return `<svg viewBox="0 0 200 200" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
    <defs>
      <radialGradient id="bgG" cx="50%" cy="42%" r="65%">
        <stop offset="0%" stop-color="#1a2a4a"/>
        <stop offset="55%" stop-color="#0b1325"/>
        <stop offset="100%" stop-color="#040814"/>
      </radialGradient>
      <filter id="glow" x="-30%" y="-30%" width="160%" height="160%">
        <feGaussianBlur stdDeviation="4.8" result="b"/>
        <feColorMatrix in="b" type="matrix"
          values="0 0 0 0 0.18  0 0 0 0 0.92  0 0 0 0 1.00  0 0 0 1.0 0" result="c"/>
        <feMerge><feMergeNode in="c"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <circle cx="100" cy="100" r="${outer}" fill="url(#bgG)" stroke="#2a3f5f" stroke-width="2"/>
    ${ringWedges(rTripleOuter,rDoubleInner,"#0b1220","#1a2338")}
    ${ringWedges(rTripleInner,rTripleOuter,"#2aa84a","#c63a3a")}
    ${ringWedges(rDoubleInner,rDoubleOuter,"#2aa84a","#c63a3a")}
    ${ringWedges(rSingleInner,rTripleInner,"#1a2338","#0b1220")}
    ${activeOverlay}
    <circle cx="100" cy="100" r="11.5" fill="#2aa84a" stroke="#1b2b42" stroke-width="2"/>
    <circle cx="100" cy="100" r="5.3" fill="#c63a3a" stroke="#1b2b42" stroke-width="1.5"/>
    ${numText}
  </svg>`;
}

/* ====================== Match snapshot (undo) ====================== */
function pushSnap(m){
  m.snaps=m.snaps||[];
  m.snaps.push(JSON.stringify(m));
  if(m.snaps.length>80) m.snaps.shift();
}
function popSnap(m){
  if(!m || !m.snaps || m.snaps.length<2) return m;
  m.snaps.pop();
  const prev=m.snaps.pop();
  try{return JSON.parse(prev);}catch{return m;}
}

/* ====================== Games ====================== */
const Games=[
  {id:"shanghai", name:"Shanghai", icon:"ðŸŽ¯", active:true, tagline:"20 â†’ 15 â†’ Bull"},
  {id:"killer",   name:"Killer",   icon:"ðŸ”¥", active:true, tagline:"Claim a number â€¢ Hit doubles"},
  {id:"around",   name:"Around the World", icon:"ðŸŒ", active:true, tagline:"1 â†’ 20 â†’ Bull â€¢ Singles/Doubles/Triples"},
];
const getGame=id=>Games.find(g=>g.id===id)||null;

const ShanghaiGame=(()=>{
  const TARGETS=[20,19,18,17,16,15,"B"];
  const pts=hit=>hit==="T"?3:hit==="D"?2:hit==="S"?1:0;

  function initMatch(selectedPlayers){
    const m={
      gameId:"shanghai",
      players:selectedPlayers.map(p=>({name:p.name,email:p.email,total:0})),
      startedAt:now(), endedAt:null,
      turnIndex:0, targetIndex:0, dartInTurn:0,
      finished:false, grid:{}, snaps:[], _saved:false, _winShown:false
    };
    m.players.forEach(p=>{
      m.grid[p.email]={};
      TARGETS.forEach(t=>{
        m.grid[p.email][String(t)]={throws:[],points:0};
      });
    });
    pushSnap(m);
    return m;
  }

  function addThrow(m, hit){
    if(!m||m.finished) return;
    const player=m.players[m.turnIndex];
    const targetKey=String(TARGETS[m.targetIndex]);
    const cell=m.grid[player.email][targetKey];
    cell.throws.push(hit);
    cell.points+=pts(hit);
    player.total+=pts(hit);

    m.dartInTurn++;
    if(m.dartInTurn>=3){
      m.dartInTurn=0;
      m.turnIndex=(m.turnIndex+1)%m.players.length;
      if(m.turnIndex===0) m.targetIndex++;
    }
    if(m.targetIndex>=TARGETS.length){
      m.finished=true;
      m.endedAt=now();
    }
  }

  async function saveFinish(ctx){
    const m=ctx.match;
    if(!m.finished||m._saved) return;
    m._saved=true;

    const summary=m.players.slice().sort((a,b)=>b.total-a.total)
      .map(p=>`${p.name}: ${p.total}`).join(" | ");

    await saveHistoryEntry({
      gameId:"shanghai", gameName:"Shanghai",
      startedAt:m.startedAt, endedAt:m.endedAt,
      players:m.players.map(p=>p.email),
      summary,
      meta:{targets:TARGETS}
    });

    const stats=await getStatsDoc(ctx.meUser.email);
    const games=stats.games||{};
    const g=games.shanghai||{};
    const played=(g.played||0)+1;

    const meRow=m.players.find(p=>p.email===ctx.meUser.email);
    const myScore=meRow?meRow.total:0;
    const points=(g.points||0)+myScore;
    const best=Math.max(g.best||0,myScore);

    await saveStatsDoc(ctx.meUser.email,{
      games:{...games, shanghai:{...g, played, points, best, lastPlayedAt:m.endedAt||now()}}
    });
  }

  function renderPlay(ctx){
    const m=ctx.match;
    const t=TARGETS[m.targetIndex];

    let thead=`<tr><th>Target</th>`;
    for(const p of m.players){
      thead+=`<th><span class="thName">${esc(p.name)}</span><div class="small">${p.total} pts</div></th>`;
    }
    thead+=`</tr>`;

    let tbody="";
    for(const target of TARGETS){
      const key=String(target);
      tbody+=`<tr><td class="l"><span class="badge">${esc(target==="B"?"BULL":target)}</span></td>`;
      for(const p of m.players){
        const cell=m.grid[p.email][key];
        const txt=cell.throws.length?cell.throws.join(" "):"â€”";
        const cls=String(t)===key?` class="activeCell"`:"";
        tbody+=`<td${cls}>${esc(txt)}<div class="small">${cell.points}</div></td>`;
      }
      tbody+=`</tr>`;
    }

    const finishedBanner=m.finished?`<div class="divider"></div><div class="pill">Finished</div>`:"";

    return `
      <div class="card">
        <div class="row">
          <button class="btn ghost" id="backToSetup">Back</button>
          <button class="btn danger" id="resetBtn">Reset</button>
        </div>
        <div class="small">Match: <span class="badge">${esc(matchId||"")}</span></div>
      </div>

      <div class="card">
        <div class="headerStack">
          <div class="headerTopRow">
            <div class="left"><span class="pill">Shanghai</span></div>
            <div class="right"><span class="pill" data-live="1">Live</span></div>
          </div>
          <div class="headerIcon">ðŸŽ¯</div>
          <div class="headerTitle turnTitle3d">Shanghai</div>
          ${m.finished ? "" : `<div class="turnNameBox" id="turnNameBox">${turnNameHTML((m.players[m.turnIndex] && m.players[m.turnIndex].name)||"")}</div>`}
          ${m.finished?"":`<div class="small" style="text-align:center"><span class="badge">NOW THROWING</span></div>`}
          <div class="sub" style="text-align:center;margin-top:6px">Target: <span class="targetFlash">${esc(t==="B"?"BULL":t)}</span> â€¢ Dart <b>${m.dartInTurn+1}</b>/3</div>
        </div>

        <div class="divider"></div>
        <div class="boardBox">${dartboardSVG(t==="B"?"B":t)}</div>
        ${playerStripHTML(m.players, m.turnIndex, (p)=>"Score: <b>"+esc(p.total)+"</b>")}
        <div class="divider"></div>

        <div class="hitRow">
          <button class="hitBtn" id="hitT" ${m.finished?"disabled":""}>TRIPLE</button>
          <button class="hitBtn" id="hitS" ${m.finished?"disabled":""}>SINGLE</button>
          <button class="hitBtn" id="hitD" ${m.finished?"disabled":""}>DOUBLE</button>
          <button class="hitBtn miss" id="hitM" ${m.finished?"disabled":""}>MISS</button>
          <button class="hitBtn undo" id="undoBtn">UNDO</button>
        </div>

        ${finishedBanner}
      </div>

      <div class="card">
        <div class="pill">Round table</div>
        <div class="divider"></div>
        <div class="tableWrap">
          <table><thead>${thead}</thead><tbody>${tbody}</tbody></table>
        </div>
      </div>
    `;
  }

  function bindPlay(ctx){
    try{ animateTurnName("shanghai", ctx.match.players[ctx.match.turnIndex].name); }catch{}
    const $=(id)=>document.getElementById(id);

    function onHit(h){
      playBeep(h==="M" ? "miss" : "hit");
      updateMatchTxn((m)=>{
        if(m.finished) return m;
        pushSnap(m);
        addThrow(m,h);
        return m;
      }).then(()=>{
        // after update, if finished, show overlay on this client
        try{
          if(match && match.finished && !match._winShown){
            updateMatchTxn((m)=>{ m._winShown=true; return m; }).catch(()=>{});
            playBeep("win");
            const win = match.players.slice().sort((a,b)=>b.total-a.total)[0];
            showWinOverlay("ðŸ† Winner!", (win && win.name) || "");
          }
        }catch(_){}
        if(match && match.finished){
          saveFinish({meUser, match}).catch(e=>showFatal("Save error", e?.message||String(e)));
        }
      }).catch(e=>showFatal("Update error", e?.message||String(e)));
    }

    $("hitT").onclick=()=>onHit("T");
    $("hitS").onclick=()=>onHit("S");
    $("hitD").onclick=()=>onHit("D");
    $("hitM").onclick=()=>onHit("M");
    $("undoBtn").onclick=()=>updateMatchTxn((m)=>popSnap(m)).catch(e=>showFatal("Undo error", e?.message||String(e)));

    const resetBtn=$("resetBtn"); if(resetBtn) resetBtn.onclick=()=>{
      const pls=ctx.match.players.map(p=>({name:p.name,email:p.email}));
      updateMatchTxn(()=>ShanghaiGame.initMatch(pls)).catch(e=>showFatal("Reset error", e?.message||String(e)));
    };
    const backBtn=$("backToSetup"); if(backBtn) backBtn.onclick=()=>{
      // leave match running; just go back to setup
      match=null; matchId=null;
      try{ if(matchUnsub){ matchUnsub(); matchUnsub=null; } }catch{}
      screen="game.setup"; render();
    };
  }
  return {initMatch, renderPlay, bindPlay};
})();

const KillerGame = (() => {
  const MAX_LIVES = 3;

  function initMatch(selectedPlayers){
    return {
      gameId:"killer",
      phase:"claim",
      claimIndex:0,
      players: selectedPlayers.map(p=>({
        name:p.name, email:p.email, number:null,
        lives:MAX_LIVES, killer:false, out:false
      })),
      turnIndex:0, dartInTurn:0,
      finished:false, winner:null,
      startedAt:now(), endedAt:null,
      snaps:[], _saved:false, _winShown:false
    };
  }

  function nextAliveIndex(m, from){
    for(let step=1; step<=m.players.length; step++){
      const i=(from+step)%m.players.length;
      if(!m.players[i].out) return i;
    }
    return from;
  }
  function checkWinner(m){
    const alive=m.players.filter(p=>!p.out);
    if(alive.length===1){
      m.finished=true;
      m.winner=alive[0];
      m.endedAt=now();
    }
  }
  async function saveFinish(ctx){
    const m=ctx.match;
    if(!m.finished || m._saved) return;
    m._saved=true;
    const winnerName=(m.winner&&m.winner.name)||"Unknown";
    const summary = `ðŸ† ${winnerName} wins â€¢ ` + m.players.map(p=>`${p.name}${p.out?" (OUT)":""}`).join(" | ");
    await saveHistoryEntry({
      gameId:"killer", gameName:"Killer",
      startedAt:m.startedAt, endedAt:m.endedAt,
      players:m.players.map(p=>p.email),
      summary,
      meta:{winnerEmail:(m.winner&&m.winner.email)||null, numbers:m.players.map(p=>({email:p.email, number:p.number}))}
    });
    const stats=await getStatsDoc(ctx.meUser.email);
    const games=stats.games||{};
    const g=games.killer||{};
    const played=(g.played||0)+1;
    const iWon = ((m.winner&&m.winner.email)===ctx.meUser.email);
    const wins = (g.wins||0) + (iWon?1:0);
    await saveStatsDoc(ctx.meUser.email,{games:{...games, killer:{...g, played, wins, lastPlayedAt:m.endedAt||now()}}});
  }

  function heartsHTML(n){
    const count=Math.max(0, Number(n||0));
    if(!count) return "";
    return Array.from({length:count}, ()=>`<span class="heart">â™¥</span>`).join("");
  }

  function renderPlay(ctx){
    const m=ctx.match;
    if(m.phase==="claim"){
      const p=m.players[m.claimIndex];
      const taken=m.players.filter(x=>x.number!=null).map(x=>x.number);
      let opts = `<option value="" selected disabled>Select a numberâ€¦</option>`;
      for(let n=1;n<=20;n++){
        const dis=taken.includes(n) && p.number!==n;
        opts += `<option value="${n}" ${dis?"disabled":""}>${n}${dis?" (taken)":""}</option>`;
      }
      return `
        <div class="card">
          <div class="row">
            <button class="btn ghost" id="backToSetup">Back</button>
            <button class="btn danger" id="resetBtn">Reset</button>
          </div>
          <div class="small">Match: <span class="badge">${esc(matchId||"")}</span></div>
        </div>
        <div class="card">
          <div class="hero">
            <div class="heroCornerLeft"><div class="logoMark"><span>ðŸ”¥</span></div><span class="kbd">Killer</span></div>
            <div class="heroMain"><div class="h1 turnTitle3d">Killer Setup</div><div class="sub">Claim your number</div></div>
            <div class="heroCornerRight"><span class="pill">Setup</span></div>
          </div>
          <div class="divider"></div>
          <div class="kTurnBig" style="text-align:center">${esc(p.name)}</div>
          <div class="kTurnSub" style="text-align:center">Pick the number you hit</div>
          <div class="divider"></div>
          <select id="claimNum">${opts}</select>
          <div class="divider"></div>
          <button class="btn ok" id="saveClaim" type="button">Save & Next</button>
        </div>
      `;
    }

    const active=m.players[m.turnIndex];
    const isFinished=!!m.finished;
    const statusLine = isFinished
      ? `Winner: <b>${esc((m.winner && m.winner.name) || "")}</b>`
      : `${esc(active.name)} â€¢ Dart <b>${m.dartInTurn+1}</b>/3 â€¢ ${active.killer ? "ðŸ”¥ Killer" : "Not killer yet"}`;

    const rows = m.players.map(p=>{
      const livesHtml = p.out ? `<span class="lifeOut">OUT</span>` : heartsHTML(p.lives);
      return `
        <tr>
          <td class="l">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <div>
                <div style="font-size:16px;font-weight:1000">${esc(p.name)}</div>
                <div class="small kNumberBig">Number: <b>${esc((p.number!=null?p.number:"?"))}</b></div>
              </div>
              <div style="text-align:right">
                <div class="kLivesBig">${livesHtml}</div>
                <div class="small">${p.killer?"ðŸ”¥ Killer":p.out?"":""}</div>
              </div>
            </div>
          </td>
        </tr>`;
    }).join("");

    const canAttack = (!isFinished) && active.killer;
    const attackTargets = m.players
      .filter(p=>!p.out && p.email!==active.email)
      .map(p=>{
        const label = `${p.name} â€¢ ${(p.number!=null?p.number:"?")} â€¢ ${"â¤ï¸".repeat(Math.max(0,p.lives))}`;
        return `<button class="kAttackBtn" data-attack="${esc(p.email)}" ${canAttack?"":"disabled"}>
          HIT ${esc(p.name)}â€™s DOUBLE â†’ remove 1 life
          <div class="small">${esc(label)}</div>
        </button>`;
      }).join("");

    return `
      <div class="card">
        <div class="row">
          <button class="btn ghost" id="backToSetup">Back</button>
          <button class="btn danger" id="resetBtn">Reset</button>
        </div>
        <div class="small">Match: <span class="badge">${esc(matchId||"")}</span></div>
      </div>

      <div class="card" style="${isFinished?"animation:none":""}">
        <div class="headerStack">
          <div class="headerTopRow">
            <div class="left"><span class="pill">Killer</span></div>
            <div class="right"><span class="pill" ${isFinished?'':'data-live="1"'}>${isFinished?"Ended":"Live"}</span></div>
          </div>
          <div class="headerIcon">ðŸ”¥</div>
          <div class="headerTitle turnTitle3d">Killer</div>
          ${isFinished ? "" : `<div class="turnNameBox" id="turnNameBox">${turnNameHTML(active.name||"")}</div>`}
          ${isFinished ? "" : `<div class="small" style="text-align:center"><span class="badge">NOW THROWING</span></div>`}
          <div class="sub" style="text-align:center;margin-top:6px">${statusLine}</div>
        </div>

        ${isFinished ? "" : `
          <div class="divider"></div>
          <div class="hitRow">
            <button class="hitBtn" id="myDouble">I HIT MY DOUBLE</button>
            <button class="hitBtn miss" id="miss">MISS</button>
            <button class="hitBtn undo" id="undoBtn">UNDO</button>
          </div>
          <div class="divider"></div>
          <div class="pill">Attack Opponents</div>
          <div class="small">Hit their double â†’ tap button to remove 1 life</div>
          <div class="divider"></div>
          <div class="kAttackGrid">
            ${attackTargets || `<div class="sub">No valid targets left.</div>`}
          </div>
        `}
      </div>

      <div class="card">
        <div class="pill">Players & Lives</div>
        <div class="divider"></div>
        <div class="tableWrap"><table><thead><tr><th>Roster</th></tr></thead><tbody>${rows}</tbody></table></div>
      </div>
    `;
  }

  function bindPlay(ctx){
    const m=ctx.match;
    if(!m) return;
    try{ if(m.phase==="play" && !m.finished) animateTurnName("killer", m.players[m.turnIndex].name); }catch{}

    document.getElementById("backToSetup").onclick=()=>{
      match=null; matchId=null;
      try{ if(matchUnsub){ matchUnsub(); matchUnsub=null; } }catch{}
      screen="game.setup"; render();
    };
    document.getElementById("resetBtn").onclick=()=>{
      const pls=m.players.map(p=>({name:p.name,email:p.email}));
      updateMatchTxn(()=>KillerGame.initMatch(pls)).catch(e=>showFatal("Reset error", e?.message||String(e)));
    };

    const claimBtn=document.getElementById("saveClaim");
    if(claimBtn){
      claimBtn.onclick=(ev)=>{
        ev?.preventDefault?.();
        const raw=document.getElementById("claimNum").value;
        const n=parseInt(raw,10);
        if(!n){ alert("Pick a number."); return; }

        updateMatchTxn((mm)=>{
          const p=mm.players[mm.claimIndex];
          if(mm.players.some(x=>x.email!==p.email && x.number===n)) throw new Error("Number taken");
          p.number=n;

          let nextIdx=-1;
          for(let step=1; step<=mm.players.length; step++){
            const i=(mm.claimIndex+step)%mm.players.length;
            if(mm.players[i].number==null){ nextIdx=i; break; }
          }
          if(nextIdx===-1){
            mm.phase="play";
            mm.turnIndex=0;
            mm.dartInTurn=0;
            mm.players.forEach(x=>{ x.out=false; x.killer=false; x.lives=MAX_LIVES; });
            pushSnap(mm);
          }else{
            mm.claimIndex=nextIdx;
          }
          return mm;
        }).catch(e=>alert(e?.message||String(e)));
      };
      return;
    }

    if(m.finished){
      saveFinish(ctx).catch(e=>showFatal("Save error", e?.message||String(e)));
      return;
    }

    function pushK(mm){ mm.snaps=mm.snaps||[]; mm.snaps.push(JSON.stringify(mm)); if(mm.snaps.length>80) mm.snaps.shift(); }
    function popK(mm){
      if(!mm || !mm.snaps || mm.snaps.length<2) return mm;
      mm.snaps.pop();
      const prev=mm.snaps.pop();
      try{return JSON.parse(prev);}catch{return mm;}
    }

    function endDart(mm){
      mm.dartInTurn += 1;
      if(mm.dartInTurn>=3){
        mm.dartInTurn=0;
        mm.turnIndex = nextAliveIndex(mm, mm.turnIndex);
      }
      checkWinner(mm);
      return mm;
    }

    document.getElementById("undoBtn").onclick=()=>updateMatchTxn((mm)=>popK(mm)).catch(e=>showFatal("Undo error", e?.message||String(e)));

    document.getElementById("miss").onclick=()=>{
      playBeep("miss");
      updateMatchTxn((mm)=>{
        pushK(mm);
        return endDart(mm);
      }).then(()=>{
        if(match?.finished && !match._winShown){
          updateMatchTxn((mm)=>{ mm._winShown=true; return mm; }).catch(()=>{});
          playBeep("win"); showWinOverlay("ðŸ† Winner!", (match.winner && match.winner.name) || "");
        }
        if(match?.finished) saveFinish({meUser, match}).catch(()=>{});
      }).catch(e=>showFatal("Update error", e?.message||String(e)));
    };

    document.getElementById("myDouble").onclick=()=>{
      playBeep("hit");
      updateMatchTxn((mm)=>{
        pushK(mm);
        const me=mm.players[mm.turnIndex];
        if(me.number==null) return mm;
        if(!me.killer) me.killer=true;
        else me.lives = Math.min(MAX_LIVES, me.lives+1);
        return endDart(mm);
      }).then(()=>{
        if(match?.finished && !match._winShown){
          updateMatchTxn((mm)=>{ mm._winShown=true; return mm; }).catch(()=>{});
          playBeep("win"); showWinOverlay("ðŸ† Winner!", (match.winner && match.winner.name) || "");
        }
        if(match?.finished) saveFinish({meUser, match}).catch(()=>{});
      }).catch(e=>showFatal("Update error", e?.message||String(e)));
    };

    appEl.querySelectorAll("button[data-attack]").forEach(btn=>{
      btn.onclick=()=>{
        playBeep("hit");
        const victimEmail=btn.getAttribute("data-attack");
        updateMatchTxn((mm)=>{
          const me=mm.players[mm.turnIndex];
          if(!me.killer) return mm;
          const victim=mm.players.find(p=>p.email===victimEmail && !p.out);
          if(!victim) return mm;
          pushK(mm);
          victim.lives -= 1;
          if(victim.lives<=0){ victim.lives=0; victim.out=true; }
          return endDart(mm);
        }).then(()=>{
          if(match?.finished && !match._winShown){
            updateMatchTxn((mm)=>{ mm._winShown=true; return mm; }).catch(()=>{});
            playBeep("win"); showWinOverlay("ðŸ† Winner!", (match.winner && match.winner.name) || "");
          }
          if(match?.finished) saveFinish({meUser, match}).catch(()=>{});
        }).catch(e=>showFatal("Update error", e?.message||String(e)));
      };
    });
  }

  return { initMatch, renderPlay, bindPlay };
})();

const AroundGame = (()=>{
  const TARGETS = Array.from({length:20},(_,i)=>i+1).concat(["B"]);
  const modeName = m => (m.mode==="D" ? "Doubles" : m.mode==="T" ? "Triples" : "Singles");

  function initMatch(selectedPlayers, mode){
    const m={
      gameId:"around",
      mode:(mode==="D"||mode==="T") ? mode : "S",
      players:selectedPlayers.map(p=>({name:p.name,email:p.email,progressIndex:0,dartsThrown:0,hits:0})),
      turnIndex:0, dartInTurn:0,
      finished:false, winner:null,
      startedAt:now(), endedAt:null,
      snaps:[], _saved:false, _winShown:false
    };
    pushSnap(m);
    return m;
  }

  function currentTarget(m, p){ return TARGETS[Math.min(p.progressIndex, TARGETS.length-1)]; }
  function finishIfDone(m, p){
    if(p.progressIndex>=TARGETS.length){
      m.finished=true;
      m.winner={name:p.name,email:p.email};
      m.endedAt=now();
    }
  }
  function endDart(m){
    m.dartInTurn += 1;
    if(m.dartInTurn>=3){
      m.dartInTurn=0;
      m.turnIndex=(m.turnIndex+1)%m.players.length;
    }
  }
  function addThrow(m, wasHit){
    if(!m||m.finished) return;
    const p=m.players[m.turnIndex];
    p.dartsThrown += 1;
    if(wasHit){
      p.hits += 1;
      p.progressIndex += 1;
      finishIfDone(m,p);
      if(m.finished) return;
      // if hit, you keep throwing in same turn (no endDart)
      return;
    }
    endDart(m);
  }

  async function saveFinish(ctx){
    const m=ctx.match;
    if(!m.finished || m._saved) return;
    m._saved=true;
    const winnerName=(m.winner && m.winner.name) || "Unknown";
    const winnerRow=m.players.find(x=>x.email===(m.winner && m.winner.email));
    const winnerDarts=winnerRow ? winnerRow.dartsThrown : null;
    const summary = `ðŸ ${winnerName} wins â€¢ Format: ${modeName(m)}${winnerDarts!=null?` â€¢ ${winnerDarts} darts`:``}`;
    await saveHistoryEntry({
      gameId:"around", gameName:"Around the World",
      startedAt:m.startedAt, endedAt:m.endedAt,
      players:m.players.map(p=>p.email),
      summary,
      meta:{mode:m.mode, winnerEmail:(m.winner && m.winner.email)||null, darts:m.players.map(p=>({email:p.email, dartsThrown:p.dartsThrown, hits:p.hits}))}
    });

    const stats=await getStatsDoc(ctx.meUser.email);
    const games=stats.games||{};
    const g=games.around||{};
    const played=(g.played||0)+1;

    const meRow=m.players.find(p=>p.email===ctx.meUser.email);
    const myDarts=meRow?meRow.dartsThrown:0;
    const myHits=meRow?meRow.hits:0;

    const wins=(g.wins||0) + ((((m.winner && m.winner.email)===ctx.meUser.email)) ? 1 : 0);
    const totalDarts=(g.totalDarts||0)+myDarts;
    const totalHits=(g.totalHits||0)+myHits;

    let bestFewestDarts = g.bestFewestDarts||null;
    if(((m.winner && m.winner.email)===ctx.meUser.email)){
      if(bestFewestDarts==null || myDarts<bestFewestDarts) bestFewestDarts=myDarts;
    }

    await saveStatsDoc(ctx.meUser.email,{
      games:{...games, around:{...g, played, wins, totalDarts, totalHits, bestFewestDarts, lastPlayedAt:m.endedAt||now()}}
    });
  }

  function renderPlay(ctx){
    const m=ctx.match;
    const active=m.players[m.turnIndex];
    const t=currentTarget(m, active);
    const tLabel = (t==="B" ? "BULL" : String(t));
    const isFinished=!!m.finished;

    const statusLine = isFinished
      ? `Winner: <b>${esc((m.winner && m.winner.name) || "")}</b> â€¢ Format: <b>${esc(modeName(m))}</b>`
      : `Target: <span class="targetFlash">${esc(tLabel)}</span> â€¢ Format: <b>${esc(modeName(m))}</b> â€¢ Dart <b>${m.dartInTurn+1}</b>/3`;

    const rows = m.players.map(p=>{
      const ct=currentTarget(m,p);
      const lbl=(ct==="B"?"BULL":String(ct));
      const acc = p.dartsThrown ? Math.round((p.hits/p.dartsThrown)*100) : 0;
      const isAct = p.email===active.email && !isFinished;
      return `
        <tr>
          <td class="l">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <div>
                <div style="font-size:16px;font-weight:1000">${esc(p.name)}${isAct?` <span class="badge">TURN</span>`:""}</div>
                <div class="small">Current target: <b>${esc(lbl)}</b></div>
              </div>
              <div style="text-align:right">
                <div class="small"><b>${esc(p.hits)}</b> hits / <b>${esc(p.dartsThrown)}</b> darts</div>
                <div class="small">Accuracy: <b>${esc(acc)}%</b></div>
              </div>
            </div>
          </td>
        </tr>`;
    }).join("");

    return `
      <div class="card">
        <div class="row">
          <button class="btn ghost" id="backToSetup">Back</button>
          <button class="btn danger" id="resetBtn">Reset</button>
        </div>
        <div class="small">Match: <span class="badge">${esc(matchId||"")}</span></div>
      </div>

      <div class="card" style="${isFinished?"animation:none":""}">
        <div class="headerStack">
          <div class="headerTopRow">
            <div class="left"><span class="pill">Around the World</span></div>
            <div class="right">${isFinished?'<span class="pill">Ended</span>':'<span class="pill" data-live="1">Live</span>'}</div>
          </div>
          <div class="headerIcon">ðŸŒ</div>
          <div class="headerTitle turnTitle3d">Around the World</div>
          <div class="turnNameBox" id="turnNameBox">${turnNameHTML(active.name||"")}</div>
          ${isFinished?'':'<div class="small" style="text-align:center"><span class="badge">NOW THROWING</span></div>'}
          <div class="sub" style="text-align:center;margin-top:6px">${statusLine}</div>
        </div>

        <div class="divider"></div>
        <div class="boardBox">${dartboardSVG(t==="B"?"B":t)}</div>
        ${playerStripHTML(m.players, m.turnIndex, (p)=>"Target: <b>"+esc((currentTarget(m,p)==="B")?"BULL":currentTarget(m,p))+"</b>")}
        <div class="divider"></div>

        ${isFinished ? "" : `
          <div class="hitRow">
            <button class="hitBtn" id="hitBtn">HIT</button>
            <button class="hitBtn miss" id="missBtn">MISS</button>
            <button class="hitBtn undo" id="undoBtn">UNDO</button>
          </div>
        `}
      </div>

      <div class="card">
        <div class="pill">Players</div>
        <div class="divider"></div>
        <div class="tableWrap"><table><thead><tr><th>Progress</th></tr></thead><tbody>${rows}</tbody></table></div>
      </div>
    `;
  }

  function bindPlay(ctx){
    try{ animateTurnName("around", ctx.match.players[ctx.match.turnIndex].name); }catch{}
    const $=(id)=>document.getElementById(id);

    $("backToSetup").onclick=()=>{
      match=null; matchId=null;
      try{ if(matchUnsub){ matchUnsub(); matchUnsub=null; } }catch{}
      screen="game.setup"; render();
    };
    $("resetBtn").onclick=()=>{
      const pls=ctx.match.players.map(p=>({name:p.name,email:p.email}));
      updateMatchTxn(()=>AroundGame.initMatch(pls, ctx.match.mode)).catch(e=>showFatal("Reset error", e?.message||String(e)));
    };

    if(ctx.match.finished){
      saveFinish(ctx).catch(e=>showFatal("Save error", e?.message||String(e)));
      return;
    }

    $("undoBtn").onclick=()=>updateMatchTxn((m)=>popSnap(m)).catch(e=>showFatal("Undo error", e?.message||String(e)));

    $("hitBtn").onclick=()=>{
      playBeep("hit");
      updateMatchTxn((m)=>{
        if(m.finished) return m;
        pushSnap(m);
        addThrow(m,true);
        return m;
      }).then(()=>{
        if(match?.finished && !match._winShown){
          updateMatchTxn((mm)=>{ mm._winShown=true; return mm; }).catch(()=>{});
          playBeep("win"); showWinOverlay("ðŸ† Winner!", (match.winner && match.winner.name) || "");
        }
        if(match?.finished) saveFinish({meUser, match}).catch(()=>{});
      }).catch(e=>showFatal("Update error", e?.message||String(e)));
    };

    $("missBtn").onclick=()=>{
      playBeep("miss");
      updateMatchTxn((m)=>{
        if(m.finished) return m;
        pushSnap(m);
        addThrow(m,false);
        return m;
      }).then(()=>{
        if(match?.finished && !match._winShown){
          updateMatchTxn((mm)=>{ mm._winShown=true; return mm; }).catch(()=>{});
          playBeep("win"); showWinOverlay("ðŸ† Winner!", (match.winner && match.winner.name) || "");
        }
        if(match?.finished) saveFinish({meUser, match}).catch(()=>{});
      }).catch(e=>showFatal("Update error", e?.message||String(e)));
    };
  }

  return { initMatch, renderPlay, bindPlay };
})();

/* ====================== App state & screens ====================== */
let toastMsg="";
let screen="auth";
let meUser=null;
let activeGameId=null;
let match=null;
let statsViewerEmail=null;
let rulesGameId=null;
const MAX_PLAYERS=4;

function initials(name){
  const n=String(name||"").trim();
  if(!n) return "?";
  const parts=n.split(/\\s+/).filter(Boolean);
  const a=((parts[0] && parts[0][0]) || "").toUpperCase();
  const b=((parts[1] && parts[1][0]) || "").toUpperCase();
  return (a+(b||"")).slice(0,2) || a || "?";
}

function rulesFor(gameId){
  if(gameId==="shanghai") return { title:"Shanghai", icon:"ðŸŽ¯", bullets:[
    "Players take turns. Each turn is 3 darts.",
    "Targets go: 20, 19, 18, 17, 16, 15, then BULL.",
    "Score per dart: SINGLE=1, DOUBLE=2, TRIPLE=3, MISS=0.",
    "After everyone throws 3 darts, the target advances.",
    "Game ends after BULL round. Highest total points wins."
  ]};
  if(gameId==="killer") return { title:"Killer", icon:"ðŸ”¥", bullets:[
    "Setup: each player claims a unique number (1â€“20).",
    "Start with 3 lives (â¤ï¸â¤ï¸â¤ï¸).",
    "On your turn you throw 3 darts.",
    "Hit YOUR number as a DOUBLE to become a KILLER (ðŸ”¥).",
    "Once youâ€™re a killer: hit an opponentâ€™s number as a DOUBLE to remove 1 life.",
    "If a player reaches 0 lives, they are OUT.",
    "Last player alive wins."
  ]};
  if(gameId==="around") return { title:"Around the World", icon:"ðŸŒ", bullets:[
    "Choose a format: Singles, Doubles, or Triples.",
    "Players take turns. Each turn is 3 darts.",
    "Targets start at 1 and go to 20, then BULL.",
    "Tap HIT when you hit your current target (based on format).",
    "Each HIT advances you to the next target immediately.",
    "Game ends immediately when someone hits BULL and finishes."
  ]};
  const g=getGame(gameId);
  return { title:(g&&g.name)||"Game", icon:(g&&g.icon)||"ðŸŽ¯", bullets:["Rules coming soon."]};
}

/* ===== Player strip ===== */
function playerStripHTML(players, activeIndex, extraLineFn){
  try{
    return `<div class="playerStrip">` + (players||[]).map((p,i)=>{
      const act=(i===activeIndex);
      const extra=extraLineFn ? (extraLineFn(p,i)||"") : "";
      return `<div class="playerChip ${act?'active':''}">
        <div class="nm">${esc(p.name||"")}</div>
        <div class="sub">${act ? "NOW THROWING" : "&nbsp;"}</div>
        ${extra?`<div class="small" style="margin-top:4px">${extra}</div>`:""}
      </div>`;
    }).join("") + `</div>`;
  }catch(_){ return ""; }
}

/* ====================== Screens ====================== */
async function renderAuth(){
  signOutBtn.style.display="none";
  brandTitle.textContent="Game Night";

  let html = `${toastMsg?`<div class="toast">${esc(toastMsg)}</div>`:""}`;
  toastMsg="";

  html += `
    <div class="card">
      <div class="hero">
        <div class="heroCornerLeft"><div class="logoMark"><span>ðŸŽ¯</span></div></div>
        <div class="heroMain" style="text-align:left;align-items:flex-start">
          <div class="h1">Game Night</div>
          <div class="sub">ONLINE shared build â€” everyone sees the same roster and live matches.</div>
        </div>
        <div class="heroCornerRight"><span class="pill">Darts</span></div>
      </div>
      <div class="divider"></div>
      <div class="sub">Tip: Everyone (you, your brother, Jace) signs in with their own email on their own device.</div>
    </div>

    <div class="card">
      <label>Email</label>
      <div class="stack">
        <input id="inEmail" type="email" placeholder="you@email.com" autocomplete="email"/>
        <button class="btn ok" id="goBtn">Enter</button>
      </div>
    </div>
  `;
  setHTML(html);

  document.getElementById("goBtn").onclick=async()=>{
    const e=normEmail(document.getElementById("inEmail").value);
    if(!e){ toastMsg="Enter a valid email."; return render(); }
    try{
      const player=await signInEmail(e);
      if(player && !player.deleted){
        meUser=player;
        statsViewerEmail=meUser.email;
        screen="home";
        return render();
      }
      meUser={email:e};
      screen="signup";
      return render();
    }catch(err){
      showFatal("Sign-in error", err?.message||String(err));
    }
  };
}

async function renderSignup(){
  signOutBtn.style.display="none";
  brandTitle.textContent="Game Night";

  setHTML(`
    <div class="card">
      <div class="hero">
        <div class="heroCornerLeft"><div class="logoMark"><span>ðŸ§¾</span></div></div>
        <div class="heroMain"><div class="h1">Create Player</div><div class="sub">Just your name â€” youâ€™re in.</div></div>
        <div class="heroCornerRight"></div>
      </div>
    </div>

    <div class="card">
      <label>Name</label>
      <div class="stack">
        <input id="upName" type="text" placeholder="Your Name" autocomplete="name"/>
        <button class="btn ok" id="createBtn">Create</button>
        <button class="btn ghost" id="backBtn">Back</button>
      </div>
    </div>
  `);

  document.getElementById("backBtn").onclick=()=>{ meUser=null; screen="auth"; render(); };

  document.getElementById("createBtn").onclick=async()=>{
    const n=String(document.getElementById("upName").value).trim();
    if(!n){ toastMsg="Enter your name."; return render(); }
    try{
      meUser=await signUpEmail(n, meUser.email);
      statsViewerEmail=meUser.email;
      screen="home";
      render();
    }catch(err){
      showFatal("Create player error", err?.message||String(err));
    }
  };
}

async function renderHome(){
  signOutBtn.style.display="inline-block";
  brandTitle.textContent="Game Night";

  const players=(await getPlayers()).filter(p=>!p.deleted);
  startPresence(meUser.email);

  const gameCards = Games.map(g=>{
    return `
      <div class="gameCard">
        <div class="gameHead">
          <div class="gameTitle">
            <div class="gameIcon">${esc(g.icon||"ðŸŽ¯")}</div>
            <div>
              <div class="h1" style="font-size:18px;margin:0">${esc(g.name)}</div>
              <div class="gameMeta">${esc(g.tagline||"")}</div>
            </div>
          </div>
          <div><span class="pill" data-live="1">Active</span></div>
        </div>
        <div class="gameActions">
          <button class="btn ok" data-play="${esc(g.id)}">Play</button>
          <button class="btn ghost" data-stats="${esc(g.id)}">Stats</button>
        </div>
      </div>
    `;
  }).join("");

  const roster = players
    .slice()
    .sort((a,b)=> (a.email===meUser.email?-1:0) - (b.email===meUser.email?-1:0))
    .map(p=>`
      <div class="rosterCard">
        <div class="rosterLeft">
          <div class="avatar ${isOnline(p.email)?"online":""}">${esc(initials(p.name))}</div>
          <div>
            <div class="rosterName">${esc(p.name)}${p.email===meUser.email?` <span class="badge">YOU</span>`:""}</div>
            <div class="rosterSub">${esc(p.email)}</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap">
          <button class="btn ghost" data-view-player="${esc(p.email)}">View stats</button>
        </div>
      </div>
    `).join("");

  setHTML(`
    <div class="card">
      <div class="hero">
        <div class="heroCornerLeft"><div class="logoMark"><span>ðŸ‘¤</span></div></div>
        <div class="heroMain" style="text-align:left;align-items:flex-start">
          <div class="h1">${esc(meUser.name||"Player")}</div>
          <div class="sub">${esc(meUser.email)}</div>
        </div>
        <div class="heroCornerRight"><span class="pill" data-live="1">Signed in</span></div>
      </div>
    </div>

    <div class="row">
      <button class="btn ghost" id="rulesBtn">Game rules</button>
      <button class="btn ghost" id="statsBtn">Stats</button>
      <button class="btn ghost" id="historyBtn">History</button>
    </div>

    <div class="divider"></div>
    <div class="gameGrid">${gameCards}</div>

    <div class="divider"></div>

    <div class="card">
      <div class="hero">
        <div class="heroCornerLeft"><div class="logoMark"><span>ðŸ‘¥</span></div></div>
        <div class="heroMain" style="text-align:left;align-items:flex-start">
          <div class="h1">Players</div>
          <div class="sub">Green dot = recently online.</div>
        </div>
        <div class="heroCornerRight"></div>
      </div>
      <div class="divider"></div>
      <div class="rosterGrid">${roster || `<div class="sub">No other players yet.</div>`}</div>
    </div>
  `);

  document.getElementById("rulesBtn").onclick=()=>{ screen="rules"; render(); };
  document.getElementById("statsBtn").onclick=()=>{ screen="stats"; render(); };
  document.getElementById("historyBtn").onclick=()=>{ screen="history"; render(); };

  appEl.querySelectorAll("button[data-play]").forEach(btn=>{
    btn.onclick=()=>{
      activeGameId=btn.getAttribute("data-play");
      match=null;
      screen="game.setup";
      render();
    };
  });
  appEl.querySelectorAll("button[data-stats]").forEach(btn=>{
    btn.onclick=()=>{
      activeGameId=btn.getAttribute("data-stats");
      screen="stats.game";
      render();
    };
  });
  appEl.querySelectorAll("button[data-view-player]").forEach(btn=>{
    btn.onclick=()=>{
      statsViewerEmail=btn.getAttribute("data-view-player");
      screen="stats";
      render();
    };
  });
}

async function renderRules(){
  signOutBtn.style.display="inline-block";
  brandTitle.textContent="Game rules";

  setHTML(`
    <div class="card">
      <div class="hero">
        <div class="heroCornerLeft"><div class="logoMark"><span>ðŸ“œ</span></div></div>
        <div class="heroMain"><div class="h1">Game rules</div><div class="sub">Pick a game to see how to play.</div></div>
        <div class="heroCornerRight"></div>
      </div>
      <div class="divider"></div>
      ${Games.map(g=>`
        <div class="rosterCard">
          <div class="rosterLeft">
            <div class="avatar">${esc(g.icon||"ðŸŽ¯")}</div>
            <div><div class="rosterName">${esc(g.name)}</div><div class="rosterSub">Active</div></div>
          </div>
          <button class="btn" data-rule="${esc(g.id)}">Open</button>
        </div>
      `).join("")}
      <div class="divider"></div>
      <button class="btn ghost" id="rulesBack">Back</button>
    </div>
  `);
  document.getElementById("rulesBack").onclick=()=>{ screen="home"; render(); };
  appEl.querySelectorAll("button[data-rule]").forEach(btn=>{
    btn.onclick=()=>{ rulesGameId=btn.getAttribute("data-rule"); screen="rules.game"; render(); };
  });
}

async function renderRulesGame(){
  signOutBtn.style.display="inline-block";
  const r=rulesFor(rulesGameId);
  brandTitle.textContent=`${r.title} â€¢ Rules`;
  setHTML(`
    <div class="card">
      <div class="hero">
        <div class="heroCornerLeft"><div class="logoMark"><span>${esc(r.icon)}</span></div></div>
        <div class="heroMain"><div class="h1">${esc(r.title)}</div><div class="sub">How to play</div></div>
        <div class="heroCornerRight"></div>
      </div>
      <div class="divider"></div>
      <ul style="margin:0;padding-left:18px;line-height:1.5">
        ${r.bullets.map(b=>`<li style="margin:10px 0">${esc(b)}</li>`).join("")}
      </ul>
      <div class="divider"></div>
      <button class="btn ghost" id="rulesGameBack">Back</button>
    </div>
  `);
  document.getElementById("rulesGameBack").onclick=()=>{ screen="rules"; render(); };
}

async function renderGameSetup(){
  const g=getGame(activeGameId);
  if(!g){ screen="home"; return render(); }

  signOutBtn.style.display="inline-block";
  brandTitle.textContent=g.name;

  const players=(await getPlayers()).filter(p=>!p.deleted);
  startPresence(meUser.email);

  const meEmail=meUser.email;
  const defaultCount=2;

  const aroundModeUI = (activeGameId==="around") ? `
    <div class="divider"></div>
    <label>Format (Singles / Doubles / Triples)</label>
    <select id="aroundMode">
      <option value="S" selected>Singles</option>
      <option value="D">Doubles</option>
      <option value="T">Triples</option>
    </select>
    <div class="small">Pick the format before starting.</div>
  ` : "";

  setHTML(`
    <div class="card"><div class="row"><button class="btn ghost" id="setupBack">Back</button></div></div>

    <div class="card">
      <div class="hero">
        <div class="heroCornerLeft">
          <div class="logoMark"><span>${esc(g.icon || "ðŸŽ¯")}</span></div>
          <span class="kbd">${esc(g.name)}</span>
        </div>
        <div class="heroMain">
          <div class="h1">${esc(g.name)}</div>
          <div class="sub">Choose players (max ${MAX_PLAYERS}). Select exactly the number you choose.</div>
        </div>
        <div class="heroCornerRight"><span class="pill" data-live="1">Ready</span></div>
      </div>
    </div>

    <div class="card">
      <div class="stack">
        <div class="row">
          <div>
            <label>Number of players</label>
            <select id="playerCount">
              ${Array.from({length:MAX_PLAYERS},(_,i)=>i+1).map(n=>`<option value="${n}" ${n===defaultCount?"selected":""}>${n}</option>`).join("")}
            </select>
          </div>
          <div>
            <label>Selected</label>
            <input id="selectedCount" type="text" value="0 / ${defaultCount}" disabled />
          </div>
        </div>

        <label>Pick players</label>
        <select id="matchPlayers" multiple size="6">
          ${players.map(p=>`<option value="${esc(p.email)}">${esc(p.name)}</option>`).join("")}
        </select>

        ${aroundModeUI}

        <button class="btn ok" id="startMatchBtn" disabled>Start Match (Online)</button>
        <div class="sub" id="hintLine">Select exactly ${defaultCount} players to continue.</div>

        <div class="divider"></div>
        <label>Join an existing match (paste Match ID)</label>
        <div class="row">
          <input id="joinId" type="text" placeholder="Match ID"/>
          <button class="btn" id="joinBtn" type="button">Join</button>
        </div>
        <div class="small">If your brother started the match, paste the Match ID here and hit Join.</div>
      </div>
    </div>
  `);

  const selectEl=document.getElementById("matchPlayers");
  Array.from(selectEl.options).forEach(o=>{ if(o.value===meEmail) o.selected=true; });

  function updateStartState(){
    const n=parseInt(document.getElementById("playerCount").value,10);
    const selectedEmails=Array.from(selectEl.selectedOptions).map(o=>o.value);
    document.getElementById("selectedCount").value=`${selectedEmails.length} / ${n}`;
    const ok=(selectedEmails.length===n);
    document.getElementById("startMatchBtn").disabled=!ok;
    document.getElementById("hintLine").textContent= ok ? "Ready." : `Select exactly ${n} players to continue.`;
  }
  document.getElementById("playerCount").onchange=updateStartState;
  selectEl.onchange=updateStartState;
  updateStartState();

  document.getElementById("setupBack").onclick=()=>{ activeGameId=null; match=null; screen="home"; render(); };

  document.getElementById("startMatchBtn").onclick=async()=>{
    const n=parseInt(document.getElementById("playerCount").value,10);
    const selectedEmails=Array.from(selectEl.selectedOptions).map(o=>o.value);
    if(selectedEmails.length!==n){ toastMsg=`You must select exactly ${n} players.`; return render(); }
    const selectedPlayers=selectedEmails.map(e=>players.find(p=>p.email===e)).filter(Boolean);

    let m=null;
    if(activeGameId==="shanghai") m=ShanghaiGame.initMatch(selectedPlayers);
    if(activeGameId==="killer") m=KillerGame.initMatch(selectedPlayers);
    if(activeGameId==="around"){
      const mode=document.getElementById("aroundMode")?.value || "S";
      m=AroundGame.initMatch(selectedPlayers, mode);
    }
    if(!m){ toastMsg="Unknown game."; return render(); }

    try{
      const id=await createMatchDoc(m);
      subscribeMatch(id);
      screen="game.play";
      render();
      // Show match ID so you can send it to your brother/Jace.
      try{ navigator.clipboard?.writeText(id); }catch(_){}
      toastMsg="Match created. Match ID copied (if supported).";
    }catch(err){
      showFatal("Create match error", err?.message||String(err));
    }
  };

  document.getElementById("joinBtn").onclick=()=>{
    const id=String(document.getElementById("joinId").value||"").trim();
    if(!id){ toastMsg="Paste a Match ID."; return render(); }
    subscribeMatch(id);
    screen="game.play";
    render();
  };
}

async function renderGamePlay(){
  const g=getGame(activeGameId);
  if(!g || !match){ screen="home"; return render(); }

  signOutBtn.style.display="inline-block";
  brandTitle.textContent=g.name;

  // Ensure we infer gameId from match too (when joining)
  activeGameId = match.gameId;

  const ctx={meUser, match};
  if(activeGameId==="shanghai"){ setHTML(ShanghaiGame.renderPlay(ctx)); ShanghaiGame.bindPlay(ctx); return; }
  if(activeGameId==="killer"){ setHTML(KillerGame.renderPlay(ctx)); KillerGame.bindPlay(ctx); return; }
  if(activeGameId==="around"){ setHTML(AroundGame.renderPlay(ctx)); AroundGame.bindPlay(ctx); return; }

  screen="home"; render();
}

async function renderStats(){
  signOutBtn.style.display="inline-block";
  brandTitle.textContent="Stats";

  const players=(await getPlayers()).filter(p=>!p.deleted);
  if(!statsViewerEmail) statsViewerEmail=meUser.email;

  const statsDoc=await getStatsDoc(statsViewerEmail);
  const games=statsDoc.games||{};
  const viewer=players.find(p=>p.email===statsViewerEmail)||meUser;

  function aroundLine(gs){
    const played=gs.played||0;
    const wins=gs.wins||0;
    const td=gs.totalDarts||0;
    const th=gs.totalHits||0;
    const acc=td?Math.round((th/td)*100):0;
    const best=gs.bestFewestDarts!=null?gs.bestFewestDarts:"â€”";
    return `Played: <b>${played}</b> â€¢ Wins: <b>${wins}</b> â€¢ Accuracy: <b>${acc}%</b> â€¢ Best: <b>${esc(best)}</b>`;
  }

  setHTML(`
    <div class="card">
      <div class="hero">
        <div class="heroCornerLeft"><div class="logoMark"><span>ðŸ“ˆ</span></div></div>
        <div class="heroMain"><div class="h1">Stats</div><div class="sub">Pick a player, then pick a game.</div></div>
        <div class="heroCornerRight"></div>
      </div>
      <div class="divider"></div>
      <label>Player</label>
      <select id="statsPlayer">
        ${players.map(p=>`<option value="${esc(p.email)}" ${p.email===statsViewerEmail?"selected":""}>${esc(p.name)}</option>`).join("")}
      </select>
      <div class="small">Viewing: <b>${esc(viewer.name||"Player")}</b></div>
      <div class="divider"></div>
      <div class="row">
        <button class="btn danger" id="resetAllStatsBtn">Reset stats</button>
      </div>
      <div class="small">Reset clears this playerâ€™s stats.</div>
    </div>

    ${Games.map(g=>{
      const gs=games[g.id]||{};
      const played=gs.played||0;
      const line =
        g.id==="shanghai"
          ? `Played: <b>${played}</b> â€¢ Best: <b>${esc(gs.best||0)}</b> â€¢ Points: <b>${esc(gs.points||0)}</b>`
        : g.id==="killer"
          ? `Played: <b>${played}</b> â€¢ Wins: <b>${esc(gs.wins||0)}</b>`
        : g.id==="around"
          ? aroundLine(gs)
        : `Played: <b>${played}</b>`;
      return `
        <div class="gameCard">
          <div class="gameHead">
            <div class="gameTitle">
              <div class="gameIcon">${esc(g.icon||"ðŸŽ¯")}</div>
              <div>
                <div class="h1" style="font-size:18px;margin:0">${esc(g.name)}</div>
                <div class="gameMeta">${line}</div>
              </div>
            </div>
            <button class="btn" data-open="${esc(g.id)}">Open</button>
          </div>
        </div>
      `;
    }).join("")}

    <div class="row">
      <button class="btn ghost" id="statsBack">Back</button>
    </div>
  `);

  document.getElementById("statsBack").onclick=()=>{ screen="home"; render(); };
  document.getElementById("statsPlayer").onchange=(e)=>{ statsViewerEmail=e.target.value; render(); };

  document.getElementById("resetAllStatsBtn").onclick=async()=>{
    const email=statsViewerEmail;
    const p=players.find(x=>x.email===email);
    const name=(p&&p.name)||email;
    if(!confirm(`Reset ALL stats for ${name}?`)) return;
    try{ await resetStatsAll(email); toastMsg=`Stats reset for ${name}.`; render(); }
    catch(e){ showFatal("Reset error", e?.message||String(e)); }
  };

  appEl.querySelectorAll("button[data-open]").forEach(btn=>{
    btn.onclick=()=>{ activeGameId=btn.getAttribute("data-open"); screen="stats.game"; render(); };
  });
}

async function renderStatsGame(){
  const g=getGame(activeGameId);
  if(!g){ screen="stats"; return render(); }
  signOutBtn.style.display="inline-block";
  brandTitle.textContent=`${g.name} â€¢ Stats`;

  const players=(await getPlayers()).filter(p=>!p.deleted);
  if(!statsViewerEmail) statsViewerEmail=meUser.email;

  const viewer=players.find(p=>p.email===statsViewerEmail)||meUser;
  const statsDoc=await getStatsDoc(statsViewerEmail);
  const gs=(statsDoc.games||{})[g.id]||{};

  let body="";
  if(g.id==="shanghai"){
    body=`<div class="sub">Played: <b>${esc(gs.played||0)}</b></div>
      <div class="sub">Points: <b>${esc(gs.points||0)}</b></div>
      <div class="sub">Best game: <b>${esc(gs.best||0)}</b></div>
      <div class="sub">Last played: <b>${esc(gs.lastPlayedAt?fmt(gs.lastPlayedAt):"â€”")}</b></div>`;
  }else if(g.id==="killer"){
    body=`<div class="sub">Played: <b>${esc(gs.played||0)}</b></div>
      <div class="sub">Wins: <b>${esc(gs.wins||0)}</b></div>
      <div class="sub">Last played: <b>${esc(gs.lastPlayedAt?fmt(gs.lastPlayedAt):"â€”")}</b></div>`;
  }else if(g.id==="around"){
    const played=gs.played||0, wins=gs.wins||0, td=gs.totalDarts||0, th=gs.totalHits||0;
    const acc=td?Math.round((th/td)*100):0;
    const best=gs.bestFewestDarts!=null?gs.bestFewestDarts:"â€”";
    body=`<div class="sub">Played: <b>${esc(played)}</b></div>
      <div class="sub">Wins: <b>${esc(wins)}</b></div>
      <div class="sub">Total darts: <b>${esc(td)}</b></div>
      <div class="sub">Total hits: <b>${esc(th)}</b></div>
      <div class="sub">Accuracy: <b>${esc(acc)}%</b></div>
      <div class="sub">Best (fewest darts to win): <b>${esc(best)}</b></div>
      <div class="sub">Last played: <b>${esc(gs.lastPlayedAt?fmt(gs.lastPlayedAt):"â€”")}</b></div>`;
  }

  setHTML(`
    <div class="card">
      <div class="hero">
        <div class="heroCornerLeft"><div class="logoMark"><span>${esc(g.icon||"ðŸŽ¯")}</span></div><span class="kbd">${esc(g.name)}</span></div>
        <div class="heroMain"><div class="h1">${esc(g.name)}</div><div class="sub">Player: <b>${esc(viewer.name||"Player")}</b></div></div>
        <div class="heroCornerRight"></div>
      </div>
      <div class="divider"></div>
      ${body}
      <div class="divider"></div>
      <div class="row">
        <button class="btn danger" id="resetGameStatsBtn">Reset this game</button>
        <button class="btn ghost" id="statsGameBack">Back</button>
      </div>
    </div>
  `);

  document.getElementById("resetGameStatsBtn").onclick=async()=>{
    const email=statsViewerEmail;
    const p=players.find(x=>x.email===email);
    const name=(p&&p.name)||email;
    if(!confirm(`Reset ${g.name} stats for ${name}?`)) return;
    try{ await resetStatsGame(email, g.id); toastMsg=`${g.name} stats reset for ${name}.`; render(); }
    catch(e){ showFatal("Reset error", e?.message||String(e)); }
  };
  document.getElementById("statsGameBack").onclick=()=>{ screen="stats"; render(); };
}

async function renderHistory(){
  signOutBtn.style.display="inline-block";
  brandTitle.textContent="History";

  const history=await getHistory(meUser.email);
  let items=history.map(h=>`
    <div class="card">
      <div class="h1" style="font-size:16px;margin:0">${esc(h.summary||"(no summary)")}</div>
      <div class="sub">${esc(h.gameName||h.gameId||"Game")} â€¢ ${esc(h.endedAt?fmt(h.endedAt):"")}</div>
    </div>
  `).join("");
  if(!items) items=`<div class="card"><div class="sub">No matches yet.</div></div>`;

  setHTML(`
    <div class="row">
      <button class="btn ghost" id="historyBack">Back</button>
    </div>
    <div class="divider"></div>
    ${items}
  `);

  document.getElementById("historyBack").onclick=()=>{ screen="home"; render(); };
}

/* ====================== Render loop ====================== */
window.__renderReason="nav";
function requestRender(reason){ window.__renderReason=reason||"nav"; render(); }

async function render(){
  if(window.__rendering){ window.__renderAgain=true; return; }
  window.__rendering=true;
  try{
    window.__screenChanged = (window.__lastScreen !== screen);
    window.__lastScreen = screen;

    homeBtn.onclick=()=>{ screen=meUser?"home":"auth"; render(); };

    if(soundBtn){
      soundBtn.onclick=()=>{
        try{ unlockAudio(); }catch(_){}
        const wasOn=!!soundEnabled;
        if(wasOn) playBeep("toggle");
        setSoundEnabled(!soundEnabled);
        if(!wasOn) playBeep("toggle");
      };
      setSoundEnabled(soundEnabled);
    }

    signOutBtn.onclick=()=>{
      stopPresence();
      meUser=null; match=null; activeGameId=null; statsViewerEmail=null; rulesGameId=null;
      matchId=null;
      try{ if(matchUnsub){ matchUnsub(); matchUnsub=null; } }catch{}
      screen="auth"; render();
    };

    if(screen==="auth") return renderAuth();
    if(screen==="signup") return renderSignup();
    if(!meUser){ screen="auth"; return renderAuth(); }

    if(screen==="home") return renderHome();
    if(screen==="rules") return renderRules();
    if(screen==="rules.game") return renderRulesGame();
    if(screen==="game.setup") return renderGameSetup();
    if(screen==="game.play") return renderGamePlay();
    if(screen==="stats") return renderStats();
    if(screen==="stats.game") return renderStatsGame();
    if(screen==="history") return renderHistory();

    screen="home"; return renderHome();
  }catch(e){
    showFatal("App error", e?.message||String(e));
  }finally{
    window.__rendering=false;
    window.__renderReason="nav";
    if(window.__renderAgain){ window.__renderAgain=false; render(); }
  }
}

/* ====================== Boot ====================== */
async function boot(){
  try{
    setHTML(`<div class="card"><div class="h1">Loadingâ€¦</div><div class="sub">Starting Game Nightâ€¦</div></div>`);
    
    await ensureAuth();
render();
  }catch(err){
    showFatal("Canâ€™t start app", err?.message||String(err));
  }
}
boot();
</script>
</body>
</html>
