<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Game Night Darts</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#0b1a2e; --text:#eaf2ff; --muted:#b9cbe5;
  --accent:#4ea8ff; --danger:#ff4d5a; --ok:#2bd576;
  --shadow: rgba(0,0,0,.25);
}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:radial-gradient(1200px 700px at 40% 0%, #10335f 0%, var(--bg) 55%);
  color:var(--text);
}
.topbar{
  position:sticky;top:0;z-index:10;
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:12px 14px;background:rgba(10,20,35,.78);backdrop-filter:blur(10px);
  border-bottom:1px solid rgba(255,255,255,.08);
}
.brand{display:flex;flex-direction:column;line-height:1.05}
.brand .t{font-weight:900;font-size:16px}
.brand .s{font-size:12px;color:var(--muted)}
.btn{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.08); color:var(--text);
  border-radius:14px;padding:10px 12px;font-weight:900;
  box-shadow:0 6px 16px var(--shadow);
}
.btn:active{transform:translateY(1px)}
.btn.ghost{background:transparent;box-shadow:none;color:var(--muted)}
.btn.ok{background:rgba(43,213,118,.20);border-color:rgba(43,213,118,.35)}
.btn.danger{background:rgba(255,77,90,.20);border-color:rgba(255,77,90,.35)}
.wrap{max-width:920px;margin:0 auto;padding:14px}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;padding:14px;
  box-shadow:0 10px 28px rgba(0,0,0,.28);
  margin-bottom:12px;
}
.h1{font-size:24px;font-weight:1000;margin:2px 0 6px}
.sub{color:var(--muted);font-size:13px}
label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
input, select{
  width:100%;background:rgba(10,20,35,.65);
  border:1px solid rgba(255,255,255,.14);
  color:var(--text);border-radius:14px;padding:12px;font-size:16px;outline:none;
}
.row{display:flex;gap:10px}
.row > *{flex:1}
.stack{display:flex;flex-direction:column;gap:10px}
.toast{
  background:rgba(255,77,90,.12);
  border:1px solid rgba(255,77,90,.30);
  color:#ffd6da;border-radius:14px;padding:10px 12px;font-weight:900;margin-bottom:12px;
}
.pill{
  display:inline-block;padding:6px 10px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(78,168,255,.08);color:var(--accent);
  font-weight:900;font-size:12px;
}
.divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
.boardBox{
  width:80%;height:250px;border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background:radial-gradient(circle at 50% 40%, rgba(78,168,255,.10), rgba(0,0,0,.12) 55%, rgba(0,0,0,.22));
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
  box-shadow: inset 0 0 40px rgba(0,0,0,.35);
}
.hitRow{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.hitBtn{
  border-radius:16px;padding:14px 10px;border:1px solid rgba(255,255,255,.14);
  background:rgba(78,168,255,.16); color:var(--text);
  font-weight:1000;font-size:16px; box-shadow:0 10px 24px rgba(0,0,0,.25);
}
.hitBtn:active{transform:translateY(1px)}
.hitBtn.miss{background:rgba(255,77,90,.18);border-color:rgba(255,77,90,.30)}
.hitBtn.undo{background:rgba(255,255,255,.08);color:var(--muted)}
.hitBtn.next{background:rgba(43,213,118,.18);border-color:rgba(43,213,118,.30)}
.small{font-size:12px;color:var(--muted)}
table{border-collapse:collapse;width:100%;min-width:0;background:rgba(0,0,0,.14)}
th,td{padding:6px 6px;border-bottom:1px solid rgba(255,255,255,.08);text-align:center;font-size:12px}
th{font-size:12px;color:var(--muted);font-weight:1000;background:rgba(255,255,255,.05)}
td.l{text-align:left}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);font-size:12px;color:var(--muted)}
.activeCell{outline:2px solid rgba(78,168,255,.55);outline-offset:-2px;border-radius:10px}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi .box{flex:1;min-width:150px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:10px}
.kpi .box .v{font-weight:1000;font-size:20px}
.kpi .box .l{font-size:12px;color:var(--muted)}
.barRow{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.10)}
.barRow:last-child{border-bottom:none}
.barLabel{width:56px;font-weight:1000;color:#dfe9ff}
.barOuter{flex:1;height:12px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);overflow:hidden}
.barInner{height:100%;background:rgba(78,168,255,.55)}
.barVal{width:70px;text-align:right;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="topbar">
  <div class="brand">
    <div class="t">Game Night Darts</div>
    <div class="s">The Dart Room presents • Developed & designed by Steve’s Graphic Designs</div>
  </div>
  <div>
    <button class="btn ghost" id="homeBtn" type="button">Home</button>
    <button class="btn ghost" id="signOutBtn" type="button" style="display:none;">Sign out</button>
  </div>
</div>

<div class="wrap" id="app"></div>

<script>
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_MESSAGING_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(); const db=firebase.firestore();

const appEl=document.getElementById("app");
const homeBtn=document.getElementById("homeBtn");
const signOutBtn=document.getElementById("signOutBtn");

let toastMsg=""; let screen="auth"; let meUser=null; let match=null;

function esc(s){s=String(s||"");return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
function now(){return new Date().getTime();}
function pts(hit){return hit==="T"?3:hit==="D"?2:hit==="S"?1:0;}
function targetLabel(t){return t==="B"?"BULL":String(t);}

async function getPlayers(){ const snapshot=await db.collection("players").get(); return snapshot.docs.map(d=>d.data()); }
async function upsertPlayer(name,email){ await db.collection("players").doc(email).set({name,email,createdAt:now()},{merge:true}); }
async function getStats(email){ const doc=await db.collection("stats").doc(email).get(); return doc.exists?doc.data():{}; }
async function saveStats(email,data){ await db.collection("stats").doc(email).set(data,{merge:true}); }
async function getHistory(email){ const snapshot=await db.collection("history").where("players","array-contains",email).orderBy("endedAt","desc").limit(60).get(); return snapshot.docs.map(d=>d.data()); }
async function saveHistoryEntry(entry){ await db.collection("history").add(entry); }

auth.onAuthStateChanged(user=>{ meUser=user; screen=user?"home":"auth"; render(); });

async function signUp(name,email){
  try{ 
    const res = await auth.signInAnonymously(); // no password, just sign in
    meUser={email,name}; 
    await upsertPlayer(name,email); 
    screen="home"; render();
  }catch(e){ toastMsg=e.message; render(); }
}
async function signIn(email){
  const snapshot=await db.collection("players").doc(email).get();
  if(snapshot.exists){ meUser={email:snapshot.data().email,name:snapshot.data().name}; screen="home"; render(); }
  else{ screen="signup"; render(); }
}
async function signOutF(){ await auth.signOut(); meUser=null; screen="auth"; render(); }

homeBtn.onclick=()=>{screen=meUser?"home":"auth"; render();}
signOutBtn.onclick=async()=>{await signOutF();};

function dartboardSVG(activeNumber){
  const cx=100,cy=100; const outer=90; const r=80; const seg=360/20;
  const nums=[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];
  let paths=""; for(let i=0;i<20;i++){
    const a0=i*seg; const a1=(i+1)*seg;
    const highlight=(activeNumber===nums[i])?"rgba(255,255,0,.6)":"rgba(78,168,255,.16)";
    const rad0=(Math.PI/180)*a0; const rad1=(Math.PI/180)*a1;
    paths+='<path d="M100,100 L'+(100+r*Math.cos(rad0))+','+(100+r*Math.sin(rad0))+' L'+(100+r*Math.cos(rad1))+','+(100+r*Math.sin(rad1))+' Z" fill="'+highlight+'"/>';
  }
  let numText=""; for(let i=0;i<20;i++){ const ang=i*seg+seg/2; const rad=(Math.PI/180)*ang; const x=100+r*Math.cos(rad); const y=100+r*Math.sin(rad); numText+='<text x="'+x+'" y="'+y+'" text-anchor="middle" dominant-baseline="middle" font-size="8.5" fill="#dfe9ff" font-weight="900">'+nums[i]+'</text>'; }
  return '<svg viewBox="0 0 200 200" width="94%">'+paths+'<circle cx="100" cy="100" r="10" fill="#c63a3a"/>'+numText+'</svg>';
}

async function render(){
  let html=""; if(toastMsg){ html+='<div class="toast">'+esc(toastMsg)+'</div>'; toastMsg=""; }

  if(screen==="auth"){
    html+='<div class="card"><div class="h1">Enter Email</div></div>'+
    '<div class="card"><input type="email" id="inEmail" placeholder="you@email.com"/>'+
    '<button class="btn" id="goBtn">Go</button></div>';
    appEl.innerHTML=html;
    document.getElementById("goBtn").onclick=()=>signIn(document.getElementById("inEmail").value.trim());
    return;
  }

  if(screen==="signup"){
    html+='<div class="card"><div class="h1">Create Player</div></div>'+
    '<div class="card"><input type="text" id="inName" placeholder="Your Name"/>'+
    '<button class="btn ok" id="createBtn">Create Player</button></div>';
    appEl.innerHTML=html;
    document.getElementById("createBtn").onclick=()=>signUp(document.getElementById("inName").value,document.getElementById("inEmail").value);
    return;
  }

  if(screen==="home"){
    const p=meUser;
    html+='<div class="card"><span class="pill">Signed in</span><div class="h1">'+esc(p.name)+'</div><div class="sub">'+esc(p.email)+'</div></div>'+
    '<div class="row"><button class="btn" id="playNowBtn">Play Now</button></div>';
    appEl.innerHTML=html;
    document.getElementById("playNowBtn").onclick=()=>{screen="match"; render();};
    signOutBtn.style.display="inline-block";
    return;
  }

  if(screen==="match"){
    html+='<div class="card"><span class="pill">Match Setup</span><div class="sub">Select Opponent (current implementation uses dropdown)</div></div>'+
    '<div class="card"><select id="oppSel"><option value="">Select opponent…</option></select>'+
    '<button class="btn ok" id="startBtn">Start Game</button></div>';
    appEl.innerHTML=html;

    // populate opponents
    const allPlayers=await getPlayers();
    const sel=document.getElementById("oppSel");
    allPlayers.forEach(pl=>{if(pl.email!==meUser.email){let opt=document.createElement("option"); opt.value=pl.email; opt.textContent=pl.name; sel.appendChild(opt);}});

    document.getElementById("startBtn").onclick=()=>{
      const oppEmail=sel.value; if(!oppEmail){toastMsg="Select opponent"; render(); return;}
      const opp=allPlayers.find(p=>p.email===oppEmail);
      match={players:[meUser,opp],turnIndex:0,targetIndex:0,dartInTurn:0,grid:{},finished:false,snaps:[]};
      const targets=[20,19,18,17,16,15,"B"];
      match.players.forEach(pl=>{match.grid[pl.email]={}; targets.forEach(t=>{match.grid[pl.email][t]={throws:[],points:0,shanghai:false};});});
      screen="play"; render();
    };
    return;
  }

  if(screen==="play"){
    const targets=[20,19,18,17,16,15,"B"];
    const t=targets[match.targetIndex]; const active=match.players[match.turnIndex];
    html+='<div class="card"><div class="sub">Target: '+esc(targetLabel(t))+' • Turn: '+esc(active.name)+' • Dart '+(match.dartInTurn+1)+'/3</div>'+
    '<div class="boardBox">'+dartboardSVG(t)+'</div></div>';
    appEl.innerHTML=html;
    return;
  }
}

render();
</script>
</body>
</html>
