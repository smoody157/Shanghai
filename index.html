<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Game Night Darts</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root {
  --bg:#0b1a2e;
  --text:#eaf2ff;
  --muted:#b9cbe5;
  --accent:#4ea8ff;
  --danger:#ff4d5a;
  --ok:#2bd576;
  --shadow: rgba(0,0,0,.25);
}
/* Base styles */
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:radial-gradient(1200px 700px at 40% 0%, #10335f 0%, var(--bg) 55%);
  color:var(--text);
}
.topbar{
  position:sticky;top:0;z-index:10;
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:12px 14px;background:rgba(10,20,35,.78);backdrop-filter:blur(10px);
  border-bottom:1px solid rgba(255,255,255,.08);
}
.brand{display:flex;flex-direction:column;line-height:1.05}
.brand .t{font-weight:900;font-size:16px}
.brand .s{font-size:12px;color:var(--muted)}
.btn{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.08);
  color:var(--text);border-radius:14px;padding:10px 12px;font-weight:900;
  box-shadow:0 6px 16px var(--shadow);
}
.btn:active{transform:translateY(1px)}
.btn.ghost{background:transparent;box-shadow:none;color:var(--muted)}
.btn.ok{background:rgba(43,213,118,.20);border-color:rgba(43,213,118,.35)}
.btn.danger{background:rgba(255,77,90,.20);border-color:rgba(255,77,90,.35)}
.wrap{max-width:920px;margin:0 auto;padding:14px}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;padding:14px;
  box-shadow:0 10px 28px rgba(0,0,0,.28);
  margin-bottom:12px;
}
.h1{font-size:24px;font-weight:1000;margin:2px 0 6px}
.sub{color:var(--muted);font-size:13px}
label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
input, select{
  width:100%;
  background:rgba(10,20,35,.65);
  border:1px solid rgba(255,255,255,.14);
  color:var(--text);
  border-radius:14px;padding:12px 12px;font-size:16px;outline:none;
}
.row{display:flex;gap:10px}
.row > *{flex:1}
.stack{display:flex;flex-direction:column;gap:10px}
.toast{
  background:rgba(255,77,90,.12);
  border:1px solid rgba(255,77,90,.30);
  color:#ffd6da;
  border-radius:14px;padding:10px 12px;font-weight:900;margin-bottom:12px;
}
.pill{
  display:inline-block;padding:6px 10px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(78,168,255,.08);
  color:var(--accent);font-weight:900;font-size:12px;
}
.divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
</style>
</head>
<body>
<div class="topbar">
  <div class="brand">
    <div class="t">Game Night Darts</div>
    <div class="s">The Dart Room presents • Developed & designed by Steve’s Graphic Designs</div>
  </div>
  <div>
    <button class="btn ghost" id="homeBtn" type="button">Home</button>
    <button class="btn ghost" id="signOutBtn" type="button" style="display:none;">Sign out</button>
  </div>
</div>

<div class="wrap" id="app"></div>

<script>
// ===== Firebase Initialization =====
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_MESSAGING_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== Utility functions =====
function esc(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function normEmail(s){ return String(s||"").trim().toLowerCase(); }
function now(){ return new Date().getTime(); }

// ===== DOM elements =====
const appEl = document.getElementById("app");
const homeBtn = document.getElementById("homeBtn");
const signOutBtn = document.getElementById("signOutBtn");

let toastMsg="";
let screen="auth"; // auth | signup | home | match | play | stats | history
let meUser=null;
let match=null;

// ===== Firebase Player Functions =====
async function getPlayers() {
  const snapshot = await db.collection("players").get();
  return snapshot.docs.map(d => d.data());
}
async function upsertPlayer(name,email){
  await db.collection("players").doc(email).set({name,email,createdAt:now()},{merge:true});
}
async function getStats(email){
  const doc = await db.collection("stats").doc(email).get();
  return doc.exists ? doc.data() : {};
}
async function saveStats(email,data){
  await db.collection("stats").doc(email).set(data,{merge:true});
}
async function getHistory(email){
  const snapshot = await db.collection("history").where("players","array-contains",email).orderBy("endedAt","desc").limit(60).get();
  return snapshot.docs.map(d=>d.data());
}
async function saveHistoryEntry(entry){
  await db.collection("history").add(entry);
}

// ===== Authentication =====
async function signInEmail(email){
  const doc = await db.collection("players").doc(email).get();
  return doc.exists ? doc.data() : null;
}
async function signUpEmail(name,email){
  await upsertPlayer(name,email);
  return {name,email};
}

// ===== UI Actions =====
homeBtn.onclick = ()=>{ screen = meUser ? "home" : "auth"; render(); };
signOutBtn.onclick = async ()=>{ meUser=null; screen="auth"; render(); };

// ===== Render Function (Auth & Signup) =====
async function render(){
  let html="";
  if(toastMsg){ html += `<div class="toast">${esc(toastMsg)}</div>`; toastMsg=""; }

  if(screen==="auth"){
    html += `<div class="card"><div class="h1">Sign In</div><div class="sub">Enter your email to start.</div></div>`;
    html += `<div class="card"><div class="stack">
      <input id="inEmail" type="email" placeholder="you@email.com"/>
      <div class="row">
        <button class="btn" id="goBtn">Go</button>
      </div>
    </div></div>`;
    appEl.innerHTML = html;

    document.getElementById("goBtn").onclick = async ()=>{
      const e = normEmail(document.getElementById("inEmail").value);
      if(!e){ toastMsg="Enter a valid email."; render(); return; }
      const player = await signInEmail(e);
      if(player){
        meUser = player;
        screen="home"; render();
      } else {
        meUser = {email:e};
        screen="signup"; render();
      }
    };
    return;
  }

  if(screen==="signup"){
    html += `<div class="card"><div class="h1">Create Player</div><div class="sub">Enter your name to create your player.</div></div>`;
    html += `<div class="card"><div class="stack">
      <input id="upName" type="text" placeholder="Your Name"/>
      <div class="row">
        <button class="btn ok" id="createBtn">Create Player</button>
      </div>
    </div></div>`;
    appEl.innerHTML = html;

    document.getElementById("createBtn").onclick = async ()=>{
      const n = String(document.getElementById("upName").value).trim();
      const e = meUser.email;
      if(!n){ toastMsg="Enter your name."; render(); return; }
      meUser = await signUpEmail(n,e);
      screen="home"; render();
    };
    return;
  }

  // Remaining screens (home, match, play, stats, history) will be handled in Part 2
}

render();
</script>
<script>
// ===== Home Screen =====
async function renderHome() {
  const players = await getPlayers();
  let html = `<div class="card"><span class="pill">Signed in</span>
      <div class="h1">${esc(meUser.name)}</div>
      <div class="sub">${esc(meUser.email)}</div></div>`;
  
  html += `<div class="row">
    <button class="btn" id="playNowBtn">Play Now</button>
    <button class="btn ghost" id="statsBtn">My Stats</button>
    <button class="btn ghost" id="historyBtn">History</button>
  </div>`;
  
  html += `<div class="card"><div class="h1">Other Players</div><div class="stack">`;
  players.forEach(p=>{
    if(p.email!==meUser.email){
      html += `<div class="pill">${esc(p.name)}</div>`;
    }
  });
  html += `</div></div>`;

  appEl.innerHTML = html;

  document.getElementById("playNowBtn").onclick=()=>{ screen="match"; render(); };
  document.getElementById("statsBtn").onclick=()=>{ screen="stats"; render(); };
  document.getElementById("historyBtn").onclick=()=>{ screen="history"; render(); };
}

// ===== Match Setup =====
async function renderMatch() {
  const players = await getPlayers();
  let html = `<div class="card"><div class="h1">New Match</div></div>`;
  
  html += `<div class="card"><div class="stack">
    <label>Choose players</label>
    <select id="matchPlayers" multiple>`;
  players.forEach(p=>{
    html += `<option value="${esc(p.email)}">${esc(p.name)}</option>`;
  });
  html += `</select>
    <button class="btn ok" id="startMatchBtn">Start Match</button>
  </div></div>`;

  appEl.innerHTML = html;

  document.getElementById("startMatchBtn").onclick=()=>{
    const selected = Array.from(document.getElementById("matchPlayers").selectedOptions).map(o=>o.value);
    if(selected.length<1){ toastMsg="Select at least one player."; render(); return; }
    match = {players: selected.map(e=>players.find(p=>p.email===e)), startedAt: now(), grid:{}};
    // Initialize grid for each player and target
    match.players.forEach(p=>{
      match.grid[p.email]={};
      ["20","19","18","17","16","15","B"].forEach(t=>{
        match.grid[p.email][t]={throws:[],points:0,shanghai:false};
      });
    });
    match.turnIndex=0;
    match.targetIndex=0;
    match.dartInTurn=0;
    match.finished=false;
    screen="play"; render();
  };
}

// ===== Play Screen Placeholder =====
function renderPlay() {
  if(!match){ screen="home"; render(); return; }

  const activePlayer = match.players[match.turnIndex];
  const target = ["20","19","18","17","16","15","B"][match.targetIndex];

  let html = `<div class="card"><div class="h1">Match in progress</div></div>`;
  html += `<div class="card">
    <div class="stack">
      <div>TODO: Dartboard & Gameplay will render here.</div>
      <div class="sub">Target: <b>${esc(target==="B"?"BULL":target)}</b> • Turn: <b>${esc(activePlayer.name)}</b> • Dart ${match.dartInTurn+1}/3</div>
      <button class="btn ok" id="finishMatchBtn">Finish Match</button>
    </div>
  </div>`;

  appEl.innerHTML = html;

  document.getElementById("finishMatchBtn").onclick=async ()=>{
    if(!match) return;
    match.endedAt=now();
    await saveHistoryEntry({
      gameId:"shanghai",
      startedAt: match.startedAt,
      endedAt: match.endedAt,
      players: match.players.map(p=>p.email),
      summary: match.players.map(p=>p.name+": 0").join(" | ")
    });
    match=null;
    screen="home"; render();
  };
}

// ===== Stats Screen Placeholder =====
async function renderStats() {
  const stats = await getStats(meUser.email);
  let html = `<div class="card"><div class="h1">My Stats</div></div>`;
  html += `<pre>${JSON.stringify(stats,null,2)}</pre>`;
  html += `<button class="btn" id="statsHomeBtn">Home</button>`;
  appEl.innerHTML = html;

  document.getElementById("statsHomeBtn").onclick=()=>{ screen="home"; render(); };
}

// ===== History Screen Placeholder =====
async function renderHistory() {
  const history = await getHistory(meUser.email);
  let html = `<div class="card"><div class="h1">History</div></div>`;
  html += `<pre>${JSON.stringify(history,null,2)}</pre>`;
  html += `<button class="btn" id="historyHomeBtn">Home</button>`;
  appEl.innerHTML = html;

  document.getElementById("historyHomeBtn").onclick=()=>{ screen="home"; render(); };
}

// ===== Main Render Dispatcher =====
async function render(){
  if(!meUser || screen==="auth" || screen==="signup") return render();
  if(screen==="home") return renderHome();
  if(screen==="match") return renderMatch();
  if(screen==="play") return renderPlay();
  if(screen==="stats") return renderStats();
  if(screen==="history") return renderHistory();
}

render();
</script>
<script>
// ===== Dartboard Utilities =====
const BOARD_NUMS = [20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];
const TARGETS = [20,19,18,17,16,15,"B"];

function polar(cx,cy,r,deg){
  const rad = (deg-90)*Math.PI/180;
  return {x: cx + r*Math.cos(rad), y: cy + r*Math.sin(rad)};
}

function arcWedgePath(cx,cy,r0,r1,a0,a1){
  const p1=polar(cx,cy,r1,a0), p2=polar(cx,cy,r1,a1);
  const p3=polar(cx,cy,r0,a1), p4=polar(cx,cy,r0,a0);
  const large = (a1-a0)>180?1:0;
  function f(n){ return (Math.round(n*1000)/1000).toFixed(3); }
  return `M ${f(p1.x)} ${f(p1.y)} A ${r1} ${r1} 0 ${large} 1 ${f(p2.x)} ${f(p2.y)} L ${f(p3.x)} ${f(p3.y)} A ${r0} ${r0} 0 ${large} 0 ${f(p4.x)} ${f(p4.y)} Z`;
}

function dartboardSVG(activeNumber){
  const cx=100,cy=100;
  const outer=80, rDoubleOuter=74, rDoubleInner=66, rTripleOuter=48, rTripleInner=40, rSingleInner=12;
  const seg=360/20;
  
  let activePath = "";
  if(typeof activeNumber==="number"){
    let idx = BOARD_NUMS.indexOf(activeNumber);
    if(idx>=0){
      let a0=idx*seg+1.2, a1=(idx+1)*seg-1.2;
      activePath = arcWedgePath(cx,cy,rTripleOuter+2,rDoubleInner-2,a0,a1);
    }
  }

  function ringWedges(r0,r1,fillA,fillB){
    let out="";
    for(let i=0;i<20;i++){
      let a0=i*seg+0.8, a1=(i+1)*seg-0.8;
      out += `<path d="${arcWedgePath(cx,cy,r0,r1,a0,a1)}" fill="${i%2===0?fillA:fillB}" opacity="0.95"/>`;
    }
    return out;
  }

  let numText="";
  for(let i=0;i<20;i++){
    let ang=i*seg+seg/2;
    let p=polar(cx,cy,90,ang);
    numText += `<text x="${p.x.toFixed(2)}" y="${p.y.toFixed(2)}" text-anchor="middle" dominant-baseline="middle" font-size="8.5" fill="#dfe9ff" font-weight="900" style="paint-order:stroke;stroke:#07101d;stroke-width:2px">${BOARD_NUMS[i]}</text>`;
  }

  return `<svg viewBox="0 0 200 200" width="70%">
    <defs>
      <radialGradient id="bgG" cx="50%" cy="42%" r="65%">
        <stop offset="0%" stop-color="#203a62"/>
        <stop offset="55%" stop-color="#0d1a2e"/>
        <stop offset="100%" stop-color="#060d18"/>
      </radialGradient>
      <filter id="glow" x="-30%" y="-30%" width="160%" height="160%">
        <feGaussianBlur stdDeviation="3.5" result="b"/>
        <feColorMatrix in="b" type="matrix" values="0 0 0 0 0.30  0 0 0 0 0.66  0 0 0 0 1.00  0 0 0 .9 0" result="c"/>
        <feMerge><feMergeNode in="c"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <circle cx="100" cy="100" r="${outer}" fill="url(#bgG)" stroke="#2a3f5f" stroke-width="2"/>
    ${activePath?`<path d="${activePath}" fill="rgba(78,168,255,.25)" stroke="rgba(78,168,255,.55)" stroke-width="1.4" filter="url(#glow)"/>`:''}
    ${ringWedges(rTripleOuter,rDoubleInner,"#0b1220","#1a2338")}
    ${ringWedges(rTripleInner,rTripleOuter,"#2aa84a","#c63a3a")}
    ${ringWedges(rDoubleInner,rDoubleOuter,"#2aa84a","#c63a3a")}
    ${ringWedges(rSingleInner,rTripleInner,"#1a2338","#0b1220")}
    <circle cx="100" cy="100" r="11.5" fill="#2aa84a" stroke="#1b2b42" stroke-width="2"/>
    <circle cx="100" cy="100" r="5.3" fill="#c63a3a" stroke="#1b2b42" stroke-width="1.5"/>
    ${numText}
  </svg>`;
}

// ===== Gameplay Logic =====
function pts(hit){ return hit==="T"?3:hit==="D"?2:hit==="S"?1:0; }

function addThrow(m,hit){
  if(!m) return;
  let p = m.players[m.turnIndex];
  let t = TARGETS[m.targetIndex];
  let key=String(t);
  if(!m.grid[p.email][key].throws) m.grid[p.email][key].throws=[];
  if(!m.grid[p.email][key].points) m.grid[p.email][key].points=0;

  m.grid[p.email][key].throws.push(hit);
  m.grid[p.email][key].points += pts(hit);
  p.total = (p.total||0) + pts(hit);

  m.dartInTurn = (m.dartInTurn||0)+1;
  if(m.dartInTurn>=3){
    m.dartInTurn=0;
    m.turnIndex = (m.turnIndex+1)%m.players.length;
    if(m.turnIndex===0){ m.targetIndex = (m.targetIndex||0)+1; }
  }
}

// ===== Undo/Next Snapshots =====
function pushSnap(){
  if(!match) return;
  match.snaps = match.snaps||[];
  match.snaps.push(JSON.stringify(match));
  if(match.snaps.length>60) match.snaps.shift();
}

function popSnap(){
  if(!match || !match.snaps || match.snaps.length<2) return false;
  match.snaps.pop();
  let prev = match.snaps.pop();
  try{ match = JSON.parse(prev); return true; }catch(e){ return false; }
}

// ===== Flash Active Target =====
let flashInterval=null;
function startFlash(){
  if(flashInterval) clearInterval(flashInterval);
  const board = document.querySelector('.boardBox svg path');
  if(!board) return;
  let visible = true;
  flashInterval = setInterval(()=>{
    board.style.opacity = visible ? '0.5' : '0.16';
    visible = !visible;
  }, 500);
}

function stopFlash(){
  if(flashInterval){
    clearInterval(flashInterval);
    flashInterval=null;
  }
}

// ===== Reset / Start Match =====
function startMatch(players){
  match=newMatch(players);
  match.snaps=[];
  pushSnap();
  screen="play";
  render();
}

function resetMatch(){
  const pls = match.players.map(p=>({name:p.name,email:p.email}));
  match = newMatch(pls);
  match.snaps=[];
  pushSnap();
  render();
}

// ===== Play Screen Event Binding =====
function bindPlayEvents(){
  document.getElementById("hitT").onclick=()=>{addThrow(match,"T"); render();};
  document.getElementById("hitS").onclick=()=>{addThrow(match,"S"); render();};
  document.getElementById("hitD").onclick=()=>{addThrow(match,"D"); render();};
  document.getElementById("hitM").onclick=()=>{addThrow(match,"M"); render();};
  document.getElementById("undoBtn").onclick=onUndoPlay;
  document.getElementById("nextBtn").onclick=onNextTurn;
  document.getElementById("resetBtn").onclick=resetMatch;
  document.getElementById("backHome").onclick=()=>{
    match=null;
    stopFlash();
    screen="home";
    render();
  };
}
</script>
<script>
// ===== Play Screen Table & Completed Match Saving =====
async function saveCompletedMatch(){
  if(!match || !match.finished) return;
  match.endedAt = now();

  // Save history
  const historyEntry = {
    gameId:"shanghai",
    startedAt: match.startedAt,
    endedAt: match.endedAt,
    players: match.players.map(p=>p.email),
    summary: match.players.map(p=>p.name+": "+(p.total||0)).join(" | ")
  };
  await saveHistoryEntry(historyEntry);

  // Update stats
  for(const p of match.players){
    const s = await getStats(p.email);
    s.shanghai = s.shanghai || {games:0,best:0,totalPoints:0,byTarget:{}};
    s.shanghai.games += 1;
    s.shanghai.totalPoints += (p.total||0);
    if(!s.shanghai.best || (p.total||0) > s.shanghai.best) s.shanghai.best = p.total||0;
    // Update byTarget
    for(const t of TARGETS){
      const k = String(t);
      const cell = match.grid[p.email][k] || {points:0,S:0,D:0,T:0,M:0};
      s.shanghai.byTarget[k] = s.shanghai.byTarget[k] || {points:0,S:0,D:0,T:0,M:0};
      s.shanghai.byTarget[k].points += cell.points || 0;
      s.shanghai.byTarget[k].S += (cell.throws||[]).filter(x=>"S"===x).length;
      s.shanghai.byTarget[k].D += (cell.throws||[]).filter(x=>"D"===x).length;
      s.shanghai.byTarget[k].T += (cell.throws||[]).filter(x=>"T"===x).length;
      s.shanghai.byTarget[k].M += (cell.throws||[]).filter(x=>"M"===x).length;
    }
    await saveStats(p.email,s);
  }
}

// ===== Render Play Screen (Table + UI) =====
async function renderPlayScreen(){
  if(!match){ screen="home"; render(); return; }

  const t = TARGETS[match.targetIndex];
  const activePlayer = match.players[match.turnIndex];

  // Header & Controls
  let html = `<div class="card row">
    <button class="btn ghost" id="backHome">Home</button>
    <button class="btn danger" id="resetBtn">Reset</button>
  </div>`;

  // Dartboard
  html += `<div class="card">
    <span class="pill">Shanghai (Accuracy)</span>
    <div class="divider"></div>
    <div class="sub">Target: <b>${esc(t==="B"?"BULL":t)}</b> • Turn: <b>${esc(activePlayer.name)}</b> • Dart ${match.dartInTurn+1}/3</div>
    <div class="divider"></div>
    <div class="boardBox">${dartboardSVG(t)}</div>
    <div class="divider"></div>
    <div class="hitRow">
      <button class="hitBtn" id="hitT">T</button>
      <button class="hitBtn" id="hitS">S</button>
      <button class="hitBtn" id="hitD">D</button>
      <button class="hitBtn miss" id="hitM">M</button>
    </div>
    <div class="divider"></div>
    <div class="hitRow">
      <button class="hitBtn undo" id="undoBtn">Undo</button>
      <button class="hitBtn" disabled></button>
      <button class="hitBtn" disabled></button>
      <button class="hitBtn next" id="nextBtn">Next</button>
    </div>
    ${match.finished?'<div class="divider"></div><div class="pill">Finished • Saved to stats + history</div>':''}
  </div>`;

  // Score Table
  let thead = `<tr><th>Target</th>`;
  for(let i=0;i<match.players.length;i++){
    thead += `<th>${esc(match.players[i].name)}<div class="small">${match.players[i].total||0} pts</div></th>`;
  }
  thead += `</tr>`;

  let tbody="";
  for(let r=0;r<TARGETS.length;r++){
    const key=String(TARGETS[r]);
    tbody += `<tr><td class="l"><span class="badge">${esc(TARGETS[r])}</span></td>`;
    for(let c=0;c<match.players.length;c++){
      const p=match.players[c];
      const cell=match.grid[p.email][key]||{throws:[],points:0};
      const txt=cell.throws.length?cell.throws.join(" "):"—";
      const cls=(String(t)===key)?' class="activeCell"':'';
      tbody += `<td${cls}>${esc(txt)}<div class="small">${cell.points}</div></td>`;
    }
    tbody += "</tr>";
  }

  html += `<div class="card">
    <div class="pill">Round table</div>
    <div class="divider"></div>
    <div style="overflow:auto;border-radius:16px;border:1px solid rgba(255,255,255,.10)">
      <table><thead>${thead}</thead><tbody>${tbody}</tbody></table>
    </div>
  </div>`;

  appEl.innerHTML = html;

  // Event Binding
  function onHit(h){
    if(match.finished) return;
    pushSnap();
    addThrow(match,h);
    if(match.targetIndex>=TARGETS.length){ match.finished=true; saveCompletedMatch(); }
    renderPlayScreen();
  }

  document.getElementById("hitT").onclick = ()=>onHit("T");
  document.getElementById("hitS").onclick = ()=>onHit("S");
  document.getElementById("hitD").onclick = ()=>onHit("D");
  document.getElementById("hitM").onclick = ()=>onHit("M");
  document.getElementById("undoBtn").onclick = ()=>{
    popSnap();
    renderPlayScreen();
  };
  document.getElementById("nextBtn").onclick = ()=>{
    while(match.dartInTurn<3){ pushSnap(); addThrow(match,"M"); }
    if(match.targetIndex>=TARGETS.length){ match.finished=true; saveCompletedMatch(); }
    renderPlayScreen();
  };
  document.getElementById("resetBtn").onclick = ()=>{
    const pls = match.players.map(p=>({name:p.name,email:p.email}));
    match = newMatch(pls);
    match.snaps=[];
    pushSnap();
    renderPlayScreen();
  };
  document.getElementById("backHome").onclick = ()=>{
    match=null;
    stopFlash();
    screen="home";
    render();
  };

  startFlash();
}

// ===== Stats Screen =====
async function renderStats(){
  const stats = await getStats(meUser.email);
  const sh = stats.shanghai || {games:0,best:0,totalPoints:0,byTarget:{}};
  const avg = sh.games?Math.round((sh.totalPoints/sh.games)*10)/10:0;

  let maxPts=0;
  for(const t of TARGETS){
    const bt = sh.byTarget[String(t)]||{points:0};
    if(bt.points>maxPts) maxPts=bt.points;
  }
  if(maxPts<1) maxPts=1;

  let bars="";
  for(const t of TARGETS){
    const k=String(t);
    const bt = sh.byTarget[k]||{points:0};
    const w=Math.round((bt.points/maxPts)*100);
    bars += `<div class="barRow">
      <div class="barLabel">${esc(k)}</div>
      <div class="barOuter"><div class="barInner" style="width:${w}%"></div></div>
      <div class="barVal">${bt.points} pts</div>
    </div>`;
  }

  let html=`<div class="card">
    <div class="row"><button class="btn ghost" id="statsHomeBtn">Home</button></div>
  </div>
  <div class="card">
    <span class="pill">My Stats</span>
    <div class="h1">Shanghai</div>
    <div class="sub">T=3, D=2, S=1, M=0 • Shanghai bonus +5</div>
    <div class="divider"></div>
    <div class="kpi">
      <div class="box"><div class="v">${sh.games}</div><div class="l">Games played</div></div>
      <div class="box"><div class="v">${sh.best}</div><div class="l">Best score</div></div>
      <div class="box"><div class="v">${avg}</div><div class="l">Average score</div></div>
    </div>
  </div>
  <div class="card"><span class="pill">Points by target</span><div class="divider"></div>${bars}</div>`;

  appEl.innerHTML=html;
  document.getElementById("statsHomeBtn").onclick=()=>{ screen="home"; render(); };
}

// ===== History Screen =====
async function renderHistory(){
  const history = await getHistory(meUser.email);
  let list="";
  if(history.length===0) list='<div class="sub">No matches yet.</div>';
  else{
    for(const h of history.slice(0,60)){
      list += `<div class="li">
        <div class="meta">
          <div class="nm">${esc(h.summary)}</div>
          <div class="em">${esc(new Date(h.endedAt).toLocaleString())}</div>
        </div>
      </div>`;
    }
  }

  let html=`<div class="card">
    <div class="row"><button class="btn ghost" id="historyHomeBtn">Home</button></div>
  </div>
  <div class="card">
    <span class="pill">Match History</span>
    <div class="h1">Recent Games</div>
    <div class="divider"></div>${list}
  </div>`;
  appEl.innerHTML=html;
  document.getElementById("historyHomeBtn").onclick=()=>{ screen="home"; render(); };
}

// ===== Final Unified Render Dispatcher =====
async function render(){
  if(screen==="auth") return render();
  if(screen==="signup") return render();
  if(screen==="home") return renderHome();
  if(screen==="match") return renderMatch();
  if(screen==="play") return renderPlayScreen();
  if(screen==="stats") return renderStats();
  if(screen==="history") return renderHistory();
}

// ===== Initial Render Call =====
render();
</script>
<script>
// ===== Dartboard Flash Enhancements =====
let flashInterval=null;

function startFlash(){
  if(!match) return;
  if(flashInterval) clearInterval(flashInterval);
  const activeTarget = TARGETS[match.targetIndex];
  const boardPaths = document.querySelectorAll('.boardBox svg path');
  if(!boardPaths) return;
  let visible=true;
  flashInterval=setInterval(()=>{
    boardPaths.forEach((p,i)=>{
      const idx = BOARD_NUMS.indexOf(activeTarget);
      if(idx===i) p.style.opacity=visible?'0.5':'0.16';
    });
    visible=!visible;
  },500);
}

function stopFlash(){
  if(flashInterval){
    clearInterval(flashInterval);
    flashInterval=null;
  }
}

// ===== Undo / Next Turn for Play Screen =====
function onUndoPlay(){
  if(!match || !match.snaps || match.snaps.length<2) return;
  match.snaps.pop(); // remove current
  const prev = match.snaps.pop(); // previous
  if(prev){
    match=JSON.parse(prev);
    renderPlayScreen();
  }
}

function onNextTurn(){
  if(!match) return;
  while(match.dartInTurn<3){
    pushSnap();
    addThrow(match,"M"); // auto-miss remaining darts
  }
  if(match.targetIndex>=TARGETS.length){
    match.finished=true;
    saveCompletedMatch();
  }
  renderPlayScreen();
}

// ===== Bind Play Events =====
function bindPlayEvents(){
  document.getElementById("hitT").onclick=()=>{addThrow(match,"T"); renderPlayScreen();};
  document.getElementById("hitS").onclick=()=>{addThrow(match,"S"); renderPlayScreen();};
  document.getElementById("hitD").onclick=()=>{addThrow(match,"D"); renderPlayScreen();};
  document.getElementById("hitM").onclick=()=>{addThrow(match,"M"); renderPlayScreen();};
  document.getElementById("undoBtn").onclick=onUndoPlay;
  document.getElementById("nextBtn").onclick=onNextTurn;
  document.getElementById("resetBtn").onclick=()=>{
    const pls = match.players.map(p=>({name:p.name,email:p.email}));
    match=newMatch(pls);
    match.snaps=[];
    pushSnap();
    renderPlayScreen();
  };
  document.getElementById("backHome").onclick=()=>{
    match=null;
    stopFlash();
    screen="home";
    render();
  };
}

// ===== Main Render Dispatcher (Unified) =====
async function render(){
  if(screen==="auth" || screen==="signup") return render();
  if(screen==="home") return renderHome();
  if(screen==="match") return renderMatch();
  if(screen==="play"){
    await renderPlayScreen();
    bindPlayEvents();
    startFlash();
    return;
  }
  if(screen==="stats") return renderStats();
  if(screen==="history") return renderHistory();
}

// ===== Initial Render =====
render();
</script>
