<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Game Night</title>

<style>
:root{
  /* DARK BACKGROUND */
  --bg:#060814;
  --bg-soft:#0b1020;

  /* TEXT (READABLE) */
  --text:#eef4ff;
  --muted:#9fb0d0;

  /* MULTI-COLOR ACCENTS */
  --c-cyan:#22d3ee;
  --c-purple:#8b5cf6;
  --c-pink:#ec4899;
  --c-green:#22c55e;
  --c-orange:#f97316;
  --c-red:#ef4444;
  --accent:var(--c-cyan);

  /* STATUS */
  --danger:var(--c-red);
  --ok:var(--c-green);

  /* GLASS */
  --glass: rgba(255,255,255,.06);
  --glass2: rgba(255,255,255,.025);
  --shadow: rgba(0,0,0,.45);

  /* CHROME MATERIAL */
  --chrome-border: rgba(255,255,255,.18);
  --chrome-fill: linear-gradient(180deg,
    rgba(255,255,255,.18) 0%,
    rgba(255,255,255,.07) 14%,
    rgba(0,0,0,.22) 36%,
    rgba(255,255,255,.10) 52%,
    rgba(0,0,0,.34) 72%,
    rgba(255,255,255,.14) 100%
  );
  --chrome-text: linear-gradient(180deg,
    #ffffff 0%,
    #d7deea 18%,
    #ffffff 38%,
    #aab7d0 60%,
    #ffffff 82%,
    #c7d0e3 100%
  );
}

/* ===== Base ===== */
*{box-sizing:border-box;}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(1000px 700px at 18% 0%, rgba(139,92,246,.22), transparent 65%),
    radial-gradient(900px 650px at 82% 0%, rgba(236,72,153,.18), transparent 65%),
    radial-gradient(1200px 760px at 48% 0%, rgba(34,211,238,.18), var(--bg) 62%),
    radial-gradient(1100px 720px at 50% 115%, rgba(249,115,22,.10), transparent 60%),
    linear-gradient(180deg, #040610, var(--bg));
  color:var(--text);
  padding-bottom:56px; 
}

/* ===== Footer legal ===== */
.footerLegal{
  position:fixed;
  left:0; right:0; bottom:0;
  z-index:20;
  display:flex;
  justify-content:center;
  padding:10px 12px calc(10px + env(safe-area-inset-bottom));
  pointer-events:none;
  background:linear-gradient(180deg, rgba(6,8,20,0), rgba(6,8,20,.65));
}
.footerLegal .txt{
  font-size:10px;
  letter-spacing:.2px;
  color:rgba(159,176,208,.85);
  text-align:center;
  text-shadow:0 2px 10px rgba(0,0,0,.45);
  max-width:980px;
}

/* ===== Topbar (FIXED: cleaner mobile header) ===== */
.topbar{
  position:sticky;top:0;z-index:10;
  display:grid;
  grid-template-columns: 80px 1fr 80px;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  padding-top:calc(10px + env(safe-area-inset-top));
  background:rgba(7,10,20,.84);
  backdrop-filter:blur(12px);
  border-bottom:1px solid rgba(255,255,255,.08);
}
.topActions{
  display:flex;
  align-items:center;
}
.topActions.left{justify-content:flex-start}
.topActions.right{justify-content:flex-end}

.brand{
  display:flex;
  flex-direction:column;
  line-height:1.2;
  align-items:center;
  text-align:center;
}
.brand .t{font-weight:900;font-size:17px;letter-spacing:0.5px}
.brand .s{
  font-size:10px;
  font-weight:600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color:var(--muted);
}

.wrap{max-width:980px;margin:0 auto;padding:14px}
.card{
  background:linear-gradient(180deg,var(--glass),var(--glass2));
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;padding:16px;
  box-shadow:0 10px 28px rgba(0,0,0,.34);
  margin-bottom:12px;
}

.h1{font-size:24px;font-weight:1000;margin:0 0 4px 0}
.sub{color:var(--muted);font-size:13px}
label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}

input,select{
  width:100%;
  background:rgba(7,10,20,.72);
  border:1px solid rgba(255,255,255,.14);
  color:var(--text);
  border-radius:14px;padding:12px 12px;font-size:16px;outline:none;
}

.row{display:flex;gap:10px}
.row>*{flex:1}
.stack{display:flex;flex-direction:column;gap:10px}

.toast{
  background:rgba(239,68,68,.12);
  border:1px solid rgba(239,68,68,.30);
  color:#ffd6da;
  border-radius:14px;padding:10px 12px;font-weight:900;margin-bottom:12px;
}

.divider{height:1px;background:rgba(255,255,255,.10);margin:16px 0}

/* ===== Buttons ===== */
.btn{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
  border-radius:14px;padding:10px 12px;font-weight:900;
  box-shadow:0 6px 16px var(--shadow);
  cursor:pointer;
  position:relative;
  font-size: 13px;
}
.btn:active{transform:translateY(1px)}
.btn.ghost{background:transparent;box-shadow:none;color:var(--muted); border: 1px solid transparent;}
.btn.ok{
  background:linear-gradient(135deg, rgba(34,197,94,.22), rgba(34,211,238,.12));
  border-color:rgba(34,197,94,.40);
}
.btn.danger{
  background:linear-gradient(135deg, rgba(239,68,68,.22), rgba(249,115,22,.12));
  border-color:rgba(239,68,68,.42);
}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none}

.btn:not(.ghost), .hitBtn, .kAttackBtn, .pill, .badge, .kbd{
  background:var(--chrome-fill);
  border:1px solid var(--chrome-border);
  box-shadow:
    0 8px 16px rgba(0,0,0,.32),
    inset 0 1px 0 rgba(255,255,255,.20);
}

/* ===== Chrome text ===== */
.h1, .kTurnBig, .brand .t, th, td.l, .rosterName{
  background:var(--chrome-text);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
  text-shadow:0 2px 12px rgba(0,0,0,.45);
}

/* ===== Pills / Badges (FIXED ALIGNMENT) ===== */
.pill{
  display:inline-flex;
  align-items: center;
  justify-content: center;
  padding:4px 10px;
  border-radius:999px;
  color:var(--text);
  font-weight:900;
  font-size:11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
}
.pill.soon{background:rgba(255,255,255,.05); color:var(--muted)}

.badge{
  display:inline-block;padding:4px 8px;border-radius:999px;
  font-size:12px;font-weight:1000;
  color:var(--text);
}
.kbd{
  display:inline-block;padding:2px 8px;border-radius:999px;
  color:var(--muted); font-weight:900; font-size:11px;
}

/* ===== Hero alignment (Clean & Balanced) ===== */
.hero{
  display: flex;
  align-items: center;
  gap: 16px;
  width: 100%;
}
.heroCornerLeft{
  flex: 0 0 auto;
}
.heroMain{
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.heroCornerRight{
  flex: 0 0 auto;
  display: flex;
  align-items: center;
  justify-content: flex-end;
}

.logoMark{
  width:48px;height:48px;border-radius:14px;
  background:
    radial-gradient(60% 60% at 30% 20%, rgba(34,211,238,.18), rgba(139,92,246,.16)),
    rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.12);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 10px 24px rgba(0,0,0,.25);
}
.logoMark span{font-size:24px}

/* ===== Game cards ===== */
.gameGrid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:860px){ .gameGrid{grid-template-columns:1fr 1fr;} }
.gameCard{
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;padding:16px;
  box-shadow:0 10px 26px rgba(0,0,0,.28);
}
.gameHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
.gameTitle{display:flex;align-items:center;gap:12px}
.gameIcon{
  width:40px;height:40px;border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  font-size:20px;
}
.gameMeta{color:var(--muted);font-size:13px;margin-top:2px}
.gameActions{display:flex;gap:10px;margin-top:14px}
.gameActions .btn{flex:1}

/* ===== Roster ===== */
.rosterGrid{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:860px){ .rosterGrid{grid-template-columns:1fr 1fr;} }
.rosterCard{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:12px 14px;border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
}
.rosterLeft{display:flex;align-items:center;gap:12px}
.avatar{
  width:36px;height:36px;border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  font-weight:1000;color:var(--c-cyan);
}
.rosterSub{color:var(--muted);font-size:11px;margin-top:1px}

/* ===== Indicators ===== */
@keyframes dangerPulse{0%{box-shadow:0 0 0 rgba(239,68,68,0)}50%{box-shadow:0 0 24px rgba(239,68,68,.35)}100%{box-shadow:0 0 0 rgba(239,68,68,0)}}
.dangerPulse{animation:dangerPulse 1.1s ease-in-out infinite;}
@keyframes leaderGlow{0%{box-shadow:0 0 0 rgba(34,197,94,0)}50%{box-shadow:0 0 26px rgba(34,197,94,.25)}100%{box-shadow:0 0 0 rgba(34,197,94,0)}}
.leaderGlow{animation:leaderGlow 1.25s ease-in-out infinite;}

/* ===== Tables ===== */
table{width:100%;border-collapse:collapse}
th,td{padding:12px 10px;border-bottom:1px solid rgba(255,255,255,.10);vertical-align:top}
th{position:sticky;top:0;background:rgba(7,10,20,.88);backdrop-filter:blur(10px); text-align: left;}
.small{font-size:11px;color:var(--muted);margin-top:2px}
.activeCell{outline:2px solid rgba(34,211,238,.55); outline-offset:-2px; border-radius:10px}

/* ===== Play UI ===== */
.boardBox{display:flex;justify-content:center;align-items:center; padding: 10px 0;}
.hitRow{display:flex;gap:10px;flex-wrap:wrap}
.hitBtn{
  flex:1; min-width:110px;
  border-radius:14px;
  color:var(--text);
  font-weight:1000;
  padding:14px;
  cursor:pointer;
  position:relative;
}
.hitBtn.miss{border-color:rgba(239,68,68,.35)}
.hitBtn.undo{
  border-color:rgba(255,255,255,.18);
  background:rgba(255,255,255,.04);
  color:var(--muted);
  box-shadow:none;
}
.hitBtn.undo::after{display:none}

@keyframes hotPulse{0%{opacity:.20;filter:brightness(1)}50%{opacity:.98;filter:brightness(2.2)}100%{opacity:.20;filter:brightness(1)}}
.hotWedge{animation:hotPulse .85s ease-in-out infinite;}

/* ===== Killer typography ===== */
.kTurnBig{
  font-size:28px;
  font-weight:1000;
  letter-spacing:.4px;
  margin:0;
}
.kTurnSub{font-size:14px;color:var(--muted);margin-top:4px}
.kNumberBig{font-size:22px;font-weight:1000;}
.kLivesBig{font-size:18px;font-weight:1000;letter-spacing:2px; display:flex; justify-content:flex-end; gap:6px; align-items:center;}
.kAttackGrid{display:grid;grid-template-columns:1fr;gap:10px;}
@media(min-width:860px){ .kAttackGrid{grid-template-columns:1fr 1fr;} }
.kAttackBtn{
  border-radius:16px;
  color:var(--text);
  font-weight:1000;
  padding:14px;
  cursor:pointer;
  text-align:left;
  position:relative;
}
.kAttackBtn:disabled{opacity:.45;cursor:not-allowed}

/* ===== Hearts ===== */
.heart{
  color:var(--danger);
  text-shadow:0 2px 10px rgba(0,0,0,.35);
  font-size:18px;
  line-height:1;
}
.lifeOut{
  color:rgba(159,176,208,.9);
  font-weight:1000;
  letter-spacing:.8px;
  font-size: 11px;
}

/* ===== Multi-color glow ===== */
@keyframes glowCycle{
  0%   { box-shadow:0 0 0 rgba(0,0,0,0); }
  25%  { box-shadow:0 0 18px rgba(34,211,238,.55); }
  50%  { box-shadow:0 0 18px rgba(139,92,246,.55); }
  75%  { box-shadow:0 0 18px rgba(236,72,153,.50); }
  100% { box-shadow:0 0 0 rgba(0,0,0,0); }
}
@keyframes glowGreen{
  0%{box-shadow:0 0 0 rgba(0,0,0,0)}50%{box-shadow:0 0 18px rgba(34,197,94,.50)}100%{box-shadow:0 0 0 rgba(0,0,0,0)}
}
@keyframes glowPurple{
  0%{box-shadow:0 0 0 rgba(0,0,0,0)}50%{box-shadow:0 0 18px rgba(139,92,246,.55)}100%{box-shadow:0 0 0 rgba(0,0,0,0)}
}

.pill[data-live="1"]{ animation:glowCycle 2.4s ease-in-out infinite; }
.btn.ok:not(:disabled){ animation:glowGreen 2.2s ease-in-out infinite; }
.hitBtn:not(:disabled):not(.undo){ animation:glowCycle 2.4s ease-in-out infinite; }
.kAttackBtn:not(:disabled){ animation:glowPurple 2.3s ease-in-out infinite; }

.sub,.small,.brand .s{ text-shadow:0 2px 10px rgba(0,0,0,.30); }
</style>
</head>

<body>
<div class="topbar">
  <div class="topActions left">
    <button class="btn ghost" id="signOutBtn" type="button" style="display:none;">Sign out</button>
  </div>

  <div class="brand">
    <div class="t" id="brandTitle">Game Night</div>
    <div class="s">The Dart Room</div>
  </div>

  <div class="topActions right">
    <button class="btn ghost" id="homeBtn" type="button">Home</button>
  </div>
</div>

<div class="wrap" id="app">
  <div class="card"><div class="h1">Loading‚Ä¶</div><div class="sub">Starting up‚Ä¶</div></div>
</div>

<div class="footerLegal" aria-hidden="true">
  <div class="txt">Night Games is an official Dart Room online training tool. All rights reserved ¬© Steve‚Äôs Graphic Designs.</div>
</div>

<script>
/* ========= Robust script loader (prevents ‚Äúblue wallpaper only‚Äù) ========= */
function loadScript(src){
  return new Promise((resolve,reject)=>{
    const s=document.createElement("script");
    s.src=src; s.async=true;
    s.onload=resolve;
    s.onerror=()=>reject(new Error("Failed to load: "+src));
    document.head.appendChild(s);
  });
}
function esc(s){ return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function normEmail(e){ return String(e??"").trim().toLowerCase(); }
function now(){ return Date.now(); }
function fmt(ts){ try{return new Date(ts).toLocaleString();}catch{return "";} }

const appEl=document.getElementById("app");
const homeBtn=document.getElementById("homeBtn");
const signOutBtn=document.getElementById("signOutBtn");
const brandTitle=document.getElementById("brandTitle");

function showFatal(title,msg){
  appEl.innerHTML=`
    <div class="card">
      <div class="hero">
        <div class="heroCornerLeft">
          <div class="logoMark"><span>‚ö†</span></div>
        </div>
        <div class="heroMain">
          <div class="h1">${esc(title)}</div>
          <div class="sub" style="white-space:pre-wrap">${esc(msg)}</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="row">
        <button class="btn ok" id="retryBtn">Retry</button>
        <button class="btn ghost" id="reloadBtn">Hard Reload</button>
      </div>
    </div>
  `;
  document.getElementById("retryBtn").onclick=()=>boot();
  document.getElementById("reloadBtn").onclick=()=>location.reload(true);
}

async function boot(){
  try{
    appEl.innerHTML=`<div class="card"><div class="h1">Loading‚Ä¶</div><div class="sub">Starting Game Night‚Ä¶</div></div>`;
    await loadScript("https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js");
    await loadScript("https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js");
    await loadScript("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js");
    if(!window.firebase) throw new Error("Firebase loaded but window.firebase is missing.");
    startApp();
  }catch(err){
    showFatal("Can‚Äôt start app", err?.message || String(err));
  }
}

function startApp(){
  /* Firebase */
  const firebaseConfig = {
    apiKey: "AIzaSyCY3hTUNNlV6gAofPXY9BVGKb930WYz5RA",
    authDomain: "gamenightdarts-e7601.firebaseapp.com",
    projectId: "gamenightdarts-e7601",
    storageBucket: "gamenightdarts-e7601.firebasestorage.app",
    messagingSenderId: "270045452251",
    appId: "1:270045452251:web:393956ce18b43316e939fe"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /* Firestore helpers */
  async function getPlayers(){
    const snap = await db.collection("players").get();
    return snap.docs.map(d=>d.data());
  }
  async function upsertPlayer(name,email){
    const e=normEmail(email);
    await db.collection("players").doc(e).set({name,email:e,createdAt:now()},{merge:true});
  }
  async function getStatsDoc(email){
    const doc=await db.collection("stats").doc(normEmail(email)).get();
    return doc.exists?doc.data():{};
  }
  async function saveStatsDoc(email,data){
    await db.collection("stats").doc(normEmail(email)).set(data,{merge:true});
  }
  async function getHistory(email){
    const e=normEmail(email);
    try{
      const snap=await db.collection("history")
        .where("players","array-contains",e)
        .orderBy("endedAt","desc")
        .limit(60).get();
      return snap.docs.map(d=>d.data());
    }catch{
      const snap=await db.collection("history")
        .where("players","array-contains",e)
        .limit(60).get();
      const items=snap.docs.map(d=>d.data());
      items.sort((a,b)=>(b.endedAt||0)-(a.endedAt||0));
      return items;
    }
  }
  async function saveHistoryEntry(entry){ await db.collection("history").add(entry); }

  async function signInEmail(email){
    const e=normEmail(email);
    const doc=await db.collection("players").doc(e).get();
    return doc.exists?doc.data():null;
  }
  async function signUpEmail(name,email){
    const e=normEmail(email);
    await upsertPlayer(name,e);
    return {name,email:e};
  }

  /* Dartboard (straight: 20 top) */
  const BOARD_NUMS=[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];

  function polar(cx,cy,r,deg){
    const rad=(deg-90)*Math.PI/180;
    return {x:cx+r*Math.cos(rad), y:cy+r*Math.sin(rad)};
  }
  function arcWedgePath(cx,cy,r0,r1,a0,a1){
    const p1=polar(cx,cy,r1,a0), p2=polar(cx,cy,r1,a1);
    const p3=polar(cx,cy,r0,a1), p4=polar(cx,cy,r0,a0);
    const large=(a1-a0)>180?1:0;
    const f=n=>(Math.round(n*1000)/1000).toFixed(3);
    return `M ${f(p1.x)} ${f(p1.y)} A ${r1} ${r1} 0 ${large} 1 ${f(p2.x)} ${f(p2.y)} L ${f(p3.x)} ${f(p3.y)} A ${r0} ${r0} 0 ${large} 0 ${f(p4.x)} ${f(p4.y)} Z`;
  }
  function dartboardSVG(activeTarget){
    const cx=100,cy=100;
    const outer=80, rDoubleOuter=74, rDoubleInner=66, rTripleOuter=48, rTripleInner=40, rSingleInner=12;
    const seg=360/20;
    const rot=-seg/2;

    let activeOverlay="";
    if(typeof activeTarget==="number"){
      const idx=BOARD_NUMS.indexOf(activeTarget);
      if(idx>=0){
        const a0=idx*seg+rot+1.0;
        const a1=(idx+1)*seg+rot-1.0;
        const halo=arcWedgePath(cx,cy,rTripleOuter+8,rDoubleInner-8,a0,a1);
        const core=arcWedgePath(cx,cy,rTripleOuter+2,rDoubleInner-2,a0,a1);
        activeOverlay+=`
          <path class="hotWedge" d="${halo}" fill="rgba(34,211,238,.42)" stroke="rgba(34,211,238,.95)" stroke-width="3.8" filter="url(#glow)"/>
          <path class="hotWedge" d="${core}" fill="rgba(139,92,246,.14)" stroke="rgba(255,255,255,.92)" stroke-width="2.8" filter="url(#glow)"/>
        `;
      }
    }
    if(activeTarget==="B"){
      activeOverlay+=`
        <circle class="hotWedge" cx="100" cy="100" r="14.5" fill="rgba(34,211,238,.22)" stroke="rgba(34,211,238,.95)" stroke-width="3.0" filter="url(#glow)"/>
        <circle class="hotWedge" cx="100" cy="100" r="7.6"  fill="rgba(139,92,246,.16)" stroke="rgba(255,255,255,.92)" stroke-width="2.6" filter="url(#glow)"/>
      `;
    }

    function ringWedges(r0,r1,fillA,fillB){
      let out="";
      for(let i=0;i<20;i++){
        const a0=i*seg+rot+0.8;
        const a1=(i+1)*seg+rot-0.8;
        out+=`<path d="${arcWedgePath(cx,cy,r0,r1,a0,a1)}" fill="${i%2===0?fillA:fillB}" opacity="0.95"/>`;
      }
      return out;
    }

    let numText="";
    for(let i=0;i<20;i++){
      const ang=i*seg+rot+seg/2;
      const p=polar(cx,cy,90,ang);
      numText+=`<text x="${p.x.toFixed(2)}" y="${p.y.toFixed(2)}" text-anchor="middle" dominant-baseline="middle" font-size="8.5" fill="#dfe9ff" font-weight="900" style="paint-order:stroke;stroke:#07101d;stroke-width:2px">${BOARD_NUMS[i]}</text>`;
    }

    return `<svg viewBox="0 0 200 200" width="70%">
      <defs>
        <radialGradient id="bgG" cx="50%" cy="42%" r="65%">
          <stop offset="0%" stop-color="#1a2a4a"/>
          <stop offset="55%" stop-color="#0b1325"/>
          <stop offset="100%" stop-color="#040814"/>
        </radialGradient>
        <filter id="glow" x="-30%" y="-30%" width="160%" height="160%">
          <feGaussianBlur stdDeviation="4.2" result="b"/>
          <feColorMatrix in="b" type="matrix"
            values="0 0 0 0 0.20  0 0 0 0 0.80  0 0 0 0 0.95  0 0 0 1.0 0" result="c"/>
          <feMerge><feMergeNode in="c"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>
      <circle cx="100" cy="100" r="${outer}" fill="url(#bgG)" stroke="#2a3f5f" stroke-width="2"/>
      ${activeOverlay}
      ${ringWedges(rTripleOuter,rDoubleInner,"#0b1220","#1a2338")}
      ${ringWedges(rTripleInner,rTripleOuter,"#2aa84a","#c63a3a")}
      ${ringWedges(rDoubleInner,rDoubleOuter,"#2aa84a","#c63a3a")}
      ${ringWedges(rSingleInner,rTripleInner,"#1a2338","#0b1220")}
      <circle cx="100" cy="100" r="11.5" fill="#2aa84a" stroke="#1b2b42" stroke-width="2"/>
      <circle cx="100" cy="100" r="5.3" fill="#c63a3a" stroke="#1b2b42" stroke-width="1.5"/>
      ${numText}
    </svg>`;
  }

  /* Undo snaps */
  function pushSnap(m){
    m.snaps=m.snaps||[];
    m.snaps.push(JSON.stringify(m));
    if(m.snaps.length>80) m.snaps.shift();
  }
  function popSnap(m){
    if(!m?.snaps||m.snaps.length<2) return m;
    m.snaps.pop();
    const prev=m.snaps.pop();
    try{return JSON.parse(prev);}catch{return m;}
  }

  /* Games registry */
  const Games=[
    {id:"shanghai", name:"Shanghai", icon:"üéØ", active:true,  tagline:"20 ‚Üí 15 ‚Üí Bull"},
    {id:"killer",   name:"Killer",   icon:"üî•", active:true,  tagline:"Claim a number ‚Ä¢ Hit doubles"},
    {id:"around",   name:"Around the Clock", icon:"üïí", active:false, tagline:"Coming soon"},
    {id:"halve",    name:"Halve-It", icon:"‚ûó", active:false, tagline:"Coming soon"},
    {id:"baseball", name:"Baseball", icon:"‚öæ", active:false, tagline:"Coming soon"},
  ];
  const getGame=id=>Games.find(g=>g.id===id)||null;

  /* Shanghai */
  const ShanghaiGame=(()=>{
    const TARGETS=[20,19,18,17,16,15,"B"];
    const pts=hit=>hit==="T"?3:hit==="D"?2:hit==="S"?1:0;

    function initMatch(selectedPlayers){
      const m={
        gameId:"shanghai",
        players:selectedPlayers.map(p=>({name:p.name,email:p.email,total:0})),
        startedAt:now(), endedAt:null,
        turnIndex:0, targetIndex:0, dartInTurn:0,
        finished:false, grid:{}, snaps:[], _saved:false
      };
      m.players.forEach(p=>{
        m.grid[p.email]={};
        TARGETS.forEach(t=>{
          m.grid[p.email][String(t)]={throws:[],points:0};
        });
      });
      pushSnap(m);
      return m;
    }

    function addThrow(m, hit){
      if(!m||m.finished) return;
      const player=m.players[m.turnIndex];
      const targetKey=String(TARGETS[m.targetIndex]);
      const cell=m.grid[player.email][targetKey];
      cell.throws.push(hit);
      cell.points+=pts(hit);
      player.total+=pts(hit);

      m.dartInTurn++;
      if(m.dartInTurn>=3){
        m.dartInTurn=0;
        m.turnIndex=(m.turnIndex+1)%m.players.length;
        if(m.turnIndex===0) m.targetIndex++;
      }
      if(m.targetIndex>=TARGETS.length){
        m.finished=true;
        m.endedAt=now();
      }
    }

    async function saveFinish(ctx){
      const m=ctx.match;
      if(!m.finished||m._saved) return;
      m._saved=true;

      const summary=m.players.slice().sort((a,b)=>b.total-a.total)
        .map(p=>`${p.name}: ${p.total}`).join(" | ");

      await saveHistoryEntry({
        gameId:"shanghai", gameName:"Shanghai",
        startedAt:m.startedAt, endedAt:m.endedAt,
        players:m.players.map(p=>p.email),
        summary,
        meta:{targets:TARGETS}
      });

      const stats=await getStatsDoc(ctx.meUser.email);
      const games=stats.games||{};
      const g=games.shanghai||{};
      const played=(g.played||0)+1;

      const meRow=m.players.find(p=>p.email===ctx.meUser.email);
      const myScore=meRow?meRow.total:0;
      const points=(g.points||0)+myScore;
      const best=Math.max(g.best||0,myScore);

      await saveStatsDoc(ctx.meUser.email,{
        games:{...games, shanghai:{...g, played, points, best, lastPlayedAt:m.endedAt||now()}},
        updatedAt:now()
      });
    }

    function renderPlay(ctx){
      const m=ctx.match;
      const t=TARGETS[m.targetIndex];
      const activePlayer=m.players[m.turnIndex];

      let thead=`<tr><th>Target</th>`;
      for(const p of m.players) thead+=`<th>${esc(p.name)}<div class="small">${p.total} pts</div></th>`;
      thead+=`</tr>`;

      let tbody="";
      for(const target of TARGETS){
        const key=String(target);
        tbody+=`<tr><td class="l"><span class="badge">${esc(target==="B"?"BULL":target)}</span></td>`;
        for(const p of m.players){
          const cell=m.grid[p.email][key];
          const txt=cell.throws.length?cell.throws.join(" "):"‚Äî";
          const cls=String(t)===key?` class="activeCell"`:"";
          tbody+=`<td${cls}>${esc(txt)}<div class="small">${cell.points}</div></td>`;
        }
        tbody+=`</tr>`;
      }

      const finishedBanner = m.finished ? `<div class="divider"></div><div style="text-align:center"><span class="pill">Finished</span></div>` : "";

      return `
        <div class="card">
          <div class="row">
            <button class="btn ghost" id="backToSetup">Back</button>
            <button class="btn danger" id="resetBtn">Reset</button>
          </div>
        </div>

        <div class="card">
          <div class="hero">
            <div class="heroCornerLeft">
              <div class="logoMark"><span>üéØ</span></div>
            </div>

            <div class="heroMain">
              <div class="h1">${esc(activePlayer.name)}</div>
              <div class="sub">Target: <b>${esc(t==="B"?"BULL":t)}</b> ‚Ä¢ Dart <b>${m.dartInTurn+1}</b>/3</div>
            </div>

            <div class="heroCornerRight">
              <span class="pill" data-live="1">Live</span>
            </div>
          </div>

          <div class="divider"></div>
          <div class="boardBox">${dartboardSVG(t)}</div>
          <div class="divider"></div>

          <div class="hitRow">
            <button class="hitBtn" id="hitT" ${m.finished?"disabled":""}>TRIPLE</button>
            <button class="hitBtn" id="hitS" ${m.finished?"disabled":""}>SINGLE</button>
            <button class="hitBtn" id="hitD" ${m.finished?"disabled":""}>DOUBLE</button>
            <button class="hitBtn miss" id="hitM" ${m.finished?"disabled":""}>MISS</button>
            <button class="hitBtn undo" id="undoBtn">UNDO</button>
          </div>

          ${finishedBanner}
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
             <span class="pill">Round Table</span>
          </div>
          <div class="divider"></div>
          <div style="overflow:auto;border-radius:16px;border:1px solid rgba(255,255,255,.10)">
            <table><thead>${thead}</thead><tbody>${tbody}</tbody></table>
          </div>
        </div>
      `;
    }

    function bindPlay(ctx){
      function onHit(h){
        const m=ctx.match;
        if(m.finished) return;
        pushSnap(m);
        addThrow(m,h);
        render();
        saveFinish(ctx).catch(e=>showFatal("Save error", e?.message||String(e)));
      }
      document.getElementById("hitT").onclick=()=>onHit("T");
      document.getElementById("hitS").onclick=()=>onHit("S");
      document.getElementById("hitD").onclick=()=>onHit("D");
      document.getElementById("hitM").onclick=()=>onHit("M");
      document.getElementById("undoBtn").onclick=()=>{ match=popSnap(ctx.match); render(); };

      document.getElementById("resetBtn").onclick=()=>{
        const pls=ctx.match.players.map(p=>({name:p.name,email:p.email}));
        match=initMatch(pls);
        render();
      };
      document.getElementById("backToSetup").onclick=()=>{
        match=null; screen="game.setup"; render();
      };
    }

    return {initMatch, renderPlay, bindPlay};
  })();

  /* Killer */
  const KillerGame = (() => {
    const MAX_LIVES = 3;

    function initMatch(selectedPlayers){
      return {
        gameId:"killer",
        phase:"claim",
        claimIndex:0,
        players: selectedPlayers.map(p=>({
          name:p.name,
          email:p.email,
          number:null,
          lives:MAX_LIVES,
          killer:false,
          out:false
        })),
        turnIndex:0,
        dartInTurn:0,
        finished:false,
        winner:null,
        startedAt:now(),
        endedAt:null,
        _saved:false
      };
    }

    function nextAliveIndex(m, from){
      for(let step=1; step<=m.players.length; step++){
        const i=(from+step)%m.players.length;
        if(!m.players[i].out) return i;
      }
      return from;
    }

    function checkWinner(m){
      const alive=m.players.filter(p=>!p.out);
      if(alive.length===1){
        m.finished=true;
        m.winner=alive[0];
        m.endedAt=now();
      }
    }

    async function saveFinish(ctx){
      const m=ctx.match;
      if(!m.finished || m._saved) return;
      m._saved=true;

      const winnerName = m.winner?.name || "Unknown";
      const summary = `üèÜ ${winnerName} wins ‚Ä¢ ` + m.players
        .map(p=>`${p.name}${p.out?" (OUT)":""}`)
        .join(" | ");

      await saveHistoryEntry({
        gameId:"killer",
        gameName:"Killer",
        startedAt:m.startedAt,
        endedAt:m.endedAt,
        players:m.players.map(p=>p.email),
        summary,
        meta:{
          winnerEmail: m.winner?.email || null,
          numbers: m.players.map(p=>({email:p.email, number:p.number}))
        }
      });

      const stats=await getStatsDoc(ctx.meUser.email);
      const games=stats.games||{};
      const g=games.killer||{};
      const played=(g.played||0)+1;

      const iWon = (m.winner?.email === ctx.meUser.email);
      const wins = (g.wins||0) + (iWon?1:0);

      await saveStatsDoc(ctx.meUser.email,{
        games:{
          ...games,
          killer:{...g, played, wins, lastPlayedAt:m.endedAt||now()}
        },
        updatedAt:now()
      });
    }

    function heartsHTML(n){
      const count=Math.max(0, Number(n||0));
      if(!count) return "";
      return Array.from({length:count}, ()=>`<span class="heart">‚ô•</span>`).join("");
    }

    function renderPlay(ctx){
      const m=ctx.match;

      if(m.phase==="claim"){
        const p=m.players[m.claimIndex];
        const taken=m.players.filter(x=>x.number!=null).map(x=>x.number);
        let opts = `<option value="" selected disabled>Select a number‚Ä¶</option>`;
        for(let n=1;n<=20;n++){
          const dis=taken.includes(n) && p.number!==n;
          opts += `<option value="${n}" ${dis?"disabled":""}>${n}${dis?" (taken)":""}</option>`;
        }
        return `
          <div class="card">
            <div class="row">
              <button class="btn ghost" id="backToSetup">Back</button>
              <button class="btn danger" id="resetBtn">Reset</button>
            </div>
          </div>

          <div class="card">
            <div class="hero">
              <div class="heroCornerLeft">
                <div class="logoMark"><span>üî•</span></div>
              </div>

              <div class="heroMain">
                <div class="h1">${esc(p.name)}</div>
                <div class="sub">Opposite-hand throw ‚Äî pick your number.</div>
              </div>

              <div class="heroCornerRight">
                <span class="pill">Setup</span>
              </div>
            </div>
            <div class="divider"></div>
            <select id="claimNum">${opts}</select>
            <div class="divider"></div>
            <button class="btn ok" id="saveClaim">Save & Next</button>
          </div>
        `;
      }

      const active=m.players[m.turnIndex];
      const isFinished = !!m.finished;

      const rows = m.players.map(p=>{
        const livesHtml = p.out ? `<span class="lifeOut">OUT</span>` : heartsHTML(p.lives);
        return `
          <tr>
            <td class="l">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <div>
                  <div style="font-size:16px;font-weight:1000">${esc(p.name)}</div>
                  <div class="small kNumberBig">Number: <b>${esc(p.number??"?")}</b></div>
                </div>
                <div style="text-align:right">
                  <div class="kLivesBig">${livesHtml}</div>
                  <div class="small">${p.killer?"üî• Killer":p.out?"":""}</div>
                </div>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      const canAttack = (!isFinished) && active.killer;

      const attackTargets = m.players
        .filter(p=>!p.out && p.email!==active.email)
        .map(p=>{
          return `<button class="kAttackBtn" data-attack="${esc(p.email)}" ${canAttack?"":"disabled"}>
            HIT ${esc(p.name)}‚Äôs DOUBLE
            <div class="small">${esc(p.name)} ‚Ä¢ #${esc(p.number ?? "?")}</div>
          </button>`;
        }).join("");

      return `
        <div class="card">
          <div class="row">
            <button class="btn ghost" id="backToSetup">Back</button>
            <button class="btn danger" id="resetBtn">Reset</button>
          </div>
        </div>

        <div class="card ${isFinished?"":"leaderGlow"}" style="${isFinished?"animation:none":""}">
          <div class="hero">
            <div class="heroCornerLeft">
              <div class="logoMark"><span>üî•</span></div>
            </div>

            <div class="heroMain">
              <div class="h1">${isFinished ? "Game Over" : esc(active.name)}</div>
              <div class="sub">Dart <b>${m.dartInTurn+1}</b>/3 ‚Ä¢ ${active.killer?"üî• Killer":"Not killer yet"}</div>
            </div>

            <div class="heroCornerRight">
              <span class="pill" ${isFinished?'':'data-live="1"'}>${isFinished?"Ended":"Live"}</span>
            </div>
          </div>

          ${isFinished ? `<div class="divider"></div><div class="h1" style="text-align:center">üèÜ ${esc(m.winner?.name)} Wins!</div>` : `
            <div class="divider"></div>
            <div class="hitRow">
              <button class="hitBtn" id="myDouble">I HIT MY DOUBLE</button>
              <button class="hitBtn miss" id="miss">MISS</button>
              <button class="hitBtn undo" id="undoBtn">UNDO</button>
            </div>
            <div class="divider"></div>
            <div style="text-align:center; margin-bottom: 10px;"><span class="kbd">Attack Buttons</span></div>
            <div class="kAttackGrid">
              ${attackTargets || `<div class="sub">No opponents available.</div>`}
            </div>
          `}
        </div>

        <div class="card">
           <div style="display:flex; justify-content:space-between; align-items:center;">
             <span class="pill">Player Roster</span>
          </div>
          <div class="divider"></div>
          <div style="overflow:auto;border-radius:16px;border:1px solid rgba(255,255,255,.10)">
            <table>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>
      `;
    }

    function bindPlay(ctx){
      const m=ctx.match;

      const backBtn=document.getElementById("backToSetup");
      if(backBtn) backBtn.onclick=()=>{ match=null; screen="game.setup"; render(); };
      
      const resetBtn=document.getElementById("resetBtn");
      if(resetBtn) resetBtn.onclick=()=>{
          const pls=m.players.map(p=>({name:p.name,email:p.email}));
          match=initMatch(pls);
          render();
      };

      const claimBtn=document.getElementById("saveClaim");
      if(claimBtn){
        claimBtn.onclick=()=>{
          const p=m.players[m.claimIndex];
          const raw=document.getElementById("claimNum").value;
          const n=parseInt(raw,10);
          if(!n){ alert("Pick a number."); return; }
          if(m.players.some(x=>x.email!==p.email && x.number===n)){
            alert("That number is taken. Pick another.");
            return;
          }
          p.number=n;
          const next = m.players.findIndex(x=>x.number==null);
          if(next===-1){
            m.phase="play";
            m.turnIndex=0;
            m.dartInTurn=0;
            m.players.forEach(x=>{ x.out=false; x.killer=false; x.lives=MAX_LIVES; });
          } else {
            m.claimIndex=next;
          }
          render();
        };
        return;
      }

      if(m.finished){
        saveFinish(ctx).catch(e=>showFatal("Save error", e?.message||String(e)));
        return;
      }

      function pushK(m){ m.snaps=m.snaps||[]; m.snaps.push(JSON.stringify(m)); if(m.snaps.length>80) m.snaps.shift(); }
      function popK(m){
        if(!m?.snaps||m.snaps.length<2) return m;
        m.snaps.pop();
        const prev=m.snaps.pop();
        try{return JSON.parse(prev);}catch{return m;}
      }

      function endDart(){
        m.dartInTurn += 1;
        if(m.dartInTurn>=3){
          m.dartInTurn=0;
          m.turnIndex = nextAliveIndex(m, m.turnIndex);
        }
        checkWinner(m);
        render();
        if(m.finished){
          saveFinish(ctx).catch(e=>showFatal("Save error", e?.message||String(e)));
        }
      }

      document.getElementById("undoBtn").onclick=()=>{ match=popK(ctx.match); render(); };
      document.getElementById("miss").onclick=()=>{ pushK(m); endDart(); };
      document.getElementById("myDouble").onclick=()=>{
        pushK(m);
        const me=m.players[m.turnIndex];
        if(!me.killer) me.killer=true;
        else me.lives = Math.min(MAX_LIVES, me.lives+1);
        endDart();
      };

      appEl.querySelectorAll("button[data-attack]").forEach(btn=>{
        btn.onclick=()=>{
          const victimEmail=btn.getAttribute("data-attack");
          const victim=m.players.find(p=>p.email===victimEmail && !p.out);
          if(!victim) return;
          pushK(m);
          victim.lives -= 1;
          if(victim.lives<=0){ victim.lives=0; victim.out=true; }
          endDart();
        };
      });
    }

    return { initMatch, renderPlay, bindPlay };
  })();

  /* App state */
  let toastMsg="";
  let screen="auth"; 
  let meUser=null;
  let activeGameId=null;
  let match=null;
  let statsViewerEmail=null;
  let rulesGameId=null;
  const MAX_PLAYERS=4;

  function initials(name){
    const n=String(name||"").trim();
    if(!n) return "?";
    const parts=n.split(/\s+/).filter(Boolean);
    const a=(parts[0]?.[0]||"").toUpperCase();
    const b=(parts[1]?.[0]||"").toUpperCase();
    return (a+(b||"")).slice(0,2) || a || "?";
  }

  function rulesFor(gameId){
    if(gameId==="shanghai") return {
      title:"Shanghai",
      icon:"üéØ",
      bullets:[
        "Players take turns. Each turn is 3 darts.",
        "Targets go: 20, 19, 18, 17, 16, 15, then BULL.",
        "Score per dart: SINGLE=1, DOUBLE=2, TRIPLE=3, MISS=0.",
        "After everyone throws 3 darts, the target advances.",
        "Game ends after BULL round. Highest total points wins."
      ]
    };
    if(gameId==="killer") return {
      title:"Killer",
      icon:"üî•",
      bullets:[
        "Setup: each player claims a unique number (1‚Äì20).",
        "Start with 3 lives (‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è).",
        "On your turn you throw 3 darts.",
        "Hit YOUR number as a DOUBLE to become a KILLER (üî•).",
        "Once you‚Äôre a killer: you can ‚Äòattack‚Äô by hitting an opponent‚Äôs number as a DOUBLE.",
        "When you hit an opponent‚Äôs double: tap their attack button to remove 1 life.",
        "If a player reaches 0 lives, they are OUT.",
        "Last player alive wins."
      ]
    };
    return { title:"Game", icon:"üéØ", bullets:["Rules coming soon."] };
  }

  /* Screens */
  async function renderAuth(){
    signOutBtn.style.display="none";
    brandTitle.textContent="Game Night";
    let html = `${toastMsg?`<div class="toast">${esc(toastMsg)}</div>`:""}`;
    toastMsg="";
    html += `
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft">
            <div class="logoMark"><span>üéØ</span></div>
          </div>
          <div class="heroMain">
            <div class="h1">Game Night</div>
            <div class="sub">The Dart Room Online Training Tool</div>
          </div>
          <div class="heroCornerRight">
            <span class="pill">Auth</span>
          </div>
        </div>
      </div>
      <div class="card">
        <label>Email Address</label>
        <div class="stack">
          <input id="inEmail" type="email" placeholder="you@email.com" autocomplete="email"/>
          <button class="btn ok" id="goBtn">Sign In</button>
        </div>
      </div>
    `;
    appEl.innerHTML=html;
    document.getElementById("goBtn").onclick=async()=>{
      const e=normEmail(document.getElementById("inEmail").value);
      if(!e){ toastMsg="Enter a valid email."; return render(); }
      const player=await signInEmail(e);
      if(player){ meUser=player; statsViewerEmail=meUser.email; screen="home"; return render(); }
      meUser={email:e}; screen="signup"; return render();
    };
  }

  async function renderSignup(){
    signOutBtn.style.display="none";
    appEl.innerHTML=`
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft"><div class="logoMark"><span>üßæ</span></div></div>
          <div class="heroMain"><div class="h1">New Profile</div><div class="sub">Enter your name to start.</div></div>
        </div>
      </div>
      <div class="card">
        <label>Display Name</label>
        <div class="stack">
          <input id="upName" type="text" placeholder="Your Name" autocomplete="name"/>
          <button class="btn ok" id="createBtn">Create Account</button>
          <button class="btn ghost" id="backBtn">Cancel</button>
        </div>
      </div>
    `;
    document.getElementById("backBtn").onclick=()=>{ meUser=null; screen="auth"; render(); };
    document.getElementById("createBtn").onclick=async()=>{
      const n=String(document.getElementById("upName").value).trim();
      if(!n){ toastMsg="Enter your name."; return render(); }
      meUser=await signUpEmail(n, meUser.email);
      statsViewerEmail=meUser.email;
      screen="home";
      render();
    };
  }

  async function renderHome(){
    signOutBtn.style.display="inline-block";
    const players=await getPlayers();
    const myStats=await getStatsDoc(meUser.email);
    const sh=(myStats.games||{}).shanghai||{};

    const gameCards = Games.map(g=>{
      const soon=!g.active;
      return `
        <div class="gameCard">
          <div class="gameHead">
            <div class="gameTitle">
              <div class="gameIcon">${esc(g.icon||"üéØ")}</div>
              <div>
                <div class="h1" style="font-size:18px;margin:0">${esc(g.name)}</div>
                <div class="gameMeta">${esc(g.tagline||"")}</div>
              </div>
            </div>
            <div>${soon?`<span class="pill soon">Soon</span>`:`<span class="pill" data-live="1">Active</span>`}</div>
          </div>
          <div class="gameActions">
            <button class="btn ok" data-play="${esc(g.id)}" ${soon?"disabled":""}>Play</button>
            <button class="btn ghost" data-stats="${esc(g.id)}">Stats</button>
          </div>
        </div>
      `;
    }).join("");

    const roster = players.filter(p=>p.email!==meUser.email).map(p=>`
        <div class="rosterCard">
          <div class="rosterLeft">
            <div class="avatar">${esc(initials(p.name))}</div>
            <div>
              <div class="rosterName">${esc(p.name)}</div>
              <div class="rosterSub">${esc(p.email)}</div>
            </div>
          </div>
          <button class="btn ghost" data-view-player="${esc(p.email)}">View</button>
        </div>
      `).join("");

    appEl.innerHTML=`
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft"><div class="logoMark"><span>üë§</span></div></div>
          <div class="heroMain">
            <div class="h1">${esc(meUser.name)}</div>
            <div class="sub">${esc(meUser.email)}</div>
          </div>
          <div class="heroCornerRight"><span class="pill" data-live="1">Online</span></div>
        </div>
      </div>
      <div class="row">
        <button class="btn ghost" id="rulesBtn">Rules</button>
        <button class="btn ghost" id="statsBtn">Stats</button>
        <button class="btn ghost" id="historyBtn">History</button>
      </div>
      <div class="divider"></div>
      <div class="gameGrid">${gameCards}</div>
      <div class="divider"></div>
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft"><div class="logoMark"><span>üë•</span></div></div>
          <div class="heroMain"><div class="h1">Player Roster</div><div class="sub">View other players‚Äô performance.</div></div>
        </div>
        <div class="divider"></div>
        <div class="rosterGrid">${roster || `<div class="sub">No other players found.</div>`}</div>
      </div>
    `;

    document.getElementById("rulesBtn").onclick=()=>{ screen="rules"; render(); };
    document.getElementById("statsBtn").onclick=()=>{ screen="stats"; render(); };
    document.getElementById("historyBtn").onclick=()=>{ screen="history"; render(); };
    appEl.querySelectorAll("button[data-play]").forEach(btn=>btn.onclick=()=>{ activeGameId=btn.getAttribute("data-play"); screen="game.setup"; render(); });
    appEl.querySelectorAll("button[data-stats]").forEach(btn=>btn.onclick=()=>{ activeGameId=btn.getAttribute("data-stats"); screen="stats.game"; render(); });
    appEl.querySelectorAll("button[data-view-player]").forEach(btn=>btn.onclick=()=>{ statsViewerEmail=btn.getAttribute("data-view-player"); screen="stats"; render(); });
  }

  async function renderRules(){
    appEl.innerHTML=`
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft"><div class="logoMark"><span>üìú</span></div></div>
          <div class="heroMain"><div class="h1">Game Rules</div><div class="sub">Learn how to play.</div></div>
        </div>
        <div class="divider"></div>
        ${Games.map(g=>`
          <div class="rosterCard">
            <div class="rosterLeft">
              <div class="avatar">${esc(g.icon)}</div>
              <div><div class="rosterName">${esc(g.name)}</div></div>
            </div>
            <button class="btn" data-rule="${esc(g.id)}">Read Rules</button>
          </div>
        `).join("")}
        <div class="divider"></div>
        <button class="btn ghost" id="rulesBack">Back Home</button>
      </div>
    `;
    document.getElementById("rulesBack").onclick=()=>{ screen="home"; render(); };
    appEl.querySelectorAll("button[data-rule]").forEach(btn=>btn.onclick=()=>{ rulesGameId=btn.getAttribute("data-rule"); screen="rules.game"; render(); });
  }

  async function renderRulesGame(){
    const r=rulesFor(rulesGameId);
    appEl.innerHTML=`
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft"><div class="logoMark"><span>${esc(r.icon)}</span></div></div>
          <div class="heroMain"><div class="h1">${esc(r.title)}</div><div class="sub">How to Play</div></div>
        </div>
        <div class="divider"></div>
        <ul style="margin:0;padding-left:18px;line-height:1.6">
          ${r.bullets.map(b=>`<li style="margin:12px 0">${esc(b)}</li>`).join("")}
        </ul>
        <div class="divider"></div>
        <button class="btn ghost" id="rulesGameBack">Back</button>
      </div>
    `;
    document.getElementById("rulesGameBack").onclick=()=>{ screen="rules"; render(); };
  }

  async function renderGameSetup(){
    const g=getGame(activeGameId);
    const players=await getPlayers();
    appEl.innerHTML=`
      <div class="card"><div class="row"><button class="btn ghost" id="setupBack">Cancel</button></div></div>
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft"><div class="logoMark"><span>${esc(g.icon)}</span></div></div>
          <div class="heroMain"><div class="h1">${esc(g.name)}</div><div class="sub">Match Setup</div></div>
          <div class="heroCornerRight"><span class="pill" data-live="1">Ready</span></div>
        </div>
      </div>
      <div class="card">
        <div class="stack">
          <div class="row">
            <div><label>Total Players</label><select id="playerCount"><option value="1">1</option><option value="2" selected>2</option><option value="3">3</option><option value="4">4</option></select></div>
            <div><label>Ready</label><input id="selectedCount" type="text" disabled /></div>
          </div>
          <label>Select Participants</label>
          <select id="matchPlayers" multiple size="6">${players.map(p=>`<option value="${esc(p.email)}" ${p.email===meUser.email?"selected":""}>${esc(p.name)}</option>`).join("")}</select>
          <button class="btn ok" id="startMatchBtn" disabled>Start Match</button>
        </div>
      </div>
    `;
    const sel=document.getElementById("matchPlayers");
    const update=()=>{
      const n=parseInt(document.getElementById("playerCount").value,10);
      const count=Array.from(sel.selectedOptions).length;
      document.getElementById("selectedCount").value=`${count} / ${n}`;
      document.getElementById("startMatchBtn").disabled=(count!==n);
    };
    document.getElementById("playerCount").onchange=update; sel.onchange=update; update();
    document.getElementById("setupBack").onclick=()=>{ screen="home"; render(); };
    document.getElementById("startMatchBtn").onclick=()=>{
      const selected = Array.from(sel.selectedOptions).map(o=>players.find(p=>p.email===o.value));
      if(activeGameId==="shanghai") match=ShanghaiGame.initMatch(selected);
      else if(activeGameId==="killer") match=KillerGame.initMatch(selected);
      screen="game.play"; render();
    };
  }

  async function renderGamePlay(){
    if(activeGameId==="shanghai") { appEl.innerHTML=ShanghaiGame.renderPlay({meUser, match}); ShanghaiGame.bindPlay({meUser, match}); }
    else if(activeGameId==="killer") { appEl.innerHTML=KillerGame.renderPlay({meUser, match}); KillerGame.bindPlay({meUser, match}); }
  }

  async function renderStats(){
    const players=await getPlayers();
    const statsDoc=await getStatsDoc(statsViewerEmail||meUser.email);
    const viewer=players.find(p=>p.email===(statsViewerEmail||meUser.email))||meUser;
    appEl.innerHTML=`
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft"><div class="logoMark"><span>üìà</span></div></div>
          <div class="heroMain"><div class="h1">Performance</div><div class="sub">Viewing: <b>${esc(viewer.name)}</b></div></div>
        </div>
        <div class="divider"></div>
        <label>Switch Player</label>
        <select id="statsPlayer">${players.map(p=>`<option value="${esc(p.email)}" ${p.email===viewer.email?"selected":""}>${esc(p.name)}</option>`).join("")}</select>
      </div>
      ${Games.map(g=>{
        const gs=(statsDoc.games||{})[g.id]||{};
        return `<div class="gameCard"><div class="gameHead"><div class="gameTitle"><div class="gameIcon">${g.icon}</div><div><div class="h1" style="font-size:16px;margin:0">${g.name}</div><div class="gameMeta">Played: ${gs.played||0}</div></div></div><button class="btn ghost" data-open="${g.id}">Details</button></div></div>`;
      }).join("")}
      <button class="btn ghost" id="statsBack">Back Home</button>
    `;
    document.getElementById("statsBack").onclick=()=>{ screen="home"; render(); };
    document.getElementById("statsPlayer").onchange=(e)=>{ statsViewerEmail=e.target.value; render(); };
    appEl.querySelectorAll("button[data-open]").forEach(btn=>btn.onclick=()=>{ activeGameId=btn.getAttribute("data-open"); screen="stats.game"; render(); });
  }

  async function renderStatsGame(){
    const g=getGame(activeGameId);
    const statsDoc=await getStatsDoc(statsViewerEmail||meUser.email);
    const gs=(statsDoc.games||{})[g.id]||{};
    appEl.innerHTML=`
      <div class="card">
        <div class="hero">
          <div class="heroCornerLeft"><div class="logoMark"><span>${g.icon}</span></div></div>
          <div class="heroMain"><div class="h1">${g.name} Stats</div><div class="sub">${gs.played||0} Games Played</div></div>
        </div>
        <div class="divider"></div>
        <div class="sub">Best Score: <b>${gs.best||0}</b></div>
        <div class="sub">Total Wins: <b>${gs.wins||0}</b></div>
        <div class="divider"></div>
        <button class="btn ghost" id="statsGameBack">Back</button>
      </div>
    `;
    document.getElementById("statsGameBack").onclick=()=>{ screen="stats"; render(); };
  }

  async function renderHistory(){
    const history=await getHistory(meUser.email);
    appEl.innerHTML=`
      <div class="row"><button class="btn ghost" id="historyBack">Back</button></div>
      <div class="divider"></div>
      ${history.map(h=>`<div class="card"><div class="h1" style="font-size:15px;margin:0">${esc(h.summary)}</div><div class="sub">${esc(h.gameName)} ‚Ä¢ ${fmt(h.endedAt)}</div></div>`).join("") || `<div class="sub">No history yet.</div>`}
    `;
    document.getElementById("historyBack").onclick=()=>{ screen="home"; render(); };
  }

  async function render(){
    homeBtn.onclick=()=>{ screen=meUser?"home":"auth"; render(); };
    signOutBtn.onclick=()=>{ meUser=null; screen="auth"; render(); };
    if(screen==="auth") renderAuth();
    else if(screen==="signup") renderSignup();
    else if(screen==="home") renderHome();
    else if(screen==="rules") renderRules();
    else if(screen==="rules.game") renderRulesGame();
    else if(screen==="game.setup") renderGameSetup();
    else if(screen==="game.play") renderGamePlay();
    else if(screen==="stats") renderStats();
    else if(screen==="stats.game") renderStatsGame();
    else if(screen==="history") renderHistory();
  }
  render();
}
boot();
</script>
</body>
</html>
