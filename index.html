<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Midnight Games</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    :root{
      --bg:#0b1a2e;
      --text:#eaf2ff;
      --muted:#b9cbe5;
      --accent:#4ea8ff;
      --danger:#ff4d5a;
      --ok:#2bd576;
      --shadow: rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(1200px 700px at 40% 0%, #10335f 0%, var(--bg) 55%);
      color:var(--text);
    }
    .topbar{
      position:sticky;top:0;z-index:10;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;background:rgba(10,20,35,.78);backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .brand{display:flex;flex-direction:column;line-height:1.05}
    .brand .t{font-weight:900;font-size:16px}
    .brand .s{font-size:12px;color:var(--muted)}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:var(--text);border-radius:14px;padding:10px 12px;font-weight:900;
      box-shadow:0 6px 16px var(--shadow);
    }
    .btn:active{transform:translateY(1px)}
    .btn.ghost{background:transparent;box-shadow:none;color:var(--muted)}
    .btn.ok{background:rgba(43,213,118,.20);border-color:rgba(43,213,118,.35)}
    .btn.danger{background:rgba(255,77,90,.20);border-color:rgba(255,77,90,.35)}
    .wrap{max-width:920px;margin:0 auto;padding:14px}
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;padding:14px;
      box-shadow:0 10px 28px rgba(0,0,0,.28);
      margin-bottom:12px;
    }
    .h1{font-size:24px;font-weight:1000;margin:2px 0 6px}
    .sub{color:var(--muted);font-size:13px}
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    input, select{
      width:100%;
      background:rgba(10,20,35,.65);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius:14px;padding:12px 12px;font-size:16px;outline:none;
    }
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .stack{display:flex;flex-direction:column;gap:10px}
    .toast{
      background:rgba(255,77,90,.12);
      border:1px solid rgba(255,77,90,.30);
      color:#ffd6da;
      border-radius:14px;padding:10px 12px;font-weight:900;margin-bottom:12px;
    }
    .pill{
      display:inline-block;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(78,168,255,.08);
      color:var(--accent);font-weight:900;font-size:12px;
    }
    .divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .li{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;border-radius:16px;background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
    }
    .meta{display:flex;flex-direction:column;gap:2px}
    .meta .nm{font-weight:1000}
    .meta .em{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="t">Midnight Games</div>
      <div class="s">Developed & designed by Steve Moody</div>
    </div>
    <div>
      <button class="btn ghost" id="homeBtn" type="button">Home</button>
      <button class="btn ghost" id="signOutBtn" type="button" style="display:none;">Sign out</button>
    </div>
  </div>

  <div class="wrap" id="app"></div>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_MESSAGING_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Utilities
  function esc(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
  function now(){ return new Date().getTime(); }

  const appEl = document.getElementById("app");
  const homeBtn = document.getElementById("homeBtn");
  const signOutBtn = document.getElementById("signOutBtn");

  let toastMsg="", screen="auth", meEmail="", match=null;

  // ===== Firebase Functions =====
  async function getPlayers(){
    const snapshot = await db.collection("players").get();
    return snapshot.docs.map(d=>d.data());
  }
  async function upsertPlayer(name,email){
    await db.collection("players").doc(email).set({name,email,createdAt:now()},{merge:true});
  }

  // ===== Authentication =====
  async function signInEmail(email){
    const snapshot = await db.collection("players").doc(email).get();
    if(snapshot.exists){
      meEmail = email;
      screen = "home";
      render();
    } else {
      screen = "signup";
      meEmail = email;
      render();
    }
  }

  homeBtn.onclick = ()=>{ screen = meEmail ? "home" : "auth"; render(); };

  function render(){
    let html="";
    if(toastMsg) html += '<div class="toast">'+esc(toastMsg)+'</div>';
    toastMsg="";

    if(screen==="auth"){
      html += '<div class="card"><div class="h1">Enter your email</div></div>';
      html += '<div class="card"><input type="email" id="inEmail" placeholder="you@email.com"/><button class="btn ok" id="goBtn">Go</button></div>';
      appEl.innerHTML=html;

      document.getElementById("goBtn").onclick=()=>signInEmail(document.getElementById("inEmail").value);
      return;
    }

    if(screen==="signup"){
      html += '<div class="card"><div class="h1">Create Player</div></div>';
      html += '<div class="card"><input type="text" id="upName" placeholder="Your name"/><button class="btn ok" id="createBtn">Create Player</button></div>';
      appEl.innerHTML=html;

      document.getElementById("createBtn").onclick=async ()=>{
        const n=document.getElementById("upName").value.trim();
        if(!n){ toastMsg="Enter a name"; render(); return; }
        await upsertPlayer(n,meEmail);
        screen="home";
        render();
      };
      return;
    }

    if(screen==="home"){
      html += '<div class="card"><span class="pill">Signed in</span><div class="h1">'+esc(meEmail)+'</div></div>';
      html += '<div class="row"><button class="btn" id="playNowBtn">Play Now</button></div>';
      appEl.innerHTML=html;

      document.getElementById("playNowBtn").onclick=()=>{ screen="match"; render(); };
      signOutBtn.style.display="inline-block";
      return;
    }
  }

  render();
</script>
</body>
</html>
<!-- Part 2 continuation -->
<script>
// ===== Additional Game Logic Functions =====

// Highlight flashing target for active players
function highlightTargetSVG(activeTarget) {
  const board = document.querySelector(".boardBox svg");
  if (!board) return;
  const paths = board.querySelectorAll("path");
  paths.forEach(p => p.classList.remove("activeFlash"));
  const idx = BOARD_NUMS.indexOf(activeTarget);
  if (idx >= 0) {
    const angleStart = idx * 18; // 360 / 20 = 18deg
    const angleEnd = angleStart + 18;
    const activePath = board.querySelector("path:nth-child(" + (idx + 2) + ")");
    if (activePath) activePath.classList.add("activeFlash");
  }
}

// CSS for flashing (inserted dynamically)
const flashStyle = document.createElement("style");
flashStyle.innerHTML = `
@keyframes flash {0% {opacity:1;}50% {opacity:0.3;}100% {opacity:1;}}
.activeFlash { animation: flash 0.7s infinite; stroke-width:2.5 !important; stroke:rgba(255,255,0,0.95) !important; }
`;
document.head.appendChild(flashStyle);

// ===== Firebase Real-Time Updates for Players =====
const playersRef = db.collection("players");
let allPlayers = [];

async function loadAllPlayers() {
  const snapshot = await playersRef.get();
  allPlayers = snapshot.docs.map(d => d.data());
}
async function refreshAllPlayersDropdown() {
  await loadAllPlayers();
  const oppSel = document.getElementById("oppSel");
  if (!oppSel) return;
  const current = meUser.email;
  oppSel.innerHTML = '<option value="">Select opponent…</option>';
  allPlayers.forEach(p => {
    if (p.email !== current) {
      oppSel.innerHTML += `<option value="${esc(p.email)}">${esc(p.name)}</option>`;
    }
  });
}

// ===== Play Screen Update =====
async function renderPlayScreen() {
  if (!match) { screen="home"; render(); return; }
  const t = TARGETS[match.targetIndex];
  const active = match.players[match.turnIndex];

  let html = `<div class="card">
    <div class="sub">Target: <b>${esc(targetLabel(t))}</b> • Turn: <b>${esc(active.name)}</b> • Dart ${match.dartInTurn+1}/3</div>
    <div class="divider"></div>
    <div class="boardBox">${dartboardSVG(t)}</div>
    <div class="divider"></div>
    <div class="hitRow">
      <button class="hitBtn" id="hitT">T</button>
      <button class="hitBtn" id="hitS">S</button>
      <button class="hitBtn" id="hitD">D</button>
      <button class="hitBtn miss" id="hitM">M</button>
    </div>
    <div class="divider"></div>
    <div class="hitRow">
      <button class="hitBtn undo" id="undoBtn">Undo</button>
      <button class="hitBtn next" id="nextBtn">Next</button>
    </div>
  </div>`;

  // Round table
  let thead = '<tr><th>Target</th>';
  match.players.forEach(p => {
    thead += `<th>${esc(p.name)}<div class="small">${p.total} pts</div></th>`;
  });
  thead += '</tr>';

  let tbody = '';
  for (let r=0; r<TARGETS.length; r++) {
    const key = String(TARGETS[r]);
    tbody += `<tr><td class="l"><span class="badge">${esc(targetLabel(TARGETS[r]))}</span></td>`;
    match.players.forEach(p => {
      const cell = match.grid[p.email][key];
      const txt = cell.throws.length ? cell.throws.join(" ") : "—";
      const bonus = cell.shanghai ? " ✨" : "";
      const cls = (String(t)===key) ? ' class="activeCell"' : "";
      tbody += `<td${cls}>${esc(txt)}${bonus}<div class="small">${cell.points}</div></td>`;
    });
    tbody += '</tr>';
  }

  html += `<div class="card">
    <div class="pill">Round table</div><div class="divider"></div>
    <div style="overflow:auto;border-radius:16px;border:1px solid rgba(255,255,255,.10)">
      <table><thead>${thead}</thead><tbody>${tbody}</tbody></table>
    </div>
  </div>`;

  appEl.innerHTML = html;

  // Flash current target
  highlightTargetSVG(t);

  // Button handlers
  document.getElementById("hitT").onclick = ()=>{ addThrow(match,"T"); saveMatchSnap(); renderPlayScreen(); };
  document.getElementById("hitS").onclick = ()=>{ addThrow(match,"S"); saveMatchSnap(); renderPlayScreen(); };
  document.getElementById("hitD").onclick = ()=>{ addThrow(match,"D"); saveMatchSnap(); renderPlayScreen(); };
  document.getElementById("hitM").onclick = ()=>{ addThrow(match,"M"); saveMatchSnap(); renderPlayScreen(); };
  document.getElementById("undoBtn").onclick = ()=>{ popSnap(); renderPlayScreen(); };
  document.getElementById("nextBtn").onclick = ()=>{
    while(match.dartInTurn<3){ addThrow(match,"M"); saveMatchSnap(); }
    if(match.finished) saveCompletedMatch();
    renderPlayScreen();
  };
}

// ===== Saving snaps for undo =====
function saveMatchSnap() {
  if (!match) return;
  match.snaps.push(JSON.stringify(match));
  if (match.snaps.length>60) match.snaps.shift();
}

// ===== Firebase Integration for Stats and History =====
async function saveCompletedMatch() {
  if (!match || !match.finished) return;
  // Save history
  const histEntry = {
    gameId:"shanghai",
    startedAt:match.startedAt,
    endedAt:match.endedAt||now(),
    players:match.players.map(p=>p.email),
    summary:"Shanghai • "+match.players.map(p=>p.name+": "+p.total).join(" | ")
  };
  await db.collection("history").add(histEntry);

  // Save stats per player
  for(const pl of match.players){
    const docRef = db.collection("stats").doc(pl.email);
    const doc = await docRef.get();
    let stats = doc.exists ? doc.data() : {};
    stats.shanghai = stats.shanghai || {games:0,best:0,totalPoints:0,byTarget:{}};
    const sh = stats.shanghai;
    sh.games += 1;
    sh.totalPoints += pl.total;
    if(pl.total>sh.best) sh.best = pl.total;

    for(const t of TARGETS){
      const key = String(t);
      sh.byTarget[key] = sh.byTarget[key] || {S:0,D:0,T:0,M:0,points:0};
      const cell = match.grid[pl.email][key];
      cell.throws.forEach(h=>{
        if(["S","D","T","M"].includes(h)) sh.byTarget[key][h] += 1;
        if(["S","D","T"].includes(h)) sh.byTarget[key].points += pts(h);
      });
      if(cell.shanghai) sh.byTarget[key].points += 5;
    }
    await docRef.set(stats,{merge:true});
  }
}

// ===== Initialize Opponent Dropdown =====
async function initOpponentDropdown() {
  await refreshAllPlayersDropdown();
}

// ===== On Load =====
window.onload = async ()=>{
  await initOpponentDropdown();
  if(meUser) screen="home"; else screen="auth";
  render();
};
</script>
<!-- Part 3 continuation -->
<script>
// ===== Sign-In / Sign-Up Rendering =====
async function renderAuthScreen() {
  let html = `<div class="card"><div class="h1">Sign In / Sign Up</div>
  <div class="sub">Enter your email. If new, you’ll be prompted for your name.</div></div>
  <div class="card"><div class="stack">
    <label>Email</label><input type="email" id="inEmail" placeholder="you@email.com"/>
    <div class="row">
      <button class="btn" id="signInBtn">Go</button>
    </div>
    <div id="namePromptCard" style="display:none;">
      <label>Name</label><input type="text" id="inName" placeholder="Your name"/>
      <div class="row">
        <button class="btn ok" id="createBtn">Create Player</button>
      </div>
    </div>
  </div></div>`;
  appEl.innerHTML = html;

  document.getElementById("signInBtn").onclick = async ()=>{
    const email = document.getElementById("inEmail").value.trim().toLowerCase();
    if(!email){ toastMsg="Enter a valid email."; renderAuthScreen(); return; }
    const playerDoc = await db.collection("players").doc(email).get();
    if(playerDoc.exists){
      meUser = { email, name: playerDoc.data().name };
      screen="home"; renderHomeScreen();
    } else {
      document.getElementById("namePromptCard").style.display = "block";
    }
  };

  document.getElementById("createBtn").onclick = async ()=>{
    const email = document.getElementById("inEmail").value.trim().toLowerCase();
    const name = document.getElementById("inName").value.trim();
    if(!name){ toastMsg="Enter a name."; renderAuthScreen(); return; }
    await db.collection("players").doc(email).set({name,email,createdAt:now()});
    meUser = { email, name };
    screen="home"; renderHomeScreen();
  };
}

// ===== Home Screen Rendering =====
async function renderHomeScreen() {
  if(!meUser) { screen="auth"; renderAuthScreen(); return; }

  let html = `<div class="card">
    <span class="pill">Signed in</span>
    <div class="h1">${esc(meUser.name)}</div>
    <div class="sub">${esc(meUser.email)}</div>
    <div class="divider"></div>
    <div class="row">
      <button class="btn" id="playNowBtn">Play Now</button>
      <button class="btn ghost" id="statsBtn">My Stats</button>
      <button class="btn ghost" id="histBtn">History</button>
    </div>
  </div>`;
  appEl.innerHTML = html;

  document.getElementById("playNowBtn").onclick = ()=>{ screen="match"; renderMatchScreen(); };
  document.getElementById("statsBtn").onclick = ()=>{ screen="stats"; renderStatsScreen(); };
  document.getElementById("histBtn").onclick = ()=>{ screen="history"; renderHistoryScreen(); };
}

// ===== Match Setup Rendering =====
async function renderMatchScreen() {
  if(!meUser){ screen="auth"; renderAuthScreen(); return; }
  await refreshAllPlayersDropdown();
  let html = `<div class="card">
    <span class="pill">Add Players</span>
    <div class="h1">Select up to 3 opponents</div>
  </div>
  <div class="card">
    <div class="li"><div class="meta"><div class="nm">${esc(meUser.name)}</div><div class="em">${esc(meUser.email)}</div></div><span class="badge">You</span></div>
    <div class="divider"></div>
    <label>Add opponent</label>
    <select id="oppSel">
      <option value="">Select opponent…</option>
      ${allPlayers.filter(p=>p.email!==meUser.email).map(p=>`<option value="${esc(p.email)}">${esc(p.name)}</option>`).join("")}
    </select>
    <div class="row" style="margin-top:10px;">
      <button class="btn" id="addBtn">Add</button>
      <button class="btn ghost" id="backBtn">Back</button>
    </div>
    <div class="divider"></div>
    <div id="pickedWrap" class="small"></div>
    <div class="row" style="margin-top:10px;">
      <button class="btn ok" id="startBtn">Start Shanghai</button>
      <button class="btn danger" id="clearBtn">Clear</button>
    </div>
  </div>`;

  appEl.innerHTML = html;

  let picked = [];
  function redrawPicked() {
    const wrap = document.getElementById("pickedWrap");
    if(picked.length===0){ wrap.innerHTML="No opponents added yet (solo allowed)."; return; }
    wrap.innerHTML = picked.map(e=>{
      const pl = allPlayers.find(p=>p.email===e);
      return `<div class="li" style="margin-top:10px;">
        <div class="meta"><div class="nm">${esc(pl.name)}</div><div class="em">${esc(pl.email)}</div></div>
        <button class="btn danger" data-rem="${esc(pl.email)}">Remove</button>
      </div>`;
    }).join("");
    wrap.querySelectorAll("[data-rem]").forEach(btn=>{
      btn.onclick = ()=>{
        const e = btn.getAttribute("data-rem");
        picked = picked.filter(x=>x!==e);
        redrawPicked();
      };
    });
  }
  redrawPicked();

  document.getElementById("addBtn").onclick = ()=>{
    const sel = document.getElementById("oppSel").value;
    if(!sel) return;
    if(picked.includes(sel)) return;
    if(picked.length>=3) return;
    picked.push(sel);
    redrawPicked();
    document.getElementById("oppSel").value="";
  };
  document.getElementById("clearBtn").onclick = ()=>{ picked=[]; redrawPicked(); };
  document.getElementById("backBtn").onclick = ()=>{ screen="home"; renderHomeScreen(); };
  document.getElementById("startBtn").onclick = ()=>{
    const players = [{name:meUser.name,email:meUser.email}];
    picked.forEach(e=>{
      const pl = allPlayers.find(p=>p.email===e);
      if(pl) players.push({name:pl.name,email:pl.email});
    });
    match = newMatch(players);
    match.snaps=[];
    pushSnap();
    screen="play";
    renderPlayScreen();
  };
}

// ===== Render Entry Point =====
async function render() {
  switch(screen){
    case "auth": await renderAuthScreen(); break;
    case "home": await renderHomeScreen(); break;
    case "match": await renderMatchScreen(); break;
    case "play": await renderPlayScreen(); break;
    case "stats": await renderStatsScreen(); break;
    case "history": await renderHistoryScreen(); break;
  }
}

// ===== Navigation Buttons =====
homeBtn.onclick = ()=>{ screen = meUser?"home":"auth"; render(); };
signOutBtn.onclick = async ()=>{ meUser=null; screen="auth"; await auth.signOut(); render(); };
</script>
<!-- Part 4 continuation -->
<script>
// ===== Play Screen Rendering =====
async function renderPlayScreen() {
  if(!match){ screen="home"; renderHomeScreen(); return; }
  const t = TARGETS[match.targetIndex];
  const active = match.players[match.turnIndex];

  // Table header
  let thead = `<tr><th>Target</th>`;
  match.players.forEach(p=>{
    thead += `<th>${esc(p.name)}<div class="small">${p.total} pts</div></th>`;
  });
  thead += `</tr>`;

  // Table body
  let tbody = "";
  TARGETS.forEach(r=>{
    const key = String(r);
    tbody += `<tr><td class="l"><span class="badge">${esc(targetLabel(r))}</span></td>`;
    match.players.forEach(p=>{
      const cell = match.grid[p.email][key];
      const txt = cell.throws.length?cell.throws.join(" "):"—";
      const bonus = cell.shanghai?" ✨":"";
      const cls = (String(t)===key)?' class="activeCell"':'';
      tbody += `<td${cls}>${esc(txt)}${bonus}<div class="small">${cell.points}</div></td>`;
    });
    tbody += `</tr>`;
  });

  let html = `<div class="card">
    <div class="row">
      <button class="btn ghost" id="backHome">Back</button>
      <button class="btn danger" id="resetBtn">Reset</button>
    </div></div>
    <div class="card">
      <span class="pill">Shanghai (Accuracy)</span>
      <div class="divider"></div>
      <div class="sub">Target: <b>${esc(targetLabel(t))}</b> • Turn: <b>${esc(active.name)}</b> • Dart ${match.dartInTurn+1}/3</div>
      <div class="divider"></div>
      <div class="boardBox">${dartboardSVG(t,true)}</div>
      <div class="divider"></div>
      <div class="hitRow">
        <button class="hitBtn" id="hitT">T</button>
        <button class="hitBtn" id="hitS">S</button>
        <button class="hitBtn" id="hitD">D</button>
        <button class="hitBtn miss" id="hitM">M</button>
      </div>
      <div class="divider"></div>
      <div class="hitRow">
        <button class="hitBtn undo" id="undoBtn">Undo</button>
        <button class="hitBtn next" id="nextBtn">Next</button>
      </div>
      ${match.finished?'<div class="divider"></div><div class="pill">Finished • Saved to stats + history</div>':''}
    </div>
    <div class="card">
      <div class="pill">Round Table</div>
      <div class="divider"></div>
      <div style="overflow:auto;border-radius:16px;border:1px solid rgba(255,255,255,.10)">
        <table><thead>${thead}</thead><tbody>${tbody}</tbody></table>
      </div>
    </div>`;

  appEl.innerHTML = html;

  // Hit buttons
  ["T","S","D","M"].forEach(h=>{
    document.getElementById("hit"+h).onclick = ()=>{
      if(match.finished) return;
      pushSnap();
      addThrow(match,h);
      if(match.finished) saveCompletedMatch();
      renderPlayScreen();
    };
  });

  // Undo
  document.getElementById("undoBtn").onclick = ()=>{
    if(popSnap()) renderPlayScreen();
  };

  // Next (skip remaining darts)
  document.getElementById("nextBtn").onclick = ()=>{
    while(match.dartInTurn<3){ pushSnap(); addThrow(match,"M"); }
    if(match.finished) saveCompletedMatch();
    renderPlayScreen();
  };

  // Reset
  document.getElementById("resetBtn").onclick = ()=>{
    const pls = match.players.map(p=>({name:p.name,email:p.email}));
    match = newMatch(pls); match.snaps=[]; pushSnap(); renderPlayScreen();
  };

  // Back
  document.getElementById("backHome").onclick = ()=>{ match=null; screen="home"; renderHomeScreen(); };
}

// ===== Dartboard Flash Enhancement =====
function dartboardSVG(activeNumber, flash=false){
  const cx=100,cy=100,outer=98,rTripleOuter=62,rTripleInner=54,rDoubleOuter=92,rDoubleInner=84,rSingleInner=16;
  const seg=360/20;
  const BOARD_NUMS=[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];
  let idx=-1;
  if(typeof activeNumber==="number"){ idx=BOARD_NUMS.indexOf(activeNumber); }
  let activePath="";
  if(idx>=0){
    const a0=idx*seg+1.2,a1=(idx+1)*seg-1.2;
    activePath=arcWedgePath(cx,cy,rTripleOuter+2,rDoubleInner-2,a0,a1);
  }
  let pathHtml = '';
  if(activePath){
    const glowOpacity = flash?Math.random():0.55;
    pathHtml=`<path d="${activePath}" fill="rgba(78,168,255,.16)" stroke="rgba(78,168,255,${glowOpacity})" stroke-width="1.4" filter="url(#glow)"/>`;
  }
  // Include other rings as before...
  return `<svg viewBox="0 0 200 200" width="94%">${pathHtml}</svg>`;
}

// ===== Stats & History Screens =====
async function renderStatsScreen(){
  if(!meUser){ screen="auth"; renderAuthScreen(); return; }
  const statsData = await getStats(meUser.email);
  const sh = statsData.shanghai||{games:0,best:0,totalPoints:0,byTarget:{}};
  const avg = sh.games?Math.round(sh.totalPoints/sh.games*10)/10:0;
  let bars="";
  for(const t of TARGETS){
    const k=String(t);
    const bt=sh.byTarget[k]||{points:0};
    const w=Math.round((bt.points/Math.max(...TARGETS.map(t2=>sh.byTarget[String(t2)]?.points||1)))*100);
    bars+=`<div class="barRow"><div class="barLabel">${esc(targetLabel(t))}</div><div class="barOuter"><div class="barInner" style="width:${w}%"></div></div><div class="barVal">${bt.points} pts</div></div>`;
  }
  let html=`<div class="card"><div class="row"><button class="btn ghost" id="backHome1">Back</button></div></div>
    <div class="card"><span class="pill">My Stats</span><div class="h1">Shanghai</div><div class="divider"></div>
    <div class="kpi"><div class="box"><div class="v">${sh.games}</div><div class="l">Games played</div></div><div class="box"><div class="v">${sh.best}</div><div class="l">Best score</div></div><div class="box"><div class="v">${avg}</div><div class="l">Average score</div></div></div></div>
    <div class="card"><span class="pill">Points by target</span><div class="divider">${bars}</div></div>`;
  appEl.innerHTML=html;
  document.getElementById("backHome1").onclick=()=>{ screen="home"; renderHomeScreen(); };
}

async function renderHistoryScreen(){
  if(!meUser){ screen="auth"; renderAuthScreen(); return; }
  const hist = await getHistory(meUser.email);
  let list="";
  if(hist.length===0) list='<div class="sub">No matches yet.</div>';
  else hist.forEach(h=>{
    list+=`<div class="li"><div class="meta"><div class="nm">${esc(h.summary)}</div><div class="em">${new Date(h.endedAt).toLocaleString()}</div></div></div>`;
  });
  let html=`<div class="card"><div class="row"><button class="btn ghost" id="backHome2">Back</button></div></div>
  <div class="card"><span class="pill">Match History</span><div class="divider">${list}</div></div>`;
  appEl.innerHTML=html;
  document.getElementById("backHome2").onclick=()=>{ screen="home"; renderHomeScreen(); };
}

// ===== Initial Load =====
render();
</script>
