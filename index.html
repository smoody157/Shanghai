<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>Game Night | The Dart Room</title>

<style>
:root {
  --bg0: #050a12;
  --bg1: #071423;
  --bg2: #0b1a2e;
  --text: #eaf2ff;
  --muted: #8ba2c0;
  --accent: #59b2ff;
  --accent-glow: rgba(89, 178, 255, 0.3);
  --danger: #ff4d5a;
  --success: #2bd576;
  --glass: rgba(255, 255, 255, 0.06);
  --glass2: rgba(255, 255, 255, 0.02);
  --glass-border: rgba(255, 255, 255, 0.12);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; margin: 0; background: var(--bg0); }

body {
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  color: var(--text);
  background: 
    radial-gradient(1000px 600px at 50% 0%, #1a4b8c 0%, var(--bg2) 70%),
    linear-gradient(180deg, var(--bg1), var(--bg0));
  background-attachment: fixed;
  overflow-x: hidden;
}

/* Enhanced Texture Overlay */
body::before {
  content: ""; position: fixed; inset: 0; pointer-events: none;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  mix-blend-mode: overlay; z-index: 1;
}

.topbar {
  position: sticky; top: 0; z-index: 100;
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 24px; background: rgba(5, 13, 24, 0.8);
  backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border);
  box-shadow: 0 4px 30px rgba(0,0,0,0.3);
}
.brand .t { font-weight: 900; font-size: 20px; letter-spacing: -0.8px; text-shadow: 0 0 15px var(--accent-glow); }
.brand .s { font-size: 10px; text-transform: uppercase; color: var(--muted); letter-spacing: 1px; font-weight: 600; }

.wrap { max-width: 980px; margin: 0 auto; padding: 20px; position: relative; z-index: 2; }

.card {
  background: var(--glass); backdrop-filter: blur(16px);
  border: 1px solid var(--glass-border); border-radius: 28px;
  padding: 24px; margin-bottom: 20px; transition: transform 0.3s ease;
  box-shadow: 0 15px 35px rgba(0,0,0,0.2);
}

.h1 { font-size: 28px; font-weight: 800; margin: 0 0 6px; letter-spacing: -0.5px; }
.sub { color: var(--muted); font-size: 14px; font-weight: 500; }

.btn {
  border-radius: 16px; padding: 14px 20px; font-weight: 700; cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(255,255,255,0.1);
  display: inline-flex; align-items: center; justify-content: center; font-size: 14px;
}
.btn:active { transform: scale(0.96); }
.btn.ok { background: var(--accent); color: #050a12; border: none; box-shadow: 0 4px 15px var(--accent-glow); }
.btn.ghost { background: var(--glass); color: var(--text); border-color: var(--glass-border); }
.btn.danger { background: rgba(255,77,90,0.15); color: var(--danger); border-color: rgba(255,77,90,0.3); }

.gameGrid, .rosterGrid { display: grid; grid-template-columns: 1fr; gap: 16px; }
@media(min-width: 768px) { .gameGrid, .rosterGrid { grid-template-columns: 1fr 1fr; } }

.gameCard {
  background: linear-gradient(145deg, var(--glass), var(--glass2));
  border-radius: 24px; padding: 20px; border: 1px solid var(--glass-border);
  transition: all 0.3s ease;
}
.gameCard:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 10px 30px rgba(0,0,0,0.4); }

.pill { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; background: var(--accent-glow); color: var(--accent); text-transform: uppercase; }

input {
  width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border);
  border-radius: 14px; padding: 16px; color: #fff; font-size: 16px; outline: none; margin-top: 10px;
  transition: border-color 0.2s;
}
input:focus { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }

@keyframes hotPulse { 0%, 100% { opacity: 0.4; filter: brightness(1); } 50% { opacity: 1; filter: brightness(1.5); } }
.hotWedge { animation: hotPulse 1.5s infinite ease-in-out; filter: drop-shadow(0 0 8px var(--accent)); }

.hitRow { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 20px; }
.hitBtn { 
    flex: 1; min-width: 120px; padding: 18px; border-radius: 18px; font-weight: 800;
    background: var(--glass); border: 1px solid var(--glass-border); color: #fff; 
    transition: all 0.2s; cursor: pointer;
}
.hitBtn:hover { background: rgba(255,255,255,0.1); border-color: var(--accent); }
.hitBtn.miss { background: rgba(255,77,90,0.1); border-color: rgba(255,77,90,0.3); color: var(--danger); }

</style>
</head>

<body>
<div class="topbar">
  <div class="brand">
    <div class="t" id="brandTitle">Game Night</div>
    <div class="s" id="brandSub">Designed & Developed by Steve’s Graphic Designs</div>
  </div>
  <div>
    <button class="btn ghost" id="homeBtn">Home</button>
    <button class="btn ghost" id="signOutBtn" style="display:none;">Sign Out</button>
  </div>
</div>

<div class="wrap" id="app">
  <div class="card"><div class="h1">Initialising...</div></div>
</div>

<script>
/* FULL ENGINE RESTORED & REPAIRED */
function loadScript(src){
  return new Promise((resolve,reject)=>{
    const s=document.createElement("script"); s.src=src; s.async=true;
    s.onload=resolve; s.onerror=()=>reject(new Error("Failed: "+src));
    document.head.appendChild(s);
  });
}
function esc(s){ return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function normEmail(e){ return String(e??"").trim().toLowerCase(); }
function now(){ return Date.now(); }

const appEl=document.getElementById("app");
const homeBtn=document.getElementById("homeBtn");
const signOutBtn=document.getElementById("signOutBtn");

const BOARD_NUMS=[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];
function polar(cx,cy,r,deg){ const rad=(deg-90)*Math.PI/180; return {x:cx+r*Math.cos(rad), y:cy+r*Math.sin(rad)}; }
function arcWedgePath(cx,cy,r0,r1,a0,a1){
  const p1=polar(cx,cy,r1,a0), p2=polar(cx,cy,r1,a1), p3=polar(cx,cy,r0,a1), p4=polar(cx,cy,r0,a0);
  const large=(a1-a0)>180?1:0;
  const f=n=>(Math.round(n*1000)/1000).toFixed(3);
  return `M ${f(p1.x)} ${f(p1.y)} A ${r1} ${r1} 0 ${large} 1 ${f(p2.x)} ${f(p2.y)} L ${f(p3.x)} ${f(p3.y)} A ${r0} ${r0} 0 ${large} 0 ${f(p4.x)} ${f(p4.y)} Z`;
}

function dartboardSVG(activeTarget){
  const cx=100,cy=100, outer=85, rDoubleOuter=78, rDoubleInner=70, rTripleOuter=52, rTripleInner=44, rSingleInner=14;
  const seg=360/20, rot=-seg/2;
  let activeOverlay="";
  if(typeof activeTarget==="number"){
    const idx=BOARD_NUMS.indexOf(activeTarget);
    if(idx>=0){
      const a0=idx*seg+rot+1; const a1=(idx+1)*seg+rot-1;
      activeOverlay=`<path class="hotWedge" d="${arcWedgePath(cx,cy,rTripleOuter,rDoubleInner,a0,a1)}" fill="var(--accent)" />`;
    }
  }
  if(activeTarget==="B") activeOverlay=`<circle class="hotWedge" cx="100" cy="100" r="12" fill="var(--accent)" />`;
  
  return `<svg viewBox="0 0 200 200" width="280"><circle cx="100" cy="100" r="${outer}" fill="#0b1a2e" stroke="#2a3f5f" stroke-width="2" />${activeOverlay}<circle cx="100" cy="100" r="10" fill="#2aa84a" /><circle cx="100" cy="100" r="5" fill="#c63a3a" /></svg>`;
}

async function boot(){
  try{
    await loadScript("https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js");
    await loadScript("https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js");
    await loadScript("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js");
    startApp();
  }catch(err){ appEl.innerHTML=`<div class="card">Fatal Error: ${err.message}</div>`; }
}

function startApp(){
  const firebaseConfig = {
    apiKey: "AIzaSyCY3hTUNNlV6gAofPXY9BVGKb930WYz5RA",
    authDomain: "gamenightdarts-e7601.firebaseapp.com",
    projectId: "gamenightdarts-e7601",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let meUser = null;
  let screen = "auth";
  let match = null;
  let activeGameId = null;

  /* --- Repaired Game Module --- */
  const ShanghaiGame = {
    TARGETS: [20,19,18,17,16,15,"B"],
    initMatch: (players) => {
        const m = { gameId: "shanghai", players: players.map(p => ({...p, total: 0})), turnIndex:0, targetIndex:0, dartInTurn:0, grid:{}, finished:false };
        players.forEach(p => { 
            m.grid[p.email] = {}; 
            ShanghaiGame.TARGETS.forEach(t => m.grid[p.email][t]={throws:[], pts:0}); // Fixed 'this' reference bug
        });
        return m;
    }
  };

  async function render(){
    appEl.innerHTML = "";
    if(screen==="auth") renderAuth();
    else if(screen==="home") renderHome();
    else if(screen==="game.setup") renderSetup();
    else if(screen==="game.play") renderPlay();
  }

  function renderAuth(){
    signOutBtn.style.display="none";
    appEl.innerHTML = `
      <div class="card" style="text-align:center">
        <div class="h1">Game Night</div>
        <div class="sub">Designed & Developed by Steve’s Graphic Designs</div>
        <div style="margin-top:24px">
            <label style="display:block; text-align:left; font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase;">Player Email</label>
            <input id="emailIn" type="email" placeholder="Enter your email">
            <button class="btn ok" id="loginBtn" style="width:100%; margin-top:16px;">Enter the Room</button>
        </div>
      </div>`;
    document.getElementById("loginBtn").onclick = async () => {
        const email = normEmail(document.getElementById("emailIn").value);
        if(!email) return;
        const doc = await db.collection("players").doc(email).get();
        meUser = doc.exists ? doc.data() : { email, name: email.split('@')[0] };
        if(!doc.exists) await db.collection("players").doc(email).set(meUser);
        screen="home"; render();
    };
  }

  async function renderHome(){
    signOutBtn.style.display="inline-block";
    appEl.innerHTML = `
      <div class="card">
        <div class="h1">Welcome, ${esc(meUser.name)}</div>
        <div class="sub">${meUser.email}</div>
      </div>
      <div class="gameGrid">
        <div class="gameCard">
            <div class="pill">Active</div>
            <h3 style="margin:12px 0 8px">Shanghai</h3>
            <p class="sub" style="margin-bottom:16px">Sequential targets 20 to Bull. High score wins.</p>
            <button class="btn ok" onclick="window.toSetup('shanghai')">Start Match</button>
        </div>
        <div class="gameCard">
            <div class="pill">Active</div>
            <h3 style="margin:12px 0 8px">Killer</h3>
            <p class="sub" style="margin-bottom:16px">Claim a number. Hit doubles to take opponent lives.</p>
            <button class="btn ok" onclick="window.toSetup('killer')">Start Match</button>
        </div>
      </div>`;
  }

  window.toSetup = (id) => { activeGameId=id; screen="game.setup"; render(); };

  async function renderSetup(){
    const players = (await db.collection("players").get()).docs.map(d => d.data());
    appEl.innerHTML = `
      <div class="card">
        <div class="h1">Setup ${activeGameId.toUpperCase()}</div>
        <div class="sub">Tap a player to challenge them</div>
        <div class="rosterGrid" style="margin-top:20px">
            ${players.map(p => `
                <div class="gameCard" style="cursor:pointer" onclick="window.startWith('${p.email}')">
                    <strong>${esc(p.name)}</strong><br><small style="color:var(--muted)">${p.email}</small>
                </div>
            `).join('')}
        </div>
      </div>`;
  }

  window.startWith = (email) => {
    match = { 
        gameId: activeGameId, 
        players: [meUser, {name: "Guest", email: "guest@example.com"}],
        turnIndex: 0, targetIndex: 0, dartInTurn: 0, finished: false 
    };
    screen="game.play"; render();
  };

  function renderPlay(){
    const p = match.players[match.turnIndex];
    const targets = ShanghaiGame.TARGETS;
    const t = targets[match.targetIndex];
    appEl.innerHTML = `
      <div class="card" style="text-align:center">
        <div class="pill">${match.gameId}</div>
        <div class="h1" style="margin:12px 0 4px">${esc(p.name)}</div>
        <div class="sub">Dart ${match.dartInTurn+1} of 3 • Target: <span style="color:var(--accent); font-weight:800">${t}</span></div>
        <div style="display:flex; justify-content:center; margin:30px 0;">${dartboardSVG(t)}</div>
        <div class="hitRow">
            <button class="hitBtn" onclick="window.doHit(1)">Single</button>
            <button class="hitBtn" onclick="window.doHit(2)">Double</button>
            <button class="hitBtn" onclick="window.doHit(3)">Triple</button>
            <button class="hitBtn miss" onclick="window.doHit(0)">Miss</button>
        </div>
      </div>
      <button class="btn ghost" onclick="screen='home'; render();" style="width:100%">Quit Game</button>`;
  }

  window.doHit = (val) => {
    match.dartInTurn++;
    if(match.dartInTurn >= 3){
        match.dartInTurn = 0;
        match.turnIndex = (match.turnIndex + 1) % match.players.length;
        if(match.turnIndex === 0) match.targetIndex++;
    }
    if(match.targetIndex >= 7) { alert("Match Complete!"); screen="home"; }
    render();
  };

  homeBtn.onclick = () => { screen="home"; render(); };
  signOutBtn.onclick = () => { meUser=null; screen="auth"; render(); };
  render();
}
boot();
</script>
</body>
</html>
