<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game Night Darts</title>
  <style>
    :root{
      --bg:#0b1a2e;
      --text:#eaf2ff;
      --muted:#b9cbe5;
      --accent:#4ea8ff;
      --danger:#ff4d5a;
      --ok:#2bd576;
      --shadow: rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(1200px 700px at 40% 0%, #10335f 0%, var(--bg) 55%);
      color:var(--text);
    }
    .topbar{
      position:sticky;top:0;z-index:10;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;background:rgba(10,20,35,.78);backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .brand{display:flex;flex-direction:column;line-height:1.05}
    .brand .t{font-weight:900;font-size:16px}
    .brand .s{font-size:12px;color:var(--muted)}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:var(--text);border-radius:14px;padding:10px 12px;font-weight:900;
      box-shadow:0 6px 16px var(--shadow);
    }
    .btn:active{transform:translateY(1px)}
    .btn.ghost{background:transparent;box-shadow:none;color:var(--muted)}
    .btn.ok{background:rgba(43,213,118,.20);border-color:rgba(43,213,118,.35)}
    .btn.danger{background:rgba(255,77,90,.20);border-color:rgba(255,77,90,.35)}
    .wrap{max-width:920px;margin:0 auto;padding:14px}
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;padding:14px;
      box-shadow:0 10px 28px rgba(0,0,0,.28);
      margin-bottom:12px;
    }
    .h1{font-size:24px;font-weight:1000;margin:2px 0 6px}
    .sub{color:var(--muted);font-size:13px}
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    input, select{
      width:100%;
      background:rgba(10,20,35,.65);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius:14px;padding:12px 12px;font-size:16px;outline:none;
    }
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .stack{display:flex;flex-direction:column;gap:10px}
    .toast{
      background:rgba(255,77,90,.12);
      border:1px solid rgba(255,77,90,.30);
      color:#ffd6da;
      border-radius:14px;padding:10px 12px;font-weight:900;margin-bottom:12px;
    }
    .pill{
      display:inline-block;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(78,168,255,.08);
      color:var(--accent);font-weight:900;font-size:12px;
    }
    .divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .li{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;border-radius:16px;background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
    }
    .meta{display:flex;flex-direction:column;gap:2px}
    .meta .nm{font-weight:1000}
    .meta .em{font-size:12px;color:var(--muted)}
    .boardBox{
      width:100%;
      height:320px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:radial-gradient(circle at 50% 40%, rgba(78,168,255,.10), rgba(0,0,0,.12) 55%, rgba(0,0,0,.22));
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      box-shadow: inset 0 0 40px rgba(0,0,0,.35);
    }
    .hitRow{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .hitBtn{
      border-radius:16px;padding:14px 10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(78,168,255,.16);
      color:var(--text);
      font-weight:1000;font-size:16px;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    .hitBtn:active{transform:translateY(1px)}
    .hitBtn.miss{background:rgba(255,77,90,.18);border-color:rgba(255,77,90,.30)}
    .hitBtn.undo{background:rgba(255,255,255,.08);color:var(--muted)}
    .hitBtn.next{background:rgba(43,213,118,.18);border-color:rgba(43,213,118,.30)}
    .small{font-size:12px;color:var(--muted)}
    table{border-collapse:collapse;width:100%;min-width:560px;background:rgba(0,0,0,.14)}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:center}
    th{font-size:12px;color:var(--muted);font-weight:1000;background:rgba(255,255,255,.05)}
    td.l{text-align:left}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);font-size:12px;color:var(--muted)}
    .activeCell{outline:2px solid rgba(78,168,255,.55);outline-offset:-2px;border-radius:10px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .box{flex:1;min-width:150px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:10px}
    .kpi .box .v{font-weight:1000;font-size:20px}
    .kpi .box .l{font-size:12px;color:var(--muted)}
    .barRow{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.10)}
    .barRow:last-child{border-bottom:none}
    .barLabel{width:56px;font-weight:1000;color:#dfe9ff}
    .barOuter{flex:1;height:12px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);overflow:hidden}
    .barInner{height:100%;background:rgba(78,168,255,.55)}
    .barVal{width:70px;text-align:right;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="t">Game Night Darts</div>
      <div class="s">The Dart Room presents • Developed & designed by Steve’s Graphic Designs</div>
    </div>
    <div>
      <button class="btn ghost" id="homeBtn" type="button">Home</button>
      <button class="btn ghost" id="signOutBtn" type="button" style="display:none;">Sign out</button>
    </div>
  </div>

  <div class="wrap" id="app"></div>

<script>
function esc(s){
  s = String(s === undefined || s === null ? "" : s);
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function normEmail(s){ return String(s||"").trim().toLowerCase(); }
function now(){ return new Date().getTime(); }
function readJSON(k, fallback){
  try{ var v = localStorage.getItem(k); return v ? JSON.parse(v) : fallback; }
  catch(e){ return fallback; }
}
function writeJSON(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }

var LS_PLAYERS="gnd_players_v3";
var LS_SESSION="gnd_session_email_v3";
var LS_STATS="gnd_stats_v3";
var LS_HISTORY="gnd_history_v3";

var appEl=document.getElementById("app");
var homeBtn=document.getElementById("homeBtn");
var signOutBtn=document.getElementById("signOutBtn");

var toastMsg="";
var screen="auth"; // auth | home | match | play | stats | history
var meEmail="";
try{ meEmail = localStorage.getItem(LS_SESSION) || ""; }catch(e){ meEmail=""; }

var match=null;

function getPlayers(){ return readJSON(LS_PLAYERS, []); }
function savePlayers(a){ writeJSON(LS_PLAYERS, a); }
function findPlayer(email){
  email=normEmail(email);
  var a=getPlayers();
  for(var i=0;i<a.length;i++){ if(a[i].email===email) return a[i]; }
  return null;
}
function upsertPlayer(name,email){
  name=String(name||"").trim();
  email=normEmail(email);
  var a=getPlayers(), found=null;
  for(var i=0;i<a.length;i++){ if(a[i].email===email){ found=a[i]; break; } }
  if(found){ if(name) found.name=name; }
  else { a.push({name:name,email:email,createdAt:now()}); }
  savePlayers(a);
  return findPlayer(email);
}
function me(){ return meEmail ? findPlayer(meEmail) : null; }

function getStats(){ return readJSON(LS_STATS, {}); }
function saveStats(s){ writeJSON(LS_STATS, s); }
function getHistory(){ return readJSON(LS_HISTORY, []); }
function saveHistory(h){ writeJSON(LS_HISTORY, h); }

function ensureShanghaiStats(obj){
  if(!obj.shanghai){
    obj.shanghai={games:0,best:0,totalPoints:0,byTarget:{}};
  }
  return obj.shanghai;
}

var TARGETS=[20,19,18,17,16,15,"B"];
function pts(hit){ return hit==="T"?3 : hit==="D"?2 : hit==="S"?1 : 0; }
function targetLabel(t){ return t==="B" ? "BULL" : String(t); }

function newMatch(players){
  var m={
    gameId:"shanghai",
    players:[],
    turnIndex:0,
    targetIndex:0,
    dartInTurn:0,
    grid:{},
    finished:false,
    startedAt:now(),
    endedAt:null,
    snaps:[]
  };
  for(var i=0;i<players.length;i++){
    m.players.push({name:players[i].name,email:players[i].email,total:0});
    m.grid[players[i].email]={};
    for(var j=0;j<TARGETS.length;j++){
      var k=String(TARGETS[j]);
      m.grid[players[i].email][k]={throws:[],points:0,shanghai:false};
    }
  }
  return m;
}

function pushSnap(){
  if(!match) return;
  try{
    match.snaps.push(JSON.stringify(match));
    if(match.snaps.length>60) match.snaps.shift();
  }catch(e){}
}
function popSnap(){
  if(!match || !match.snaps || match.snaps.length<2) return false;
  match.snaps.pop();
  var prev=match.snaps.pop();
  if(!prev) return false;
  try{ match=JSON.parse(prev); return true; }catch(e){ return false; }
}

function addThrow(m, hit){
  if(m.finished) return;
  var p=m.players[m.turnIndex];
  var t=TARGETS[m.targetIndex];
  var key=String(t);
  var cell=m.grid[p.email][key];

  cell.throws.push(hit);
  cell.points += pts(hit);
  p.total += pts(hit);

  if(cell.throws.length===3){
    var a=cell.throws, hasS=false,hasT=false,hasD=false;
    for(var i=0;i<a.length;i++){
      if(a[i]==="S") hasS=true;
      if(a[i]==="T") hasT=true;
      if(a[i]==="D") hasD=true;
    }
    if(hasS && hasT && hasD && a[2]==="D"){
      cell.shanghai=true;
      cell.points += 5;
      p.total += 5;
    }
  }

  m.dartInTurn++;
  if(m.dartInTurn>=3){
    m.dartInTurn=0;
    m.turnIndex=(m.turnIndex+1) % m.players.length;
    if(m.turnIndex===0){
      m.targetIndex++;
      if(m.targetIndex>=TARGETS.length){
        m.finished=true;
        m.endedAt=now();
      }
    }
  }
}

function saveCompletedMatch(){
  if(!match || !match.finished) return;

  var hist=getHistory();
  var summaryParts=[];
  for(var i=0;i<match.players.length;i++){
    summaryParts.push(match.players[i].name + ": " + match.players[i].total);
  }
  hist.unshift({
    gameId:"shanghai",
    startedAt:match.startedAt,
    endedAt:match.endedAt || now(),
    players:match.players,
    summary:"Shanghai • " + summaryParts.join(" | ")
  });
  if(hist.length>120) hist.length=120;
  saveHistory(hist);

  var stats=getStats();
  for(var pi=0;pi<match.players.length;pi++){
    var pl=match.players[pi];
    if(!stats[pl.email]) stats[pl.email]={};
    var sh=ensureShanghaiStats(stats[pl.email]);

    sh.games += 1;
    sh.totalPoints += pl.total;
    if(pl.total > sh.best) sh.best = pl.total;

    for(var ti=0;ti<TARGETS.length;ti++){
      var tk=String(TARGETS[ti]);
      if(!sh.byTarget[tk]) sh.byTarget[tk]={S:0,D:0,T:0,M:0,points:0};
      var cell=match.grid[pl.email][tk];
      for(var di=0;di<cell.throws.length;di++){
        var h=cell.throws[di];
        if(h==="S"||h==="D"||h==="T"||h==="M") sh.byTarget[tk][h] += 1;
        sh.byTarget[tk].points += pts(h);
      }
      if(cell.shanghai) sh.byTarget[tk].points += 5;
    }
  }
  saveStats(stats);
}

/* dartboard */
var BOARD_NUMS=[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];
function polar(cx,cy,r,deg){
  var rad=(deg-90)*Math.PI/180;
  return {x: cx + r*Math.cos(rad), y: cy + r*Math.sin(rad)};
}
function arcWedgePath(cx,cy,r0,r1,a0,a1){
  var p1=polar(cx,cy,r1,a0), p2=polar(cx,cy,r1,a1);
  var p3=polar(cx,cy,r0,a1), p4=polar(cx,cy,r0,a0);
  var large=((a1-a0)>180)?1:0;
  function f(n){ return (Math.round(n*1000)/1000).toFixed(3); }
  return "M "+f(p1.x)+" "+f(p1.y)
    +" A "+r1+" "+r1+" 0 "+large+" 1 "+f(p2.x)+" "+f(p2.y)
    +" L "+f(p3.x)+" "+f(p3.y)
    +" A "+r0+" "+r0+" 0 "+large+" 0 "+f(p4.x)+" "+f(p4.y)
    +" Z";
}
function dartboardSVG(activeNumber){
  var cx=100,cy=100;
  var outer=98, rDoubleOuter=92, rDoubleInner=84, rTripleOuter=62, rTripleInner=54, rSingleInner=16;
  var seg=360/20;

  var idx=-1;
  if(typeof activeNumber==="number"){
    for(var i=0;i<BOARD_NUMS.length;i++){ if(BOARD_NUMS[i]===activeNumber){ idx=i; break; } }
  }
  var activePath="";
  if(idx>=0){
    var a0=idx*seg+1.2, a1=(idx+1)*seg-1.2;
    activePath=arcWedgePath(cx,cy,rTripleOuter+2,rDoubleInner-2,a0,a1);
  }

  function ringWedges(r0,r1,fillA,fillB){
    var out="";
    for(var i=0;i<20;i++){
      var a0=i*seg+0.8, a1=(i+1)*seg-0.8;
      var p=arcWedgePath(cx,cy,r0,r1,a0,a1);
      out += '<path d="'+p+'" fill="'+(i%2===0?fillA:fillB)+'" opacity="0.95"/>';
    }
    return out;
  }

  var numText="";
  for(var i=0;i<20;i++){
    var ang=i*seg+seg/2;
    var p=polar(cx,cy,95,ang);
    numText += '<text x="'+p.x.toFixed(2)+'" y="'+p.y.toFixed(2)+'" text-anchor="middle" dominant-baseline="middle" font-size="8.5" fill="#dfe9ff" font-weight="900" style="paint-order:stroke;stroke:#07101d;stroke-width:2px">'+BOARD_NUMS[i]+'</text>';
  }

  return ''+
  '<svg viewBox="0 0 200 200" width="94%" aria-label="dartboard">'+
    '<defs>'+
      '<radialGradient id="bgG" cx="50%" cy="42%" r="65%">'+
        '<stop offset="0%" stop-color="#203a62"/>'+
        '<stop offset="55%" stop-color="#0d1a2e"/>'+
        '<stop offset="100%" stop-color="#060d18"/>'+
      '</radialGradient>'+
      '<filter id="glow" x="-30%" y="-30%" width="160%" height="160%">'+
        '<feGaussianBlur stdDeviation="3.5" result="b"/>'+
        '<feColorMatrix in="b" type="matrix" values="0 0 0 0 0.30  0 0 0 0 0.66  0 0 0 0 1.00  0 0 0 .9 0" result="c"/>'+
        '<feMerge><feMergeNode in="c"/><feMergeNode in="SourceGraphic"/></feMerge>'+
      '</filter>'+
    '</defs>'+
    '<circle cx="100" cy="100" r="'+outer+'" fill="url(#bgG)" stroke="#2a3f5f" stroke-width="2"/>'+
    (activePath ? '<path d="'+activePath+'" fill="rgba(78,168,255,.16)" stroke="rgba(78,168,255,.55)" stroke-width="1.4" filter="url(#glow)"/>' : '')+
    ringWedges(rTripleOuter,rDoubleInner,"#0b1220","#1a2338")+
    ringWedges(rTripleInner,rTripleOuter,"#2aa84a","#c63a3a")+
    ringWedges(rDoubleInner,rDoubleOuter,"#2aa84a","#c63a3a")+
    ringWedges(rSingleInner,rTripleInner,"#1a2338","#0b1220")+
    '<circle cx="100" cy="100" r="11.5" fill="#2aa84a" stroke="#1b2b42" stroke-width="2"/>'+
    '<circle cx="100" cy="100" r="5.3" fill="#c63a3a" stroke="#1b2b42" stroke-width="1.5"/>'+
    numText+
    '<g>'+
      '<rect x="60" y="8" rx="8" ry="8" width="80" height="18" fill="rgba(0,0,0,.35)" stroke="rgba(255,255,255,.12)"/>'+
      '<text x="100" y="21" text-anchor="middle" font-size="9.5" fill="#cfe4ff" font-weight="900">TARGET: '+(activeNumber==="B"?"BULL":activeNumber)+'</text>'+
    '</g>'+
  '</svg>';
}

/* nav */
homeBtn.onclick=function(){
  toastMsg="";
  screen = meEmail ? "home" : "auth";
  render();
};
signOutBtn.onclick=function(){
  try{ localStorage.removeItem(LS_SESSION); }catch(e){}
  meEmail=""; match=null; toastMsg=""; screen="auth"; render();
};

function render(){
  if(meEmail && screen==="auth") screen="home";
  signOutBtn.style.display = meEmail ? "inline-block" : "none";

  var html="";
  if(toastMsg) html += '<div class="toast">'+esc(toastMsg)+'</div>';
  if(!meEmail) screen="auth";

  if(screen==="auth"){
    html += ''+
    '<div class="card"><div class="h1">Sign in</div><div class="sub">Enter your email. If you’re new, create an account.</div></div>'+
    '<div class="card"><div class="stack">'+
      '<div><label>Email</label><input id="inEmail" inputmode="email" placeholder="you@email.com"/></div>'+
      '<div class="row"><button class="btn" id="signInBtn" type="button">Sign in</button>'+
      '<button class="btn ghost" id="showUpBtn" type="button">Sign up</button></div>'+
    '</div></div>'+
    '<div class="card" id="upCard" style="display:none;">'+
      '<span class="pill">Create account</span><div class="divider"></div>'+
      '<div class="stack">'+
        '<div><label>Name</label><input id="upName" placeholder="Steve Moody"/></div>'+
        '<div><label>Email</label><input id="upEmail" inputmode="email" placeholder="you@email.com"/></div>'+
        '<div class="row"><button class="btn ok" id="createBtn" type="button">Create</button>'+
        '<button class="btn ghost" id="cancelBtn" type="button">Cancel</button></div>'+
      '</div></div>';
    appEl.innerHTML=html;

    document.getElementById("signInBtn").onclick=function(){
      toastMsg="";
      var e=normEmail(document.getElementById("inEmail").value);
      if(!e || e.indexOf("@")<0){ toastMsg="Enter a valid email."; render(); return; }
      var p=findPlayer(e);
      if(!p){ toastMsg="No account found. Use Sign up."; render(); return; }
      meEmail=e;
      try{ localStorage.setItem(LS_SESSION,e); }catch(err){}
      screen="home"; render();
    };
    document.getElementById("showUpBtn").onclick=function(){ document.getElementById("upCard").style.display="block"; };
    document.getElementById("cancelBtn").onclick=function(){ document.getElementById("upCard").style.display="none"; };
    document.getElementById("createBtn").onclick=function(){
      toastMsg="";
      var n=String(document.getElementById("upName").value||"").trim();
      var e=normEmail(document.getElementById("upEmail").value);
      if(!n){ toastMsg="Enter your name."; render(); return; }
      if(!e || e.indexOf("@")<0){ toastMsg="Enter a valid email."; render(); return; }
      upsertPlayer(n,e);
      meEmail=e;
      try{ localStorage.setItem(LS_SESSION,e); }catch(err){}
      screen="home"; render();
    };
    return;
  }

  if(screen==="home"){
    var p=me();
    html += ''+
    '<div class="card">'+
      '<span class="pill">Signed in</span>'+
      '<div class="h1" style="margin-top:8px;">'+esc(p?p.name:"")+'</div>'+
      '<div class="sub">'+esc(p?p.email:"")+'</div>'+
      '<div class="divider"></div>'+
      '<div class="row">'+
        '<button class="btn" id="playNowBtn" type="button">Play Now</button>'+
        '<button class="btn" id="soloBtn" type="button">Practice Solo</button>'+
      '</div>'+
      '<div class="row" style="margin-top:10px;">'+
        '<button class="btn ghost" id="statsBtn" type="button">My Stats</button>'+
        '<button class="btn ghost" id="histBtn" type="button">Match History</button>'+
      '</div>'+
    '</div>';
    appEl.innerHTML=html;

    document.getElementById("soloBtn").onclick=function(){
      toastMsg="";
      var p=me();
      match=newMatch([{name:p.name,email:p.email}]);
      match.snaps=[]; pushSnap();
      screen="play"; render();
    };
    document.getElementById("playNowBtn").onclick=function(){ toastMsg=""; screen="match"; render(); };
    document.getElementById("statsBtn").onclick=function(){ toastMsg=""; screen="stats"; render(); };
    document.getElementById("histBtn").onclick=function(){ toastMsg=""; screen="history"; render(); };
    return;
  }

  if(screen==="stats"){
    var p=me();
    var allStats=getStats();
    var mine = allStats[p.email] ? allStats[p.email] : {};
    var sh = mine.shanghai ? mine.shanghai : {games:0,best:0,totalPoints:0,byTarget:{}};
    var avg = sh.games ? Math.round((sh.totalPoints/sh.games)*10)/10 : 0;

    var maxPts=0;
    for(var i=0;i<TARGETS.length;i++){
      var k=String(TARGETS[i]);
      var bt=sh.byTarget[k] ? sh.byTarget[k] : {points:0,S:0,D:0,T:0,M:0};
      if(bt.points>maxPts) maxPts=bt.points;
    }
    if(maxPts<1) maxPts=1;

    var bars="";
    for(var i=0;i<TARGETS.length;i++){
      var t=TARGETS[i], k=String(t);
      var bt=sh.byTarget[k] ? sh.byTarget[k] : {points:0,S:0,D:0,T:0,M:0};
      var w=Math.round((bt.points/maxPts)*100);
      bars += '<div class="barRow">'+
        '<div class="barLabel">'+esc(targetLabel(t))+'</div>'+
        '<div class="barOuter"><div class="barInner" style="width:'+w+'%"></div></div>'+
        '<div class="barVal">'+bt.points+' pts</div>'+
      '</div>';
    }

    html += ''+
      '<div class="card"><div class="row">'+
        '<button class="btn ghost" id="backHome1" type="button">Back</button>'+
        '<button class="btn danger" id="clearStatsBtn" type="button">Clear My Stats</button>'+
      '</div></div>'+
      '<div class="card">'+
        '<span class="pill">My Stats</span>'+
        '<div class="h1" style="margin-top:8px;">Shanghai</div>'+
        '<div class="sub">T=3, D=2, S=1, M=0 • Shanghai bonus +5</div>'+
        '<div class="divider"></div>'+
        '<div class="kpi">'+
          '<div class="box"><div class="v">'+sh.games+'</div><div class="l">Games played</div></div>'+
          '<div class="box"><div class="v">'+sh.best+'</div><div class="l">Best score</div></div>'+
          '<div class="box"><div class="v">'+avg+'</div><div class="l">Average score</div></div>'+
        '</div>'+
      '</div>'+
      '<div class="card"><span class="pill">Points by target</span><div class="divider"></div>'+bars+'</div>';

    appEl.innerHTML=html;
    document.getElementById("backHome1").onclick=function(){ screen="home"; render(); };
    document.getElementById("clearStatsBtn").onclick=function(){
      var all=getStats();
      if(all[p.email] && all[p.email].shanghai){ delete all[p.email].shanghai; saveStats(all); }
      toastMsg="Stats cleared."; render();
    };
    return;
  }

  if(screen==="history"){
    var p=me();
    var hist=getHistory();
    var mine=[];
    for(var i=0;i<hist.length;i++){
      var h=hist[i], isMine=false;
      for(var j=0;j<h.players.length;j++){ if(h.players[j].email===p.email){ isMine=true; break; } }
      if(isMine) mine.push(h);
    }
    if(mine.length>60) mine.length=60;

    var list="";
    if(mine.length===0) list='<div class="sub">No matches yet.</div>';
    else{
      for(var i=0;i<mine.length;i++){
        list += '<div class="li"><div class="meta">'+
          '<div class="nm">'+esc(mine[i].summary)+'</div>'+
          '<div class="em">'+esc(new Date(mine[i].endedAt).toLocaleString())+'</div>'+
        '</div></div>';
      }
    }

    html += ''+
      '<div class="card"><div class="row">'+
        '<button class="btn ghost" id="backHome2" type="button">Back</button>'+
        '<button class="btn danger" id="clearHistBtn" type="button">Clear My History</button>'+
      '</div></div>'+
      '<div class="card"><span class="pill">Match History</span>'+
      '<div class="h1" style="margin-top:8px;">Your recent games</div><div class="divider"></div>'+list+'</div>';

    appEl.innerHTML=html;
    document.getElementById("backHome2").onclick=function(){ screen="home"; render(); };
    document.getElementById("clearHistBtn").onclick=function(){
      var hist=getHistory(), keep=[];
      for(var i=0;i<hist.length;i++){
        var h=hist[i], hasMe=false;
        for(var j=0;j<h.players.length;j++){ if(h.players[j].email===p.email){ hasMe=true; break; } }
        if(!hasMe) keep.push(h);
      }
      saveHistory(keep);
      toastMsg="History cleared."; render();
    };
    return;
  }

  if(screen==="match"){
    var p=me();
    var all=getPlayers(), opp=[];
    for(var i=0;i<all.length;i++){ if(all[i].email!==p.email) opp.push(all[i]); }

    html += ''+
    '<div class="card"><span class="pill">Play Now</span>'+
    '<div class="h1" style="margin-top:8px;">Add players (1–4)</div>'+
    '<div class="sub">You are already added. Add up to 3 opponents.</div></div>'+
    '<div class="card">'+
      '<div class="li"><div class="meta"><div class="nm">'+esc(p.name)+'</div><div class="em">'+esc(p.email)+'</div></div><span class="badge">You</span></div>'+
      '<div class="divider"></div>'+
      '<label>Add opponent</label>'+
      '<select id="oppSel"><option value="">Select opponent…</option>'+
      (function(){
        var s="";
        for(var i=0;i<opp.length;i++){
          s+='<option value="'+esc(opp[i].email)+'">'+esc(opp[i].name)+' • '+esc(opp[i].email)+'</option>';
        }
        return s;
      })()+
      '</select>'+
      '<div class="row" style="margin-top:10px;">'+
        '<button class="btn" id="addBtn" type="button">Add</button>'+
        '<button class="btn ghost" id="backBtn" type="button">Back</button>'+
      '</div>'+
      '<div class="divider"></div>'+
      '<div id="pickedWrap" class="small"></div>'+
      '<div class="row" style="margin-top:10px;">'+
        '<button class="btn ok" id="startBtn" type="button">Start Shanghai</button>'+
        '<button class="btn danger" id="clearBtn" type="button">Clear</button>'+
      '</div>'+
    '</div>';

    appEl.innerHTML=html;

    var picked=[];
    function redrawPicked(){
      var wrap=document.getElementById("pickedWrap");
      if(picked.length===0){ wrap.innerHTML="No opponents added yet (solo allowed)."; return; }
      var out="";
      for(var i=0;i<picked.length;i++){
        var pl=findPlayer(picked[i]);
        out += '<div class="li" style="margin-top:10px;">'+
          '<div class="meta"><div class="nm">'+esc(pl.name)+'</div><div class="em">'+esc(pl.email)+'</div></div>'+
          '<button class="btn danger" data-rem="'+esc(pl.email)+'" type="button">Remove</button>'+
        '</div>';
      }
      wrap.innerHTML=out;
      var btns=wrap.querySelectorAll("[data-rem]");
      for(var j=0;j<btns.length;j++){
        btns[j].onclick=function(){
          var e=this.getAttribute("data-rem");
          var n=[];
          for(var k=0;k<picked.length;k++) if(picked[k]!==e) n.push(picked[k]);
          picked=n; redrawPicked();
        };
      }
    }
    redrawPicked();

    document.getElementById("backBtn").onclick=function(){ screen="home"; render(); };
    document.getElementById("clearBtn").onclick=function(){ picked=[]; redrawPicked(); };
    document.getElementById("addBtn").onclick=function(){
      toastMsg="";
      var e=document.getElementById("oppSel").value;
      if(!e){ toastMsg="Pick an opponent."; render(); return; }
      for(var i=0;i<picked.length;i++){ if(picked[i]===e){ toastMsg="Already added."; render(); return; } }
      if(picked.length>=3){ toastMsg="Max 4 players total."; render(); return; }
      picked.push(e);
      document.getElementById("oppSel").value="";
      redrawPicked();
    };
    document.getElementById("startBtn").onclick=function(){
      var players=[{name:p.name,email:p.email}];
      for(var i=0;i<picked.length;i++){
        var pl=findPlayer(picked[i]);
        if(pl) players.push({name:pl.name,email:pl.email});
      }
      match=newMatch(players);
      match.snaps=[]; pushSnap();
      screen="play"; render();
    };
    return;
  }

  if(screen==="play"){
    if(!match){ screen="home"; render(); return; }

    var t=TARGETS[match.targetIndex];
    var active=match.players[match.turnIndex];

    var thead='<tr><th>Target</th>';
    for(var i=0;i<match.players.length;i++){
      thead+='<th>'+esc(match.players[i].name)+'<div class="small">'+match.players[i].total+' pts</div></th>';
    }
    thead+='</tr>';

    var tbody='';
    for(var r=0;r<TARGETS.length;r++){
      var key=String(TARGETS[r]);
      tbody+='<tr><td class="l"><span class="badge">'+esc(targetLabel(TARGETS[r]))+'</span></td>';
      for(var c=0;c<match.players.length;c++){
        var p=match.players[c];
        var cell=match.grid[p.email][key];
        var txt = cell.throws.length ? cell.throws.join(" ") : "—";
        var bonus = cell.shanghai ? " ✨" : "";
        var cls = (String(t)===key) ? ' class="activeCell"' : "";
        tbody+='<td'+cls+'>'+esc(txt)+bonus+'<div class="small">'+cell.points+'</div></td>';
      }
      tbody+='</tr>';
    }

    html += ''+
    '<div class="card"><div class="row">'+
      '<button class="btn ghost" id="backHome" type="button">Back</button>'+
      '<button class="btn danger" id="resetBtn" type="button">Reset</button>'+
    '</div></div>'+
    '<div class="card">'+
      '<span class="pill">Shanghai (Accuracy)</span>'+
      '<div class="divider"></div>'+
      '<div class="sub">Target: <b>'+esc(targetLabel(t))+'</b> • Turn: <b>'+esc(active.name)+'</b> • Dart '+(match.dartInTurn+1)+'/3</div>'+
      '<div class="divider"></div>'+
      '<div class="boardBox">'+dartboardSVG(t)+'</div>'+
      '<div class="divider"></div>'+
      '<div class="hitRow">'+
        '<button class="hitBtn" id="hitT" type="button">T</button>'+
        '<button class="hitBtn" id="hitS" type="button">S</button>'+
        '<button class="hitBtn" id="hitD" type="button">D</button>'+
        '<button class="hitBtn miss" id="hitM" type="button">M</button>'+
      '</div>'+
      '<div class="divider"></div>'+
      '<div class="hitRow">'+
        '<button class="hitBtn undo" id="undoBtn" type="button">Undo</button>'+
        '<button class="hitBtn" disabled type="button"></button>'+
        '<button class="hitBtn" disabled type="button"></button>'+
        '<button class="hitBtn next" id="nextBtn" type="button">Next</button>'+
      '</div>'+
      (match.finished ? '<div class="divider"></div><div class="pill">Finished • Saved to stats + history</div>' : '')+
    '</div>'+
    '<div class="card"><div class="pill">Round table</div><div class="divider"></div>'+
      '<div style="overflow:auto;border-radius:16px;border:1px solid rgba(255,255,255,.10)">'+
        '<table><thead>'+thead+'</thead><tbody>'+tbody+'</tbody></table>'+
      '</div>'+
    '</div>';

    appEl.innerHTML=html;

    function onHit(h){
      if(match.finished) return;
      pushSnap();
      addThrow(match,h);
      if(match.finished){ saveCompletedMatch(); }
      render();
    }
    document.getElementById("hitT").onclick=function(){ onHit("T"); };
    document.getElementById("hitS").onclick=function(){ onHit("S"); };
    document.getElementById("hitD").onclick=function(){ onHit("D"); };
    document.getElementById("hitM").onclick=function(){ onHit("M"); };

    document.getElementById("undoBtn").onclick=function(){ popSnap(); render(); };

    document.getElementById("nextBtn").onclick=function(){
      if(match.finished) return;
      while(match.dartInTurn<3){ pushSnap(); addThrow(match,"M"); }
      if(match.finished){ saveCompletedMatch(); }
      render();
    };

    document.getElementById("resetBtn").onclick=function(){
      var pls=[];
      for(var i=0;i<match.players.length;i++){ pls.push({name:match.players[i].name,email:match.players[i].email}); }
      match=newMatch(pls); match.snaps=[]; pushSnap(); render();
    };

    document.getElementById("backHome").onclick=function(){ match=null; screen="home"; render(); };
    return;
  }
}

render();
</script>
</body>
</html>
